<!DOCTYPE html>
<html lang="ko" style="background:#f5e6d3">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>음악 퀴즈 | 클라라 라디오카페</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5b7 50%, #f0dcc4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* Quiz Card */
    .quiz-card {
      background: linear-gradient(145deg, #FFF8E7, #F5ECD8);
      border: 1px solid rgba(139,105,20,0.15);
      border-radius: 20px; padding: 24px;
      width: 100%; max-width: 400px;
      text-align: center;
      box-shadow: 0 40px 80px rgba(100,70,30,0.15), 0 0 40px rgba(200,169,110,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .quiz-title {
      font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
      color: #8B6914; letter-spacing: 3px; margin-bottom: 16px;
      text-shadow: none;
    }
    .quiz-subtitle {
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #3a2a10; margin-bottom: 16px; line-height: 1.5;
    }
    .quiz-label {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: #6a5530; margin-bottom: 8px;
    }
    .hidden { display: none !important; }

    /* Link Box & Copy */
    .gift-link-box { display: flex; gap: 6px; margin-top: 12px; }
    .gift-link-box input {
      flex: 1; padding: 10px; border-radius: 8px;
      background: rgba(255,255,255,0.7); border: 2px solid rgba(139,105,20,0.2);
      color: #3a2a10; font-size: 11px; font-family: 'Inter', sans-serif; outline: none;
    }
    .gift-link-box button {
      padding: 10px 16px; border-radius: 8px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .gift-link-box button:hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .gift-copied { color: #C8A96E; font-size: 12px; margin-top: 6px; }

    /* Waiting animation */
    .waiting-text {
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #A08050; margin-top: 16px;
    }
    .waiting-dots {
      display: inline-flex; gap: 4px; margin-left: 4px;
    }
    .waiting-dots span {
      width: 6px; height: 6px; border-radius: 50%;
      background: #C8A96E; display: inline-block;
      animation: pulse-dot 1.4s infinite both;
    }
    .waiting-dots span:nth-child(2) { animation-delay: 0.2s; }
    .waiting-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse-dot {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1.2); }
    }

    /* Nickname input */
    .quiz-nickname-input {
      padding: 12px 16px; border-radius: 10px;
      border: 2px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      text-align: center; outline: none; width: 65%;
    }
    .quiz-nickname-input:focus { border-color: #C8A96E; }
    .quiz-nickname-input::placeholder { color: rgba(100,70,30,0.4); }

    /* Buttons */
    .quiz-btn {
      padding: 12px 24px; border-radius: 12px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; margin-top: 12px;
    }
    .quiz-btn:hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .quiz-btn:disabled { opacity: 0.3; cursor: default; box-shadow: none; }
    .quiz-btn-outline {
      padding: 12px 24px; border-radius: 12px;
      background: transparent; border: 1px solid #C8A96E; color: #C8A96E;
      font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; margin-top: 8px;
    }
    .quiz-btn-outline:hover { background: rgba(200,169,110,0.1); }
    .quiz-btn-row { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }

    /* Timer Bar */
    .quiz-timer {
      height: 6px; background: rgba(139,105,20,0.1);
      border-radius: 3px; margin: 12px 0; overflow: hidden;
    }
    .quiz-timer-bar {
      height: 100%; width: 100%;
      background: linear-gradient(90deg, #C8A96E, #ef4444);
      border-radius: 3px;
      transition: width 0.5s linear;
    }

    /* Scoreboard */
    .quiz-scoreboard {
      display: flex; justify-content: space-between;
      padding: 10px; margin-bottom: 12px;
      background: rgba(139,105,20,0.06); border-radius: 12px;
      border: 1px solid rgba(139,105,20,0.12);
    }
    .quiz-player { text-align: center; flex: 1; }
    .quiz-player-name { font-size: 12px; color: #A08050; }
    .quiz-player-score {
      font-family: 'Orbitron', monospace; font-size: 24px;
      color: #C8A96E; font-weight: 700;
    }
    .quiz-vs {
      font-family: 'Orbitron', monospace; font-size: 11px;
      color: rgba(139,105,20,0.4); align-self: center;
      padding: 0 8px;
    }

    /* Question */
    .quiz-question-number {
      font-family: 'Orbitron', monospace; font-size: 11px;
      color: #C8A96E; letter-spacing: 2px; margin-bottom: 8px;
    }
    .quiz-question-text {
      font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600;
      color: #3a2a10; line-height: 1.5; margin-bottom: 4px;
      min-height: 48px;
    }

    /* Options */
    .quiz-options { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
    .quiz-option {
      padding: 12px 16px; border-radius: 12px;
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(139,105,20,0.2);
      color: #3a2a10; font-family: 'Inter', sans-serif; font-size: 14px;
      cursor: pointer; transition: all 0.2s; text-align: left;
    }
    .quiz-option:hover { background: rgba(200,169,110,0.2); border-color: #C8A96E; }
    .quiz-option.correct { background: rgba(34,197,94,0.2); border-color: #22c55e; color: #166534; }
    .quiz-option.wrong { background: rgba(239,68,68,0.2); border-color: #ef4444; color: #dc2626; }
    .quiz-option.disabled { pointer-events: none; opacity: 0.5; }
    .quiz-option.selected-mine {
      border-width: 2px;
    }

    /* Result */
    .quiz-result-icon {
      font-size: 48px; margin-bottom: 12px;
    }
    .quiz-result-title {
      font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 700;
      letter-spacing: 2px; margin-bottom: 8px;
    }
    .quiz-result-detail {
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #A08050; line-height: 1.6;
    }
    .quiz-result-scores {
      display: flex; justify-content: center; gap: 32px;
      margin: 16px 0;
    }
    .quiz-result-player { text-align: center; }
    .quiz-result-player-name {
      font-size: 13px; color: #A08050; margin-bottom: 4px;
    }
    .quiz-result-player-score {
      font-family: 'Orbitron', monospace; font-size: 28px;
      color: #C8A96E; font-weight: 700;
    }
    .quiz-result-player.winner .quiz-result-player-score { color: #22c55e; }

    /* Chat Panel - fullscreen cream/gold theme */
    .chat-panel {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(145deg, #FFF8E7, #F2E8D0);
      border: none;
      z-index: 100; display: flex; flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      background: rgba(200,169,110,0.12);
      border-bottom: 1px solid rgba(200,169,110,0.25);
      flex-shrink: 0;
    }
    .chat-header-title {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #8B6914; letter-spacing: 2px;
    }
    .chat-header-info {
      font-family: 'Inter', sans-serif; font-size: 11px; color: #A08050;
    }
    .chat-back-btn {
      background: none; border: 1px solid rgba(139,105,20,0.4);
      color: #8B6914; font-size: 12px; padding: 4px 10px;
      border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    #chatBody {
      flex: 1; display: flex; flex-direction: column;
      overflow: hidden;
    }
    .chat-nickname-box { padding: 24px 16px; text-align: center; }
    .chat-nickname-box input {
      padding: 12px 16px; border-radius: 10px;
      border: 1px solid rgba(139,105,20,0.3);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      text-align: center; outline: none; width: 65%;
    }
    .chat-nickname-box input:focus { border-color: #C8A96E; }
    .chat-nickname-box button {
      margin-left: 8px; padding: 12px 20px; border-radius: 10px;
      background: #C8A96E; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 14px;
      font-weight: 700; cursor: pointer;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 12px 16px;
      display: flex; flex-direction: column;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(200,169,110,0.4); border-radius: 2px; }
    .chat-msg {
      margin-bottom: 10px; font-family: 'Inter', sans-serif; font-size: 15px;
      line-height: 1.5; word-break: break-word;
      display: flex; flex-direction: column; max-width: 78%;
    }
    .chat-msg.me { align-self: flex-end; align-items: flex-end; }
    .chat-msg.other { align-self: flex-start; align-items: flex-start; }
    .chat-msg-name {
      font-weight: 700; color: #8B6914; font-size: 13px; margin-bottom: 3px;
    }
    .chat-msg.me .chat-msg-name { color: #A08050; }
    .chat-msg-bubble {
      padding: 8px 14px; border-radius: 14px;
      line-height: 1.5; color: #3a2a10;
    }
    .chat-msg.other .chat-msg-bubble {
      background: rgba(200,169,110,0.15);
      border: 1px solid rgba(200,169,110,0.2);
      border-top-left-radius: 4px;
    }
    .chat-msg.me .chat-msg-bubble {
      background: #C8A96E; color: #fff;
      border-top-right-radius: 4px;
    }
    .chat-msg-system {
      text-align: center; color: #A08050;
      font-size: 13px; font-style: italic; margin: 6px 0;
      align-self: center;
    }
    .chat-input-box {
      display: flex; gap: 8px; padding: 10px 16px;
      border-top: 1px solid rgba(200,169,110,0.25);
    }
    .chat-input-box input {
      flex: 1; padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(139,105,20,0.25);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 13px; outline: none;
    }
    .chat-input-box input:focus { border-color: #C8A96E; }
    .chat-input-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #C8A96E; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 13px;
      font-weight: 700; cursor: pointer; white-space: nowrap;
    }
  </style>
</head>
<body>

<div class="quiz-card" id="quizCard">

  <!-- ========== HOST LOBBY ========== -->
  <div id="hostLobby">
    <div style="text-align:left;margin-bottom:12px;">
      <button onclick="history.back()" style="background:none;border:1px solid rgba(139,105,20,0.3);color:#A08050;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;padding:8px 14px;border-radius:8px;cursor:pointer;">&#9664; 이전</button>
    </div>
    <div class="quiz-title">MUSIC QUIZ</div>
    <div class="quiz-subtitle">7080 음악 퀴즈 대결<br>친구에게 링크를 보내고 대결하세요!</div>

    <div class="quiz-label">초대 링크</div>
    <div class="gift-link-box">
      <input type="text" readonly id="quizLink">
      <button onclick="copyQuizLink()">복사</button>
    </div>
    <div class="gift-copied hidden" id="quizCopied">링크가 복사되었습니다!</div>

    <div style="margin-top:20px;">
      <div class="quiz-label">닉네임</div>
      <input type="text" class="quiz-nickname-input" id="hostNicknameInput" placeholder="닉네임 입력" maxlength="12">
    </div>

    <div class="waiting-text" id="hostWaiting">
      상대방 대기 중
      <span class="waiting-dots"><span></span><span></span><span></span></span>
    </div>

    <div id="hostReadyArea" class="hidden">
      <div style="color:#22c55e;font-size:14px;margin-top:12px;">상대방이 입장했습니다!</div>
      <div style="color:#A08050;font-size:13px;margin-top:4px;" id="guestNameDisplay"></div>
      <button class="quiz-btn" id="hostStartBtn" onclick="hostStartGame()">게임 시작</button>
    </div>
  </div>

  <!-- ========== GUEST LOBBY ========== -->
  <div id="guestLobby" class="hidden">
    <div class="quiz-title">MUSIC QUIZ</div>
    <div class="quiz-subtitle">7080 음악 퀴즈 대결에 초대되었습니다!</div>

    <div style="margin-top:16px;">
      <div class="quiz-label">닉네임을 입력하고 입장하세요</div>
      <input type="text" class="quiz-nickname-input" id="guestNicknameInput" placeholder="닉네임 입력" maxlength="12" onkeydown="if(event.key==='Enter')guestJoin()">
      <br>
      <button class="quiz-btn" onclick="guestJoin()">입장하기</button>
    </div>

    <div id="guestWaiting" class="hidden">
      <div class="waiting-text" style="margin-top:16px;">
        호스트가 게임을 시작할 때까지 대기 중
        <span class="waiting-dots"><span></span><span></span><span></span></span>
      </div>
    </div>
  </div>

  <!-- ========== GAME SCREEN ========== -->
  <div id="gameScreen" class="hidden">
    <div class="quiz-scoreboard">
      <div class="quiz-player">
        <div class="quiz-player-name" id="scoreNameMe">나</div>
        <div class="quiz-player-score" id="scoreMe">0</div>
      </div>
      <div class="quiz-vs">VS</div>
      <div class="quiz-player">
        <div class="quiz-player-name" id="scoreNameOpponent">상대</div>
        <div class="quiz-player-score" id="scoreOpponent">0</div>
      </div>
    </div>

    <div class="quiz-question-number" id="questionNumber">Q1 / 10</div>
    <div class="quiz-question-text" id="questionText"></div>

    <div class="quiz-timer">
      <div class="quiz-timer-bar" id="timerBar"></div>
    </div>

    <div class="quiz-options" id="quizOptions"></div>
  </div>

  <!-- ========== RESULT SCREEN ========== -->
  <div id="resultScreen" class="hidden">
    <div class="quiz-result-icon" id="resultIcon"></div>
    <div class="quiz-result-title" id="resultTitle"></div>
    <div class="quiz-result-detail" id="resultDetail"></div>

    <div class="quiz-result-scores">
      <div class="quiz-result-player" id="resultPlayerMe">
        <div class="quiz-result-player-name" id="resultNameMe">나</div>
        <div class="quiz-result-player-score" id="resultScoreMe">0</div>
      </div>
      <div class="quiz-result-player" id="resultPlayerOpponent">
        <div class="quiz-result-player-name" id="resultNameOpponent">상대</div>
        <div class="quiz-result-player-score" id="resultScoreOpponent">0</div>
      </div>
    </div>

    <div class="quiz-btn-row">
      <button class="quiz-btn" onclick="restartGame()">다시 하기</button>
      <button class="quiz-btn-outline" onclick="openChatPanel()">채팅하기</button>
    </div>
  </div>

</div>

<!-- Chat Panel (fullscreen) -->
<div class="chat-panel" id="chatPanel" style="display:none;">
  <div class="chat-header">
    <button class="chat-back-btn" onclick="closeChatPanel()">&#9664; 이전</button>
    <span class="chat-header-title">CHAT</span>
    <span class="chat-header-info" id="chatHeaderInfo"></span>
  </div>
  <div id="chatBody">
    <div class="chat-nickname-box" id="chatNicknameBox">
      <input type="text" id="chatNicknameInput" placeholder="닉네임 입력" maxlength="12" onkeydown="if(event.key==='Enter')joinChat()">
      <button onclick="joinChat()">입장</button>
    </div>
    <div class="chat-messages hidden" id="chatMessages"></div>
    <div class="chat-input-box hidden" id="chatInputBox">
      <input type="text" id="chatMsgInput" placeholder="메시지 입력..." maxlength="200" onkeydown="if(event.key==='Enter')sendChatMsg()">
      <button onclick="sendChatMsg()">전송</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === Supabase Config ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;

  // === Quiz Data (20 hardcoded 7080 Korean song questions) ===
  var QUIZ_DATA = [
    { q: '"홀로 된다는 것" 을 부른 가수는?', options: ['변진섭','이문세','신승훈','조용필'], answer: 0 },
    { q: '"상록수" 를 부른 가수는?', options: ['이선희','양희은','심수봉','이미자'], answer: 0 },
    { q: '"잊혀진 계절" 을 부른 가수는?', options: ['이용','조용필','송골매','들국화'], answer: 0 },
    { q: '"그대 발길 머무는 곳에" 를 부른 그룹은?', options: ['전영록','봄여름가을겨울','들국화','시나위'], answer: 1 },
    { q: '"서울의 달" 을 부른 가수는?', options: ['김건모','김광석','신해철','이승환'], answer: 1 },
    { q: '"나 어떡해" 를 부른 가수는?', options: ['산울림','서태지','송골매','들국화'], answer: 2 },
    { q: '"내 마음 갈 곳을 잃어" 를 부른 가수는?', options: ['이승철','김광석','신승훈','조규찬'], answer: 0 },
    { q: '"사랑하기 때문에" 를 부른 가수는?', options: ['유재하','이문세','변진섭','이승철'], answer: 0 },
    { q: '"그건 너" 를 부른 가수는?', options: ['이정석','백지영','신효범','전인권'], answer: 0 },
    { q: '"비와 당신의 이야기" 를 부른 가수는?', options: ['부활','들국화','송골매','산울림'], answer: 0 },
    { q: '"바람이 불어오는 곳" 을 부른 가수는?', options: ['김광석','이문세','조용필','이승환'], answer: 0 },
    { q: '"어느 60대 노부부 이야기" 를 부른 가수는?', options: ['김광석','이문세','송창식','한대수'], answer: 0 },
    { q: '"광화문 연가" 를 부른 가수는?', options: ['이문세','조용필','김광석','유재하'], answer: 0 },
    { q: '"킬리만자로의 표범" 을 부른 가수는?', options: ['조용필','이문세','송골매','전인권'], answer: 0 },
    { q: '"아침이슬" 을 부른 가수는?', options: ['양희은','김민기','이선희','한대수'], answer: 0 },
    { q: '"나의 사랑 나의 신부" 를 부른 가수는?', options: ['서수남·하청일','패티김','이미자','현철'], answer: 0 },
    { q: '"돌아와요 부산항에" 를 부른 가수는?', options: ['조용필','나훈아','남진','송대관'], answer: 0 },
    { q: '"잠깐만" 을 부른 가수는?', options: ['서태지와아이들','김건모','신승훈','이현우'], answer: 0 },
    { q: '"먼지가 되어" 를 부른 가수는?', options: ['김광석','이문세','김현식','유재하'], answer: 2 },
    { q: '"내 사랑 내 곁에" 를 부른 가수는?', options: ['김현식','이문세','조용필','이승철'], answer: 0 }
  ];

  // === Game State ===
  var isHost = false;
  var quizChannel = null;
  var gameQuestions = []; // 10 selected question indices
  var currentQ = 0;
  var myScore = 0;
  var opponentScore = 0;
  var myName = '';
  var opponentName = '';
  var questionTimer = null;
  var timeLeft = 10;
  var answered = false;
  var opponentAnswered = false;
  var chatRoomId = null;

  // === Chat State ===
  var chatChannel = null;
  var chatNickname = '';
  var chatActive = false;
  var chatPeerCount = 0;

  // === Utility ===
  function generateRoomId(){
    var chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    var id = '';
    for(var i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
    return id;
  }

  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  function shuffleArray(arr){
    var a = arr.slice();
    for(var i = a.length - 1; i > 0; i--){
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
    }
    return a;
  }

  // === Init ===
  document.addEventListener('DOMContentLoaded', function(){
    initSupabase();
    var params = new URLSearchParams(window.location.search);
    var roomParam = params.get('room');

    if(roomParam){
      // GUEST mode
      isHost = false;
      chatRoomId = roomParam;
      document.getElementById('hostLobby').classList.add('hidden');
      document.getElementById('guestLobby').classList.remove('hidden');
      subscribeQuizChannel();

      /* Log receiver usage */
      try {
        var ruid = localStorage.getItem('radioUsername');
        if(ruid && supabaseClient) supabaseClient.from('feature_usage').insert({user_id:ruid, feature:'music_quiz_received'}).then(function(){});
      } catch(e){}
    } else {
      // HOST mode
      isHost = true;
      chatRoomId = generateRoomId();
      document.getElementById('hostLobby').classList.remove('hidden');
      document.getElementById('guestLobby').classList.add('hidden');
      updateQuizLink();
      subscribeQuizChannel();
    }
    // 닉네임 자동 채우기 (호스트/발신자만)
    if(isHost){
      var savedNick = localStorage.getItem('radioUsername') || '';
      if(savedNick){
        var hostInput = document.getElementById('hostNicknameInput');
        if(hostInput && !hostInput.value) hostInput.value = savedNick;
      }
    }
    var uid = localStorage.getItem('radioUsername');
    if(uid && supabaseClient) supabaseClient.from('feature_usage').insert({user_id:uid, feature:'music_quiz'}).then(function(){});
  });

  // === Link ===
  function updateQuizLink(){
    var base = location.pathname.replace(/[^\/]*$/, '') + 'music-quiz.html';
    var url = location.origin + base + '?room=' + chatRoomId;
    document.getElementById('quizLink').value = url;
  }

  function copyQuizLink(){
    var input = document.getElementById('quizLink');
    input.select();
    navigator.clipboard.writeText(input.value).then(function(){
      document.getElementById('quizCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('quizCopied').classList.add('hidden'); }, 2000);
    }).catch(function(){
      document.execCommand('copy');
      document.getElementById('quizCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('quizCopied').classList.add('hidden'); }, 2000);
    });
  }

  // === Quiz Channel ===
  function subscribeQuizChannel(){
    if(!supabaseClient || !chatRoomId) return;
    var channelName = 'quiz-' + chatRoomId;
    quizChannel = supabaseClient.channel(channelName, {
      config: { broadcast: { self: false } }
    });

    quizChannel.on('broadcast', { event: 'player_join' }, function(payload){
      var data = payload.payload;
      if(isHost){
        // Guest joined
        opponentName = data.name;
        document.getElementById('hostWaiting').classList.add('hidden');
        document.getElementById('hostReadyArea').classList.remove('hidden');
        document.getElementById('guestNameDisplay').textContent = opponentName + '님이 대기 중입니다.';
      } else {
        // Host response
        opponentName = data.name;
      }
    });

    quizChannel.on('broadcast', { event: 'game_start' }, function(payload){
      var data = payload.payload;
      gameQuestions = data.questions;
      if(!isHost){
        // Guest receives game start from host
        startGameUI();
      }
    });

    quizChannel.on('broadcast', { event: 'answer' }, function(payload){
      var data = payload.payload;
      handleOpponentAnswer(data);
    });

    quizChannel.on('broadcast', { event: 'next_question' }, function(payload){
      var data = payload.payload;
      currentQ = data.qIndex;
      showQuestion();
    });

    quizChannel.on('broadcast', { event: 'game_end' }, function(payload){
      // Both players show results
    });

    quizChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        // If host, wait. If guest with name already set, send join.
      }
    });
  }

  // === Guest Join ===
  function guestJoin(){
    var input = document.getElementById('guestNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); return; }
    myName = name;

    // Send join to host
    quizChannel.send({
      type: 'broadcast', event: 'player_join',
      payload: { name: myName, role: 'guest' }
    });

    // Show waiting
    input.disabled = true;
    document.getElementById('guestWaiting').classList.remove('hidden');
  }

  // === Host Start ===
  function hostStartGame(){
    var input = document.getElementById('hostNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); input.style.borderColor = '#ef4444'; return; }
    myName = name;

    // Send host name to guest
    quizChannel.send({
      type: 'broadcast', event: 'player_join',
      payload: { name: myName, role: 'host' }
    });

    // Select 10 random questions
    var indices = [];
    for(var i = 0; i < QUIZ_DATA.length; i++) indices.push(i);
    indices = shuffleArray(indices);
    gameQuestions = indices.slice(0, 10);

    // Broadcast game start
    setTimeout(function(){
      quizChannel.send({
        type: 'broadcast', event: 'game_start',
        payload: { questions: gameQuestions }
      });
      startGameUI();
    }, 300);
  }

  // === Game UI ===
  function startGameUI(){
    currentQ = 0;
    myScore = 0;
    opponentScore = 0;

    document.getElementById('hostLobby').classList.add('hidden');
    document.getElementById('guestLobby').classList.add('hidden');
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');

    document.getElementById('scoreNameMe').textContent = myName;
    document.getElementById('scoreNameOpponent').textContent = opponentName;
    document.getElementById('scoreMe').textContent = '0';
    document.getElementById('scoreOpponent').textContent = '0';

    showQuestion();
  }

  function showQuestion(){
    if(currentQ >= gameQuestions.length){
      endGame();
      return;
    }

    answered = false;
    opponentAnswered = false;
    var qIdx = gameQuestions[currentQ];
    var q = QUIZ_DATA[qIdx];

    document.getElementById('questionNumber').textContent = 'Q' + (currentQ + 1) + ' / ' + gameQuestions.length;
    document.getElementById('questionText').textContent = q.q;

    // Render options
    var optionsDiv = document.getElementById('quizOptions');
    optionsDiv.innerHTML = '';
    q.options.forEach(function(opt, i){
      var btn = document.createElement('button');
      btn.className = 'quiz-option';
      btn.textContent = opt;
      btn.setAttribute('data-index', i);
      btn.onclick = function(){ selectAnswer(i, btn); };
      optionsDiv.appendChild(btn);
    });

    // Start timer
    timeLeft = 10;
    var bar = document.getElementById('timerBar');
    bar.style.transition = 'none';
    bar.style.width = '100%';
    // Force reflow
    bar.offsetHeight;
    bar.style.transition = 'width 0.5s linear';

    clearInterval(questionTimer);
    questionTimer = setInterval(function(){
      timeLeft -= 0.5;
      var pct = Math.max(0, (timeLeft / 10) * 100);
      bar.style.width = pct + '%';
      if(timeLeft <= 0){
        clearInterval(questionTimer);
        timeUp();
      }
    }, 500);
  }

  function selectAnswer(index, btnEl){
    if(answered) return;
    answered = true;

    var qIdx = gameQuestions[currentQ];
    var q = QUIZ_DATA[qIdx];
    var remaining = timeLeft;

    // Mark selected
    btnEl.classList.add('selected-mine');

    // Disable all options
    var allBtns = document.querySelectorAll('.quiz-option');
    allBtns.forEach(function(b){ b.classList.add('disabled'); });

    // Calculate score
    var isCorrect = (index === q.answer);
    if(isCorrect){
      var speedBonus = Math.round((remaining / 10) * 5);
      myScore += 10 + speedBonus;
    }

    // Broadcast answer
    quizChannel.send({
      type: 'broadcast', event: 'answer',
      payload: { name: myName, qIndex: currentQ, selected: index, time: remaining }
    });

    // Update my score display
    document.getElementById('scoreMe').textContent = myScore;

    // If opponent already answered or timer ended, reveal
    if(opponentAnswered){
      revealAnswer();
    }
  }

  function handleOpponentAnswer(data){
    opponentAnswered = true;
    var qIdx = gameQuestions[data.qIndex];
    var q = QUIZ_DATA[qIdx];
    var isCorrect = (data.selected === q.answer);
    if(isCorrect){
      var speedBonus = Math.round((data.time / 10) * 5);
      opponentScore += 10 + speedBonus;
    }
    document.getElementById('scoreOpponent').textContent = opponentScore;

    // If I already answered, reveal
    if(answered){
      revealAnswer();
    }
  }

  function timeUp(){
    if(!answered){
      answered = true;
      // Disable all
      var allBtns = document.querySelectorAll('.quiz-option');
      allBtns.forEach(function(b){ b.classList.add('disabled'); });
    }
    revealAnswer();
  }

  function revealAnswer(){
    clearInterval(questionTimer);
    var qIdx = gameQuestions[currentQ];
    var q = QUIZ_DATA[qIdx];

    var allBtns = document.querySelectorAll('.quiz-option');
    allBtns.forEach(function(b){
      b.classList.add('disabled');
      var idx = parseInt(b.getAttribute('data-index'));
      if(idx === q.answer){
        b.classList.add('correct');
      } else if(b.classList.contains('selected-mine')){
        b.classList.add('wrong');
      }
    });

    // Advance to next question after delay
    setTimeout(function(){
      currentQ++;
      if(currentQ >= gameQuestions.length){
        endGame();
      } else {
        if(isHost){
          quizChannel.send({
            type: 'broadcast', event: 'next_question',
            payload: { qIndex: currentQ }
          });
        }
        showQuestion();
      }
    }, 2000);
  }

  function saveQuizGame(winner){
    try {
      initSupabase();
      if(!supabaseClient) return;
      var hostName = isHost ? myName : opponentName;
      var guestName = isHost ? opponentName : myName;
      var hostScore = isHost ? myScore : opponentScore;
      var guestScore = isHost ? opponentScore : myScore;
      supabaseClient.from('quiz_games').insert({
        room_id: chatRoomId,
        host_name: hostName,
        guest_name: guestName,
        host_score: hostScore,
        guest_score: guestScore,
        winner: winner
      }).then(function(){});
    } catch(e){}
  }

  function endGame(){
    clearInterval(questionTimer);
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');

    // Broadcast game end
    if(isHost){
      quizChannel.send({
        type: 'broadcast', event: 'game_end',
        payload: { hostScore: myScore, guestScore: opponentScore }
      });
    }

    // Determine winner
    var icon, title, titleColor, detail;
    if(myScore > opponentScore){
      icon = '&#127942;';
      title = '승리!';
      titleColor = '#22c55e';
      detail = '축하합니다! ' + myName + '님이 이겼습니다!';
    } else if(myScore < opponentScore){
      icon = '&#128546;';
      title = '패배';
      titleColor = '#ef4444';
      detail = opponentName + '님이 이겼습니다. 다음엔 꼭 이기세요!';
    } else {
      icon = '&#129309;';
      title = '무승부!';
      titleColor = '#C8A96E';
      detail = '실력이 비슷하네요! 한 판 더 해볼까요?';
    }

    document.getElementById('resultIcon').innerHTML = icon;
    document.getElementById('resultTitle').textContent = title;
    document.getElementById('resultTitle').style.color = titleColor;
    document.getElementById('resultDetail').textContent = detail;

    document.getElementById('resultNameMe').textContent = myName;
    document.getElementById('resultScoreMe').textContent = myScore;
    document.getElementById('resultNameOpponent').textContent = opponentName;
    document.getElementById('resultScoreOpponent').textContent = opponentScore;

    // Highlight winner
    var myPlayer = document.getElementById('resultPlayerMe');
    var oppPlayer = document.getElementById('resultPlayerOpponent');
    myPlayer.classList.remove('winner');
    oppPlayer.classList.remove('winner');
    if(myScore > opponentScore) myPlayer.classList.add('winner');
    else if(opponentScore > myScore) oppPlayer.classList.add('winner');

    // Save to Supabase (host only to avoid duplicate)
    if(isHost){
      var winner = myScore > opponentScore ? 'host' : (opponentScore > myScore ? 'guest' : 'draw');
      saveQuizGame(winner);
    }
  }

  function restartGame(){
    if(isHost){
      // Re-select questions and broadcast
      var indices = [];
      for(var i = 0; i < QUIZ_DATA.length; i++) indices.push(i);
      indices = shuffleArray(indices);
      gameQuestions = indices.slice(0, 10);

      quizChannel.send({
        type: 'broadcast', event: 'game_start',
        payload: { questions: gameQuestions }
      });
      startGameUI();
    } else {
      // Guest waits - show a message
      document.getElementById('resultScreen').classList.add('hidden');
      document.getElementById('guestLobby').classList.remove('hidden');
      document.getElementById('guestNicknameInput').disabled = true;
      document.getElementById('guestWaiting').classList.remove('hidden');
    }
  }

  // === Chat Functions ===
  function openChatPanel(){
    initSupabase();
    // Pre-fill chat nickname from game nickname
    if(myName && !chatNickname){
      document.getElementById('chatNicknameInput').value = myName;
    }
    var panel = document.getElementById('chatPanel');
    panel.style.display = 'flex';
    if(chatNickname){
      document.getElementById('chatNicknameBox').classList.add('hidden');
      document.getElementById('chatMessages').classList.remove('hidden');
      document.getElementById('chatInputBox').classList.remove('hidden');
      if(!chatActive) connectChat();
    }
  }

  function closeChatPanel(){
    document.getElementById('chatPanel').style.display = 'none';
  }

  function joinChat(){
    var input = document.getElementById('chatNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); return; }
    chatNickname = name;
    document.getElementById('chatNicknameBox').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInputBox').classList.remove('hidden');
    document.getElementById('chatMsgInput').focus();
    connectChat();
  }

  function connectChat(){
    if(!supabaseClient || !chatRoomId || chatActive) return;
    chatActive = true;
    var channelName = 'listen-' + chatRoomId;
    chatChannel = supabaseClient.channel(channelName, {
      config: { broadcast: { self: false } }
    });
    chatChannel.on('broadcast', { event: 'message' }, function(payload){
      addChatMessage(payload.payload.name, payload.payload.text);
    });
    chatChannel.on('broadcast', { event: 'join' }, function(payload){
      chatPeerCount++;
      addSystemMessage(payload.payload.name + '님이 입장했습니다.');
    });
    chatChannel.on('broadcast', { event: 'leave' }, function(payload){
      chatPeerCount = Math.max(0, chatPeerCount - 1);
      addSystemMessage(payload.payload.name + '님이 퇴장했습니다.');
    });
    chatChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        chatChannel.send({
          type: 'broadcast', event: 'join',
          payload: { name: chatNickname }
        });
        addSystemMessage('채팅에 연결되었습니다.');
      }
    });
  }

  function disconnectChat(){
    if(chatChannel && chatActive){
      chatChannel.send({
        type: 'broadcast', event: 'leave',
        payload: { name: chatNickname }
      });
      supabaseClient.removeChannel(chatChannel);
      chatChannel = null;
      chatActive = false;
    }
  }

  function sendChatMsg(){
    var input = document.getElementById('chatMsgInput');
    var text = input.value.trim();
    if(!text || !chatChannel || !chatActive) return;
    chatChannel.send({
      type: 'broadcast', event: 'message',
      payload: { name: chatNickname, text: text }
    });
    addChatMessage(chatNickname, text, true);
    input.value = '';
    input.focus();
  }

  function addChatMessage(name, text, isMe){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg ' + (isMe ? 'me' : 'other');
    var nameSpan = document.createElement('div');
    nameSpan.className = 'chat-msg-name';
    nameSpan.textContent = name;
    var bubble = document.createElement('div');
    bubble.className = 'chat-msg-bubble';
    bubble.textContent = text;
    div.appendChild(nameSpan);
    div.appendChild(bubble);
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function addSystemMessage(text){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg-system';
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  window.addEventListener('beforeunload', function(){
    disconnectChat();
  });
</script>
</body>
</html>
