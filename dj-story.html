<!DOCTYPE html>
<html lang="ko" style="background:#f5e6d3">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DJ ì‚¬ì—° | í´ë¼ë¼ ë¼ë””ì˜¤ì¹´í˜</title>
  <meta property="og:type" content="website" />
  <meta property="og:title" content="DJ ì‚¬ì—° | í´ë¼ë¼ ë¼ë””ì˜¤ì¹´í˜" />
  <meta property="og:description" content="DJì—ê²Œ ì‚¬ì—°ì„ ë³´ë‚´ê³  ë¼ë””ì˜¤ì—ì„œ ë“¤ì–´ë³´ì„¸ìš”!" />
  <meta property="og:image" content="https://jaiwshim-project.github.io/37-RadioCafe/digital-screen.jpg" />
  <meta property="og:url" content="https://jaiwshim-project.github.io/37-RadioCafe/dj-story.html" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f5e6d3;
      --accent: #C8A96E;
      --accent-glow: rgba(200,169,110,0.5);
      --card-bg1: #e8d5b0;
      --card-bg2: #d4c09a;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5b7 50%, #f0dcc4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    body::before {
      content: '';
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200,169,110,0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(200,169,110,0.04) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
    }
    .hidden { display: none !important; }

    /* === SENDER MODE === */
    .story-card {
      background: linear-gradient(145deg, #e8d5b0, #d4c09a);
      border: 1px solid rgba(139,105,20,0.15);
      border-radius: 20px; padding: 24px;
      width: 100%; max-width: 360px;
      text-align: center;
      box-shadow: 0 40px 80px rgba(100,70,30,0.15), 0 0 40px rgba(200,169,110,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
      position: relative; z-index: 1;
    }
    .story-title {
      font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
      color: #8B6914; letter-spacing: 3px; margin-bottom: 16px;
    }
    .story-subtitle {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: #6a5530; margin-bottom: 16px;
    }
    .story-textarea {
      width: 100%; padding: 14px; border-radius: 12px;
      border: 2px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      line-height: 1.6;
      outline: none; resize: none; min-height: 140px;
      margin-bottom: 6px;
    }
    .story-textarea:focus { border-color: #C8A96E; }
    .story-textarea::placeholder { color: rgba(100,70,30,0.4); }
    .char-counter {
      text-align: right; font-family: 'Inter', sans-serif; font-size: 12px;
      color: rgba(139,105,20,0.4); margin-bottom: 14px;
    }
    .char-counter.warn { color: #ff6b6b; }
    .step-section { display: none; }
    .step-section.active { display: block; }

    /* Voice Record Area */
    .voice-record-area {
      text-align: center; margin: 16px 0; padding: 16px;
      background: rgba(255,255,255,0.4); border-radius: 14px;
      border: 1px solid rgba(139,105,20,0.12);
    }
    .voice-record-btn {
      width: 64px; height: 64px; border-radius: 50%;
      border: 2px solid #C8A96E; background: rgba(200,169,110,0.15);
      color: #3a2a10; font-size: 28px; cursor: pointer;
      transition: all 0.3s; display: inline-flex;
      align-items: center; justify-content: center;
    }
    .voice-record-btn:hover { background: rgba(200,169,110,0.3); }
    .voice-record-btn.recording {
      background: #ff4444; border-color: #ff4444;
      animation: rec-pulse 1s ease-in-out infinite;
    }
    @keyframes rec-pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,68,68,0.4); }
      50% { transform: scale(1.08); box-shadow: 0 0 20px 6px rgba(255,68,68,0.3); }
    }
    .voice-record-time {
      display: block; margin-top: 10px;
      font-family: 'Orbitron', monospace; font-size: 18px;
      color: #3a2a10; letter-spacing: 2px;
    }
    .voice-record-status {
      display: block; margin-top: 4px;
      font-family: 'Inter', sans-serif; font-size: 12px;
      color: #6a5530;
    }
    .voice-preview {
      margin-top: 12px; display: flex; align-items: center;
      gap: 10px; justify-content: center;
    }
    .voice-preview audio { height: 36px; max-width: 200px; }
    .voice-preview-rebtn {
      padding: 6px 14px; border-radius: 10px;
      border: 1px solid rgba(139,105,20,0.2);
      background: transparent; color: #6a5530;
      font-family: 'Inter', sans-serif; font-size: 12px;
      cursor: pointer; transition: all 0.2s;
    }
    .voice-preview-rebtn:hover { border-color: #C8A96E; color: #8B6914; }
    .voice-skip-btn {
      display: block; margin: 10px auto 0; padding: 8px 20px;
      border-radius: 10px; border: 1px solid rgba(139,105,20,0.2);
      background: transparent; color: #6a5530;
      font-family: 'Inter', sans-serif; font-size: 13px;
      cursor: pointer; transition: all 0.2s;
    }
    .voice-skip-btn:hover { border-color: rgba(139,105,20,0.4); color: #8B6914; }

    /* Link / Upload */
    .story-link-box {
      display: flex; gap: 8px; margin-bottom: 8px;
    }
    .story-link-box input {
      flex: 1; padding: 10px 12px; border-radius: 10px;
      border: 2px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 11px; outline: none;
    }
    .story-link-box button {
      padding: 10px 16px; border-radius: 10px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; white-space: nowrap;
    }
    .story-link-box button:hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .story-waiting {
      color: #6a5530; font-size: 12px; margin: 10px 0;
      font-family: 'Inter', sans-serif; display: flex; align-items: center;
      justify-content: center; gap: 6px;
    }
    .waiting-dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      background: #C8A96E; animation: waitPulse 1.2s ease-in-out infinite;
    }
    @keyframes waitPulse {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    .story-copied {
      font-family: 'Inter', sans-serif; font-size: 12px;
      color: #8B6914; margin-bottom: 12px;
    }
    .story-uploading {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: #6a5530; margin: 12px 0;
    }

    /* Buttons */
    .story-btn-row {
      display: flex; gap: 8px; margin-top: 10px;
    }
    .story-btn-next {
      flex: 1; padding: 12px; border-radius: 12px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .story-btn-next:disabled { opacity: 0.3; cursor: default; }
    .story-btn-next:not(:disabled):hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .story-btn-back {
      padding: 12px 16px; border-radius: 12px;
      background: transparent; border: 1px solid rgba(139,105,20,0.2);
      color: #6a5530; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .story-btn-back:hover { border-color: rgba(139,105,20,0.4); color: #8B6914; }

    /* Guide */
    .story-guide {
      text-align: left; margin-top: 14px; padding: 12px 14px;
      background: rgba(139,105,20,0.06); border-radius: 10px;
      border-left: 3px solid #C8A96E;
    }
    .story-guide p {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: #6a5530; line-height: 1.6;
      margin: 0 0 8px 0;
    }
    .story-guide p:last-child { margin-bottom: 0; }

    /* === RECEIVER MODE === */
    .receiver-container {
      width: 100%; max-width: 400px; text-align: center;
    }

    /* ON AIR Sign */
    .on-air-sign {
      display: inline-block;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      color: #fff;
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 4px;
      padding: 8px 24px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(200,169,110,0.5), 0 0 40px rgba(200,169,110,0.3);
      animation: onAirPulse 2s ease-in-out infinite;
      margin-bottom: 24px;
    }
    @keyframes onAirPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(200,169,110,0.5); }
      50% { box-shadow: 0 0 40px rgba(200,169,110,0.8), 0 0 60px rgba(200,169,110,0.4); }
    }

    /* Radio Studio Card */
    .studio-card {
      background: linear-gradient(145deg, #e8d5b0, #d4c09a);
      border: 1px solid rgba(139,105,20,0.15);
      border-radius: 20px; padding: 28px 24px;
      width: 100%;
      text-align: center;
      box-shadow: 0 40px 80px rgba(100,70,30,0.15), 0 0 40px rgba(200,169,110,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
      position: relative;
      overflow: hidden;
    }
    .studio-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200,169,110,0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(200,169,110,0.04) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Wave Animation */
    .wave-bg {
      position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
      overflow: hidden; pointer-events: none; opacity: 0.15;
    }
    .wave-bg .wave {
      position: absolute; bottom: 0; width: 200%; height: 40px;
      background: repeating-linear-gradient(
        90deg,
        transparent, transparent 40px,
        var(--accent) 40px, var(--accent) 42px
      );
      animation: waveMove 4s linear infinite;
      opacity: 0.5;
    }
    .wave-bg .wave:nth-child(2) {
      height: 30px; animation-duration: 6s; animation-direction: reverse; opacity: 0.3;
    }
    .wave-bg .wave:nth-child(3) {
      height: 20px; animation-duration: 5s; opacity: 0.2;
    }
    @keyframes waveMove {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .studio-label {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #8B6914; letter-spacing: 3px; margin-bottom: 20px;
      position: relative;
    }

    /* Typewriter text */
    .story-display {
      text-align: left; padding: 16px;
      background: rgba(255,255,255,0.5); border-radius: 12px;
      border: 2px solid rgba(139,105,20,0.15);
      min-height: 100px; margin-bottom: 20px;
      position: relative;
    }
    .story-text {
      font-family: 'Inter', sans-serif; font-size: 15px;
      color: #3a2a10; line-height: 1.8;
      white-space: pre-wrap; word-break: break-word;
    }
    .story-cursor {
      display: inline-block; width: 2px; height: 18px;
      background: #C8A96E; margin-left: 2px;
      vertical-align: text-bottom;
      animation: cursorBlink 0.8s step-end infinite;
    }
    @keyframes cursorBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Voice Play Button */
    .voice-play-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 24px; border-radius: 14px;
      background: rgba(200,169,110,0.15);
      border: 1px solid #C8A96E;
      color: #8B6914; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.3s;
      margin-bottom: 14px;
    }
    .voice-play-btn:hover {
      background: rgba(200,169,110,0.3);
      box-shadow: 0 8px 24px rgba(200,169,110,0.4);
    }
    .voice-play-btn .play-icon { font-size: 20px; }

    /* Chat Button for Receiver */
    .chat-open-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 24px; border-radius: 14px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700;
      cursor: pointer; transition: all 0.3s;
    }
    .chat-open-btn:hover {
      box-shadow: 0 8px 24px rgba(200,169,110,0.4);
    }

    .receiver-actions {
      display: flex; flex-direction: column; align-items: center;
      gap: 10px; position: relative;
    }

    /* Loading */
    .loading-text {
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #6a5530; padding: 40px 0;
    }

    /* Chat Panel - cream/gold theme */
    .chat-panel {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(145deg, #FFF8E7, #F2E8D0);
      border: none;
      z-index: 100; display: flex; flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      background: rgba(200,169,110,0.12);
      border-bottom: 1px solid rgba(200,169,110,0.25);
      flex-shrink: 0;
    }
    .chat-header-title {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #8B6914; letter-spacing: 2px;
    }
    .chat-header-info {
      font-family: 'Inter', sans-serif; font-size: 11px; color: #6a5530;
    }
    .chat-back-btn {
      background: none; border: 1px solid rgba(139,105,20,0.4);
      color: #8B6914; font-size: 12px; padding: 4px 10px;
      border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    #chatBody {
      flex: 1; display: flex; flex-direction: column;
      overflow: hidden;
    }
    .chat-nickname-box { padding: 24px 16px; text-align: center; }
    .chat-nickname-box input {
      padding: 12px 16px; border-radius: 10px;
      border: 1px solid rgba(139,105,20,0.3);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      text-align: center; outline: none; width: 65%;
    }
    .chat-nickname-box input:focus { border-color: #C8A96E; }
    .chat-nickname-box button {
      margin-left: 8px; padding: 12px 20px; border-radius: 10px;
      background: #C8A96E; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 14px;
      font-weight: 700; cursor: pointer;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 12px 16px;
      display: flex; flex-direction: column;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(200,169,110,0.4); border-radius: 2px; }
    .chat-msg {
      margin-bottom: 10px; font-family: 'Inter', sans-serif; font-size: 15px;
      line-height: 1.5; word-break: break-word;
      display: flex; flex-direction: column; max-width: 78%;
    }
    .chat-msg.me { align-self: flex-end; align-items: flex-end; }
    .chat-msg.other { align-self: flex-start; align-items: flex-start; }
    .chat-msg-name {
      font-weight: 700; color: #8B6914; font-size: 13px; margin-bottom: 3px;
    }
    .chat-msg.me .chat-msg-name { color: #6a5530; }
    .chat-msg-bubble {
      padding: 8px 14px; border-radius: 14px;
      line-height: 1.5; color: #3a2a10;
    }
    .chat-msg.other .chat-msg-bubble {
      background: rgba(200,169,110,0.15);
      border: 1px solid rgba(200,169,110,0.2);
      border-top-left-radius: 4px;
    }
    .chat-msg.me .chat-msg-bubble {
      background: #C8A96E; color: #fff;
      border-top-right-radius: 4px;
    }
    .chat-msg-system {
      text-align: center; color: #6a5530;
      font-size: 13px; font-style: italic; margin: 6px 0;
      align-self: center;
    }
    .chat-input-box {
      display: flex; gap: 8px; padding: 10px 16px;
      border-top: 1px solid rgba(200,169,110,0.25);
    }
    .chat-input-box input {
      flex: 1; padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(139,105,20,0.25);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 13px; outline: none;
    }
    .chat-input-box input:focus { border-color: #C8A96E; }
    .chat-input-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #C8A96E; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 13px;
      font-weight: 700; cursor: pointer; white-space: nowrap;
    }
  </style>
</head>
<body>

<!-- ============ SENDER MODE ============ -->
<div class="story-card" id="senderView" style="display:none;">
  <div class="story-title">DJ ì‚¬ì—° ë³´ë‚´ê¸°</div>

  <!-- Step 1: Write Story -->
  <div class="step-section active" id="senderStep1">
    <div class="story-subtitle">DJì—ê²Œ ì „í•  ì‚¬ì—°ì„ ì‘ì„±í•˜ì„¸ìš”</div>
    <textarea class="story-textarea" id="storyInput" placeholder="ì‚¬ì—°ì„ ì…ë ¥í•˜ì„¸ìš”... (ìµœëŒ€ 500ì)" maxlength="500" oninput="updateCharCounter()"></textarea>
    <div class="char-counter" id="charCounter">0 / 500</div>
    <div class="story-guide">
      <p>1. ì‚¬ì—°ì„ ì‘ì„±í•©ë‹ˆë‹¤. (ìµœëŒ€ 500ì)</p>
      <p>2. 'ë‹¤ìŒ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìŒì„± ë…¹ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
      <p>3. ìŒì„± ë…¹ìŒì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤.</p>
    </div>
    <div class="story-btn-row">
      <button class="story-btn-back" onclick="history.back()">ì´ì „</button>
      <button class="story-btn-next" id="step1NextBtn" disabled onclick="goStep2()">ë‹¤ìŒ</button>
    </div>
  </div>

  <!-- Step 2: Optional Voice Recording -->
  <div class="step-section" id="senderStep2">
    <div class="story-subtitle">ìŒì„± ì‚¬ì—° ë…¹ìŒ (ì„ íƒì‚¬í•­)</div>
    <div class="voice-record-area">
      <button class="voice-record-btn" id="voiceRecBtn" onclick="toggleVoiceRecord()">ğŸ™</button>
      <span class="voice-record-time" id="voiceTime">00:00</span>
      <span class="voice-record-status" id="voiceStatus">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•˜ì„¸ìš” (ìµœëŒ€ 30ì´ˆ)</span>
    </div>
    <div class="voice-preview" id="voicePreview" style="display:none;">
      <audio id="voiceAudio" controls></audio>
      <button class="voice-preview-rebtn" onclick="resetVoiceRecord()">ë‹¤ì‹œ ë…¹ìŒ</button>
    </div>
    <button class="voice-skip-btn" onclick="goStep3(false)">ìŒì„± ë…¹ìŒ ê±´ë„ˆë›°ê¸°</button>
    <div class="story-btn-row">
      <button class="story-btn-back" onclick="backToStep1()">ì´ì „</button>
      <button class="story-btn-next" id="step2NextBtn" disabled onclick="goStep3(true)">ë‹¤ìŒ (ìŒì„± í¬í•¨)</button>
    </div>
  </div>

  <!-- Step 3: Upload & Share -->
  <div class="step-section" id="senderStep3">
    <div class="story-subtitle" id="step3Status">ì‚¬ì—° ì—…ë¡œë“œ ì¤‘...</div>
    <div class="story-uploading" id="uploadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</div>
    <div class="story-uploading" id="uploadResult" style="display:none;"></div>
    <div class="story-link-box" id="storyLinkBox" style="display:none;">
      <input type="text" readonly id="storyLink">
      <button onclick="copyStoryLink()">ë³µì‚¬</button>
    </div>
    <div class="story-copied hidden" id="storyCopied">ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    <div class="story-waiting hidden" id="storyWaiting">
      <span class="waiting-dot"></span> ìƒëŒ€ë°©ì´ ë§í¬ë¥¼ ì—´ë©´ ì±„íŒ…ì´ ì‹œì‘ë©ë‹ˆë‹¤...
    </div>
    <div id="retryRow" style="display:none;">
      <div class="story-btn-row">
        <button class="story-btn-next" onclick="doUpload()">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
      </div>
    </div>
    <div class="story-guide" id="step3Guide" style="display:none;">
      <p>1. ë³µì‚¬ ë²„íŠ¼ì„ ì„ íƒí•˜ê³  ì„ ë¬¼í•˜ê³  ì‹¶ì€ ì‚¬ëŒì˜ ì¹´í†¡ ì°½ì´ë‚˜ ë¬¸ì ë©”ì‹œì§€ ì°½ìœ¼ë¡œ ê°€ì„œ ë¶™ì—¬ë„£ê¸°ë¥¼ í•©ë‹ˆë‹¤.</p>
      <p>2. ìƒëŒ€ë°©ì´ ë§í¬ë¥¼ ì—´ë©´ ìë™ìœ¼ë¡œ ì±„íŒ…ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.</p>
    </div>
    <div class="story-btn-row">
      <button class="story-btn-back" onclick="backToStep2()">ì´ì „</button>
    </div>
  </div>
</div>

<!-- ============ RECEIVER MODE ============ -->
<div class="receiver-container" id="receiverView" style="display:none;">
  <div class="on-air-sign">ON AIR</div>
  <div class="studio-card">
    <div class="wave-bg">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
    <div class="studio-label">DJ STORY</div>
    <div id="receiverLoading" class="loading-text">ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="receiverContent" style="display:none;">
      <div class="story-display">
        <span class="story-text" id="typewriterText"></span><span class="story-cursor" id="typewriterCursor"></span>
      </div>
      <div class="receiver-actions">
        <button class="voice-play-btn" id="voicePlayBtn" style="display:none;" onclick="playVoiceStory()">
          <span class="play-icon">&#9654;</span> ìŒì„± ì‚¬ì—° ë“£ê¸°
        </button>
        <audio id="receiverVoiceAudio" style="display:none;"></audio>
        <button class="chat-open-btn" onclick="openChatPanel()">&#128172; ì±„íŒ…í•˜ê¸°</button>
      </div>
    </div>
    <div id="receiverError" style="display:none;">
      <div class="loading-text">ì‚¬ì—°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

<!-- ============ CHAT PANEL ============ -->
<div class="chat-panel" id="chatPanel" style="display:none;">
  <div class="chat-header">
    <button class="chat-back-btn" onclick="closeChatPanel()">&#9664; ì´ì „</button>
    <span class="chat-header-title">CHAT</span>
    <span class="chat-header-info" id="chatHeaderInfo"></span>
  </div>
  <div id="chatBody">
    <div class="chat-nickname-box" id="chatNicknameBox">
      <input type="text" id="chatNicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="12" onkeydown="if(event.key==='Enter')joinChat()">
      <button onclick="joinChat()">ì…ì¥</button>
    </div>
    <div class="chat-messages hidden" id="chatMessages"></div>
    <div class="chat-input-box hidden" id="chatInputBox">
      <input type="text" id="chatMsgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200" onkeydown="if(event.key==='Enter')sendChatMsg()">
      <button onclick="sendChatMsg()">ì „ì†¡</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === Supabase Config ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;

  // === Chat State ===
  var chatChannel = null;
  var chatRoomId = null;
  var chatNickname = '';
  var chatActive = false;
  var chatPeerCount = 0;
  var chatAutoHidden = false;

  // === Mode ===
  var isReceiver = false;
  var storyText = '';
  var hasVoice = false;

  // === Voice Record State ===
  var voiceMediaRecorder = null;
  var voiceChunks = [];
  var voiceBlob = null;
  var voiceRecording = false;
  var voiceRecordTimer = null;
  var voiceRecordSec = 0;
  var voiceUploaded = false;
  var voiceMimeType = 'audio/webm';
  var voiceExtension = '.webm';

  function generateRoomId(){
    var chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    var id = '';
    for(var i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
    return id;
  }

  // === Supabase Init ===
  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  // === Init ===
  document.addEventListener('DOMContentLoaded', function(){
    var params = new URLSearchParams(window.location.search);
    var roomParam = params.get('room');

    if(roomParam){
      // RECEIVER MODE
      isReceiver = true;
      chatRoomId = roomParam;
      document.getElementById('receiverView').style.display = '';
      loadStory(roomParam);

      /* Log receiver usage */
      try {
        var ruid = localStorage.getItem('radioUsername');
        if(ruid){ initSupabase(); if(supabaseClient) supabaseClient.from('feature_usage').insert({user_id:ruid, feature:'dj_story_received'}).then(function(){}); }
      } catch(e){}
    } else {
      // SENDER MODE
      isReceiver = false;
      chatRoomId = generateRoomId();
      document.getElementById('senderView').style.display = '';
    }
    var uid = localStorage.getItem('radioUsername');
    if(uid){ initSupabase(); if(supabaseClient) supabaseClient.from('feature_usage').insert({user_id:uid, feature:'dj_story'}).then(function(){}); }
    // ë‹‰ë„¤ì„ ìë™ ì±„ìš°ê¸° (ë°œì‹ ìë§Œ)
    if(!new URLSearchParams(location.search).get('room')){
      var savedNick = localStorage.getItem('radioUsername') || '';
      if(savedNick){ var ci = document.getElementById('chatNicknameInput'); if(ci && !ci.value) ci.value = savedNick; }
    }
  });

  // =============================================
  //  SENDER MODE FUNCTIONS
  // =============================================

  function updateCharCounter(){
    var input = document.getElementById('storyInput');
    var counter = document.getElementById('charCounter');
    var len = input.value.length;
    counter.textContent = len + ' / 500';
    if(len >= 450){
      counter.classList.add('warn');
    } else {
      counter.classList.remove('warn');
    }
    document.getElementById('step1NextBtn').disabled = (len === 0);
  }

  function goStep2(){
    var text = document.getElementById('storyInput').value.trim();
    if(!text) return;
    storyText = text;
    document.getElementById('senderStep1').classList.remove('active');
    document.getElementById('senderStep2').classList.add('active');
  }

  function backToStep1(){
    if(voiceRecording) stopVoiceRecord();
    document.getElementById('senderStep2').classList.remove('active');
    document.getElementById('senderStep1').classList.add('active');
  }

  function goStep3(withVoice){
    hasVoice = withVoice && voiceBlob !== null;
    document.getElementById('senderStep2').classList.remove('active');
    document.getElementById('senderStep3').classList.add('active');
    doUpload();
  }

  function backToStep2(){
    document.getElementById('senderStep3').classList.remove('active');
    document.getElementById('senderStep2').classList.add('active');
  }

  function doUpload(){
    initSupabase();
    document.getElementById('step3Status').textContent = 'ì‚¬ì—° ì—…ë¡œë“œ ì¤‘...';
    document.getElementById('uploadingMsg').style.display = '';
    document.getElementById('uploadResult').style.display = 'none';
    document.getElementById('storyLinkBox').style.display = 'none';
    document.getElementById('retryRow').style.display = 'none';
    document.getElementById('step3Guide').style.display = 'none';

    if(hasVoice && voiceBlob){
      // Upload voice first, then story JSON
      uploadVoiceToSupabase(function(voiceOk){
        if(voiceOk){
          uploadStoryJSON();
        } else {
          showUploadError('ìŒì„± íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
      });
    } else {
      uploadStoryJSON();
    }
  }

  function uploadStoryJSON(){
    if(!supabaseClient){
      showUploadError('Supabase ì—°ê²° ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      return;
    }
    var storyData = JSON.stringify({
      msg: storyText,
      voice: hasVoice ? chatRoomId : '',
      vext: hasVoice ? voiceExtension : ''
    });
    var storyBlobData = new Blob([storyData], { type: 'application/json' });
    var filePath = 'dj-stories/' + chatRoomId + '.json';

    supabaseClient.storage.from('photo-albums').upload(filePath, storyBlobData, {
      contentType: 'application/json',
      upsert: true
    }).then(function(result){
      if(result.error){
        console.log('ì‚¬ì—° ì—…ë¡œë“œ ì˜¤ë¥˜:', result.error);
        showUploadError('ì‚¬ì—° ì—…ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      } else {
        showUploadSuccess();
      }
    }).catch(function(err){
      console.log('ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
      showUploadError('ì‚¬ì—° ì—…ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    });
  }

  function showUploadError(msg){
    document.getElementById('uploadingMsg').style.display = 'none';
    var result = document.getElementById('uploadResult');
    result.style.display = '';
    result.style.color = '#ff4444';
    result.textContent = msg;
    document.getElementById('retryRow').style.display = '';
    document.getElementById('step3Status').textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
  }

  function showUploadSuccess(){
    document.getElementById('uploadingMsg').style.display = 'none';
    var result = document.getElementById('uploadResult');
    result.style.display = '';
    result.style.color = '#76ff03';
    result.textContent = 'ì‚¬ì—° ì—…ë¡œë“œ ì™„ë£Œ!';
    document.getElementById('step3Status').textContent = 'ì‚¬ì—°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤';

    // Generate link
    var base = location.pathname.replace(/[^\/]*$/, '') + 'dj-story.html';
    var url = location.origin + base + '?room=' + chatRoomId;
    document.getElementById('storyLink').value = url;
    document.getElementById('storyLinkBox').style.display = 'flex';
    document.getElementById('step3Guide').style.display = '';
  }

  function copyStoryLink(){
    var input = document.getElementById('storyLink');
    input.select();
    navigator.clipboard.writeText(input.value).then(function(){
      document.getElementById('storyCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('storyCopied').classList.add('hidden'); }, 2000);
      waitForReceiver();
    }).catch(function(){
      document.execCommand('copy');
      document.getElementById('storyCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('storyCopied').classList.add('hidden'); }, 2000);
      waitForReceiver();
    });
  }

  var viewerChannel = null;
  function waitForReceiver(){
    var waitEl = document.getElementById('storyWaiting');
    if(waitEl) waitEl.classList.remove('hidden');
    initSupabase();
    if(!supabaseClient) return;
    if(viewerChannel) return;
    viewerChannel = supabaseClient.channel('story-' + chatRoomId, {
      config: { broadcast: { self: false } }
    });
    viewerChannel.on('broadcast', { event: 'viewer_opened' }, function(){
      var waitEl2 = document.getElementById('storyWaiting');
      if(waitEl2) waitEl2.classList.add('hidden');
      openChatPanel();
    });
    viewerChannel.subscribe();
  }

  // === Voice Recording ===
  function toggleVoiceRecord(){
    if(voiceRecording){
      stopVoiceRecord();
    } else {
      startVoiceRecord();
    }
  }

  function startVoiceRecord(){
    voiceChunks = [];
    voiceBlob = null;
    voiceUploaded = false;
    document.getElementById('step2NextBtn').disabled = true;
    document.getElementById('voicePreview').style.display = 'none';

    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream){
      var mimeType = '';
      if(MediaRecorder.isTypeSupported('audio/mp4')){
        mimeType = 'audio/mp4'; voiceMimeType = 'audio/mp4'; voiceExtension = '.mp4';
      } else if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')){
        mimeType = 'audio/webm;codecs=opus'; voiceMimeType = 'audio/webm'; voiceExtension = '.webm';
      } else if(MediaRecorder.isTypeSupported('audio/webm')){
        mimeType = 'audio/webm'; voiceMimeType = 'audio/webm'; voiceExtension = '.webm';
      }
      var options = mimeType ? { mimeType: mimeType } : {};
      voiceMediaRecorder = new MediaRecorder(stream, options);
      voiceMediaRecorder.ondataavailable = function(e){ if(e.data.size > 0) voiceChunks.push(e.data); };
      voiceMediaRecorder.onstop = function(){
        voiceBlob = new Blob(voiceChunks, { type: voiceMimeType });
        stream.getTracks().forEach(function(t){ t.stop(); });
        showVoicePreview();
      };
      voiceMediaRecorder.start();
      voiceRecording = true;
      voiceRecordSec = 0;
      updateVoiceTimer();
      voiceRecordTimer = setInterval(function(){
        voiceRecordSec++;
        updateVoiceTimer();
        if(voiceRecordSec >= 30) stopVoiceRecord();
      }, 1000);
      document.getElementById('voiceRecBtn').textContent = '\u23F9';
      document.getElementById('voiceRecBtn').classList.add('recording');
      document.getElementById('voiceStatus').textContent = 'ë…¹ìŒ ì¤‘...';
    }).catch(function(err){
      document.getElementById('voiceStatus').textContent = 'ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
      console.log('ë§ˆì´í¬ ì˜¤ë¥˜:', err);
    });
  }

  function stopVoiceRecord(){
    if(voiceMediaRecorder && voiceMediaRecorder.state === 'recording'){
      voiceMediaRecorder.stop();
    }
    voiceRecording = false;
    if(voiceRecordTimer){ clearInterval(voiceRecordTimer); voiceRecordTimer = null; }
    document.getElementById('voiceRecBtn').textContent = 'ğŸ™';
    document.getElementById('voiceRecBtn').classList.remove('recording');
    document.getElementById('voiceStatus').textContent = 'ë…¹ìŒ ì™„ë£Œ';
  }

  function updateVoiceTimer(){
    var m = Math.floor(voiceRecordSec / 60);
    var s = voiceRecordSec % 60;
    document.getElementById('voiceTime').textContent = (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
  }

  function showVoicePreview(){
    var preview = document.getElementById('voicePreview');
    preview.style.display = 'flex';
    var audio = document.getElementById('voiceAudio');
    audio.src = URL.createObjectURL(voiceBlob);
    document.getElementById('step2NextBtn').disabled = false;
  }

  function resetVoiceRecord(){
    voiceBlob = null;
    voiceUploaded = false;
    voiceRecordSec = 0;
    document.getElementById('voicePreview').style.display = 'none';
    document.getElementById('voiceTime').textContent = '00:00';
    document.getElementById('voiceStatus').textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•˜ì„¸ìš” (ìµœëŒ€ 30ì´ˆ)';
    document.getElementById('step2NextBtn').disabled = true;
  }

  function uploadVoiceToSupabase(callback){
    initSupabase();
    if(!supabaseClient || !voiceBlob){ if(callback) callback(false); return; }
    var filePath = 'dj-voices/' + chatRoomId + voiceExtension;
    supabaseClient.storage.from('photo-albums').upload(filePath, voiceBlob, {
      contentType: voiceMimeType, upsert: true
    }).then(function(result){
      if(result.error){
        console.log('ìŒì„± ì—…ë¡œë“œ ì˜¤ë¥˜:', result.error);
        if(callback) callback(false);
      } else {
        voiceUploaded = true;
        if(callback) callback(true);
      }
    }).catch(function(err){
      console.log('ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
      if(callback) callback(false);
    });
  }

  // =============================================
  //  RECEIVER MODE FUNCTIONS
  // =============================================

  function loadStory(roomId){
    var url = SUPABASE_URL + '/storage/v1/object/public/photo-albums/dj-stories/' + roomId + '.json';
    fetch(url).then(function(r){
      if(!r.ok) throw new Error('Not found');
      return r.json();
    }).then(function(data){
      document.getElementById('receiverLoading').style.display = 'none';
      document.getElementById('receiverContent').style.display = '';

      // Start typewriter effect
      startTypewriter(data.msg || '');

      // Check for voice
      if(data.voice){
        var vext = data.vext || '.webm';
        var voiceUrl = SUPABASE_URL + '/storage/v1/object/public/photo-albums/dj-voices/' + data.voice + vext;
        document.getElementById('receiverVoiceAudio').src = voiceUrl;
        document.getElementById('voicePlayBtn').style.display = 'inline-flex';
      }

      // ë³´ë‚¸ ì‚¬ëŒì—ê²Œ ì•Œë¦¬ê³  ì–‘ìª½ ì±„íŒ… ì˜¤í”ˆ
      notifySenderAndOpenChat();
    }).catch(function(err){
      console.log('ì‚¬ì—° ë¡œë“œ ì‹¤íŒ¨:', err);
      document.getElementById('receiverLoading').style.display = 'none';
      document.getElementById('receiverError').style.display = '';
    });
  }

  function notifySenderAndOpenChat(){
    initSupabase();
    if(!supabaseClient){
      setTimeout(notifySenderAndOpenChat, 500);
      return;
    }
    var notifyChannel = supabaseClient.channel('story-' + chatRoomId, {
      config: { broadcast: { self: false } }
    });
    notifyChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        notifyChannel.send({ type: 'broadcast', event: 'viewer_opened', payload: {} });
        openChatPanel();
      }
    });
  }

  var typewriterInterval = null;
  var typewriterIndex = 0;
  var typewriterFullText = '';

  function startTypewriter(text){
    typewriterFullText = text;
    typewriterIndex = 0;
    var el = document.getElementById('typewriterText');
    el.textContent = '';
    document.getElementById('typewriterCursor').style.display = 'inline-block';

    typewriterInterval = setInterval(function(){
      if(typewriterIndex < typewriterFullText.length){
        el.textContent += typewriterFullText.charAt(typewriterIndex);
        typewriterIndex++;
        // Scroll story display if needed
        var display = el.parentElement;
        display.scrollTop = display.scrollHeight;
      } else {
        clearInterval(typewriterInterval);
        typewriterInterval = null;
        // Keep cursor blinking for a bit then hide
        setTimeout(function(){
          document.getElementById('typewriterCursor').style.display = 'none';
        }, 3000);
      }
    }, 50);
  }

  function playVoiceStory(){
    var audio = document.getElementById('receiverVoiceAudio');
    var btn = document.getElementById('voicePlayBtn');
    if(audio.paused){
      audio.play().catch(function(){ alert('ìŒì„±ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); });
      btn.innerHTML = '<span class="play-icon">&#9646;&#9646;</span> ìŒì„± ì¬ìƒ ì¤‘...';
      audio.onended = function(){
        btn.innerHTML = '<span class="play-icon">&#9654;</span> ìŒì„± ì‚¬ì—° ë“£ê¸°';
      };
      audio.onpause = function(){
        if(audio.ended) return;
        btn.innerHTML = '<span class="play-icon">&#9654;</span> ìŒì„± ì‚¬ì—° ë“£ê¸°';
      };
    } else {
      audio.pause();
      btn.innerHTML = '<span class="play-icon">&#9654;</span> ìŒì„± ì‚¬ì—° ë“£ê¸°';
    }
  }

  // =============================================
  //  CHAT FUNCTIONS (exact same pattern)
  // =============================================

  function openChatPanel(){
    initSupabase();
    var panel = document.getElementById('chatPanel');
    panel.style.display = 'flex';
    if(chatNickname){
      document.getElementById('chatNicknameBox').classList.add('hidden');
      document.getElementById('chatMessages').classList.remove('hidden');
      document.getElementById('chatInputBox').classList.remove('hidden');
      if(!chatActive) connectChat();
    }
  }

  function closeChatPanel(){
    document.getElementById('chatPanel').style.display = 'none';
  }

  function joinChat(){
    var input = document.getElementById('chatNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); return; }
    chatNickname = name;
    document.getElementById('chatNicknameBox').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInputBox').classList.remove('hidden');
    document.getElementById('chatMsgInput').focus();
    connectChat();
  }

  function connectChat(){
    if(!supabaseClient || !chatRoomId || chatActive) return;
    chatActive = true;
    var channelName = 'listen-' + chatRoomId;
    chatChannel = supabaseClient.channel(channelName, {
      config: { broadcast: { self: false } }
    });
    chatChannel.on('broadcast', { event: 'message' }, function(payload){
      addChatMessage(payload.payload.name, payload.payload.text);
    });
    chatChannel.on('broadcast', { event: 'join' }, function(payload){
      chatPeerCount++;
      addSystemMessage(payload.payload.name + 'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.');
    });
    chatChannel.on('broadcast', { event: 'leave' }, function(payload){
      chatPeerCount = Math.max(0, chatPeerCount - 1);
      addSystemMessage(payload.payload.name + 'ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.');
    });
    chatChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        chatChannel.send({
          type: 'broadcast', event: 'join',
          payload: { name: chatNickname }
        });
        addSystemMessage('ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  function disconnectChat(){
    if(chatChannel && chatActive){
      chatChannel.send({
        type: 'broadcast', event: 'leave',
        payload: { name: chatNickname }
      });
      supabaseClient.removeChannel(chatChannel);
      chatChannel = null;
      chatActive = false;
    }
  }

  function sendChatMsg(){
    var input = document.getElementById('chatMsgInput');
    var text = input.value.trim();
    if(!text || !chatChannel || !chatActive) return;
    chatChannel.send({
      type: 'broadcast', event: 'message',
      payload: { name: chatNickname, text: text }
    });
    addChatMessage(chatNickname, text, true);
    input.value = '';
    input.focus();
  }

  function addChatMessage(name, text, isMe){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg ' + (isMe ? 'me' : 'other');
    var nameSpan = document.createElement('div');
    nameSpan.className = 'chat-msg-name';
    nameSpan.textContent = name;
    var bubble = document.createElement('div');
    bubble.className = 'chat-msg-bubble';
    bubble.textContent = text;
    div.appendChild(nameSpan);
    div.appendChild(bubble);
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function addSystemMessage(text){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg-system';
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  window.addEventListener('beforeunload', function(){
    disconnectChat();
  });
</script>
</body>
</html>
