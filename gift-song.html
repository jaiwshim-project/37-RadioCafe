<!DOCTYPE html>
<html lang="ko" style="background:#1a1a2e">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>노래 선물하기 | 클라라 라디오카페</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #1a1a2e;
      --body-out1: #3a2a1a; --body-out2: #2a1c0e;
      --body-in1: #2c1e10; --body-in2: #1e140a;
      --accent: #d4a862;
      --accent-glow: rgba(212,168,98,0.5);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* Gift Song Card */
    .gift-card {
      background: linear-gradient(145deg, var(--body-out1), var(--body-out2));
      border: 1px solid #ff6b9d;
      border-radius: 20px; padding: 24px;
      width: 100%; max-width: 360px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255,107,157,0.3), 0 20px 60px rgba(0,0,0,0.5);
    }
    .gift-title {
      font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
      color: #ff6b9d; letter-spacing: 3px; margin-bottom: 16px;
      text-shadow: 0 0 10px rgba(255,107,157,0.5);
    }
    .gift-categories {
      display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 14px;
    }
    .gift-cat-btn {
      padding: 6px 14px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.6);
      font-family: 'Inter', sans-serif; font-size: 12px;
      cursor: pointer; transition: all 0.2s;
    }
    .gift-cat-btn.active {
      border-color: #ff6b9d; color: #ff6b9d;
      background: rgba(255,107,157,0.1);
    }
    .gift-song-list {
      max-height: 160px; overflow-y: auto; margin-bottom: 14px;
    }
    .gift-song-list::-webkit-scrollbar { width: 4px; }
    .gift-song-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
    .gift-song-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; margin-bottom: 4px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.15); cursor: pointer;
      transition: all 0.2s;
    }
    .gift-song-item:hover { border-color: rgba(255,107,157,0.3); }
    .gift-song-item.selected {
      border-color: #ff6b9d; background: rgba(255,107,157,0.1);
    }
    .gift-song-name {
      font-family: 'Inter', sans-serif; font-size: 14px; color: rgba(255,255,255,0.85);
    }
    .gift-song-item.selected .gift-song-name { color: #ff6b9d; font-weight: 600; }
    .gift-step2 { display: none; }
    .gift-step2.active { display: block; }
    .gift-selected-info {
      font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 600;
      color: #ff6b9d; margin-bottom: 12px;
    }
    .gift-msg-input {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 14px;
      outline: none; resize: none; min-height: 60px;
      margin-bottom: 12px;
    }
    .gift-msg-input:focus { border-color: #ff6b9d; }
    .gift-msg-input::placeholder { color: rgba(255,255,255,0.3); }
    .gift-link-box {
      display: flex; gap: 8px; margin-bottom: 8px;
    }
    .gift-link-box input {
      flex: 1; padding: 10px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 11px; outline: none;
    }
    .gift-link-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #ff6b9d; border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; white-space: nowrap;
    }
    .gift-link-box button:hover { box-shadow: 0 0 12px rgba(255,107,157,0.5); }
    .gift-copied {
      font-family: 'Inter', sans-serif; font-size: 12px;
      color: #ff6b9d; margin-bottom: 12px;
    }
    .gift-copied.hidden { display: none; }
    .gift-share-btn {
      width: 100%; padding: 12px;
      background: transparent; border: 1px solid #ff6b9d;
      border-radius: 12px; color: #ff6b9d;
      font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
    }
    .gift-share-btn:hover { background: #ff6b9d; color: #fff; }
    .gift-share-btn.hidden { display: none; }
    .gift-guide {
      text-align: left; margin-top: 14px; padding: 12px 14px;
      background: rgba(255,255,255,0.06); border-radius: 10px;
      border-left: 3px solid #ff6b9d;
    }
    .gift-guide p {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: rgba(255,255,255,0.7); line-height: 1.6;
      margin: 0 0 8px 0;
    }
    .gift-guide p:last-child { margin-bottom: 0; }
    .gift-btn-row {
      display: flex; gap: 8px; margin-top: 10px;
    }
    .gift-btn-next {
      flex: 1; padding: 12px; border-radius: 12px;
      background: #ff6b9d; border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .gift-btn-next:disabled { opacity: 0.3; cursor: default; }
    .gift-btn-next:not(:disabled):hover { box-shadow: 0 0 16px rgba(255,107,157,0.5); }
    .gift-btn-back {
      padding: 12px 16px; border-radius: 12px;
      background: transparent; border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.6); font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .gift-btn-back:hover { border-color: rgba(255,255,255,0.5); color: #fff; }
    .gift-close {
      width: 100%; padding: 10px; margin-top: 4px;
      background: transparent; border: none;
      color: rgba(255,255,255,0.5); font-family: 'Inter', sans-serif;
      font-size: 13px; cursor: pointer; transition: color 0.2s;
    }
    .gift-close:hover { color: #fff; }

    /* Chat Panel */
    .chat-panel {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 420px; max-height: 50vh;
      background: linear-gradient(145deg, var(--body-out1), var(--body-out2));
      border: 2px solid #ff6b9d;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      z-index: 10001;
      display: flex; flex-direction: column;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.5), 0 0 15px rgba(255,107,157,0.3);
      transition: transform 0.3s ease;
    }
    .chat-panel.hidden { display: none; }
    .chat-panel.minimized { max-height: 42px; overflow: hidden; }
    .chat-header {
      display: flex; align-items: center; padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06); cursor: pointer;
      flex-shrink: 0;
    }
    .chat-header-title {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #ff6b9d; letter-spacing: 2px;
    }
    .chat-header-info {
      flex: 1; text-align: center;
      font-family: 'Inter', sans-serif; font-size: 11px;
      color: rgba(255,255,255,0.5);
    }
    .chat-header-btn {
      background: none; border: none; color: rgba(255,255,255,0.4);
      cursor: pointer; font-size: 12px; padding: 4px 8px;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 12px 16px;
      min-height: 120px; max-height: 300px;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    .chat-msg { margin-bottom: 10px; }
    .chat-msg-name {
      font-family: 'Inter', sans-serif; font-size: 11px;
      color: rgba(255,255,255,0.4); margin-bottom: 2px;
    }
    .chat-msg-bubble {
      display: inline-block; padding: 8px 12px; border-radius: 12px;
      font-family: 'Inter', sans-serif; font-size: 13px;
      max-width: 80%; word-break: break-word;
    }
    .chat-msg.other .chat-msg-bubble {
      background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.85);
    }
    .chat-msg.me { text-align: right; }
    .chat-msg.me .chat-msg-name { text-align: right; }
    .chat-msg.me .chat-msg-bubble {
      background: rgba(255,107,157,0.15); color: #ff6b9d;
    }
    .chat-msg-system {
      text-align: center; font-family: 'Inter', sans-serif;
      font-size: 11px; color: rgba(255,255,255,0.3);
      margin: 8px 0;
    }
    .chat-nickname-box {
      padding: 16px; text-align: center;
    }
    .chat-nickname-box input {
      padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 13px;
      outline: none; width: 60%; margin-right: 8px;
    }
    .chat-nickname-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #ff6b9d; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 13px;
      font-weight: 700; cursor: pointer;
    }
    .chat-input-box {
      display: flex; gap: 8px; padding: 10px 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      flex-shrink: 0;
    }
    .chat-input-box.hidden { display: none; }
    .chat-input-box input {
      flex: 1; padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 13px; outline: none;
    }
    .chat-input-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #ff6b9d; border: none; color: #fff;
      font-family: 'Outfit', sans-serif; font-size: 13px;
      font-weight: 700; cursor: pointer;
    }

    /* Back link */
    .back-link {
      display: inline-block; margin-top: 20px;
      font-family: 'Outfit', sans-serif; font-size: 14px;
      color: #ff6b9d; text-decoration: none;
      border: 1px solid #ff6b9d; border-radius: 12px;
      padding: 10px 24px; transition: all 0.2s;
    }
    .back-link:hover {
      background: #ff6b9d; color: #fff;
    }
  </style>
</head>
<body>

<div class="gift-card">
  <div class="gift-title">노래 선물하기</div>
  <!-- Step 1: Song Selection -->
  <div id="giftStep1">
    <div class="gift-categories" id="giftCategories"></div>
    <div class="gift-song-list" id="giftSongList"></div>
    <div class="gift-guide">
      <p>1. 다섯 가지 축하 유형 중에 하나를 선택합니다.</p>
      <p>2. 위 두 개의 버튼 중에서 원하는 버튼을 하나 선택합니다.</p>
      <p>3. 아래의 '다음' 버튼을 선택합니다.</p>
    </div>
    <div class="gift-btn-row">
      <button class="gift-btn-next" id="giftNextBtn" disabled onclick="giftGoStep2()">다음</button>
    </div>
  </div>
  <!-- Step 2: Message + Share -->
  <div class="gift-step2" id="giftStep2">
    <div class="gift-selected-info" id="giftSelectedInfo"></div>
    <textarea class="gift-msg-input" id="giftMsgInput" placeholder="선물 메시지를 입력하세요..." maxlength="100" oninput="updateGiftLink()"></textarea>
    <div class="gift-link-box">
      <input type="text" readonly id="giftLink">
      <button onclick="copyGiftLink()">복사</button>
    </div>
    <div class="gift-copied hidden" id="giftCopied">링크가 복사되었습니다!</div>
    <div class="gift-guide">
      <p>1. 선물 메시지를 입력하세요.</p>
      <p>2. 복사 버튼을 선택하고 선물하고 싶은 사람의 카톡 창이나 문자 메시지 창으로 가서 붙여넣기를 합니다.</p>
    </div>
    <div class="gift-btn-row">
      <button class="gift-btn-back" onclick="giftGoStep1()">이전</button>
    </div>
  </div>
</div>

<!-- Chat Panel -->
<div class="chat-panel hidden" id="chatPanel">
  <div class="chat-header" onclick="toggleChatMinimize()">
    <span class="chat-header-title">CHAT</span>
    <span class="chat-header-info" id="chatHeaderInfo"></span>
    <div>
      <button class="chat-header-btn" id="chatMinBtn" title="접기/펼치기">&#9660;</button>
      <button class="chat-header-btn" onclick="event.stopPropagation();closeChatPanel()" title="닫기">&times;</button>
    </div>
  </div>
  <div class="chat-nickname-box" id="chatNicknameBox">
    <input type="text" id="chatNicknameInput" placeholder="닉네임 입력" maxlength="20" onkeydown="if(event.key==='Enter')joinChat()">
    <button onclick="joinChat()">입장</button>
  </div>
  <div class="chat-messages hidden" id="chatMessages"></div>
  <div class="chat-input-box hidden" id="chatInputBox">
    <input type="text" id="chatMsgInput" placeholder="메시지 입력..." maxlength="200" onkeydown="if(event.key==='Enter')sendChatMsg()">
    <button onclick="sendChatMsg()">전송</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === Supabase Config ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;

  // === Chat State ===
  var chatChannel = null;
  var chatRoomId = null;
  var chatNickname = '';
  var chatActive = false;
  var chatPeerCount = 0;
  var chatAutoHidden = false;

  // === Gift Song Data ===
  var GIFT_SONGS = [
    { id:'birthday-1', category:'생일축하', name:'생일 축하합니다', file:'gift-songs/birthday-1.mp3' },
    { id:'birthday-2', category:'생일축하', name:'Happy Birthday To You', file:'gift-songs/birthday-2.mp3' },
    { id:'wedding-1', category:'결혼축하', name:'결혼 축하합니다', file:'gift-songs/wedding-1.mp3' },
    { id:'wedding-2', category:'결혼축하', name:'Wedding March', file:'gift-songs/wedding-2.mp3' },
    { id:'cheer-1', category:'응원', name:'힘내세요', file:'gift-songs/cheer-1.mp3' },
    { id:'cheer-2', category:'응원', name:'You Can Do It', file:'gift-songs/cheer-2.mp3' },
    { id:'thanks-1', category:'감사', name:'감사합니다', file:'gift-songs/thanks-1.mp3' },
    { id:'thanks-2', category:'감사', name:'Thank You', file:'gift-songs/thanks-2.mp3' },
    { id:'love-1', category:'사랑', name:'사랑합니다', file:'gift-songs/love-1.mp3' },
    { id:'love-2', category:'사랑', name:'Love Song', file:'gift-songs/love-2.mp3' }
  ];
  var GIFT_CATEGORIES = ['생일축하','결혼축하','응원','감사','사랑'];
  var selectedGiftSong = null;
  var giftStep = 1;

  // === Audio ===
  var audio = null;
  var hlsInstance = null;

  function generateRoomId(){
    var chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    var id = '';
    for(var i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
    return id;
  }

  // === Init ===
  document.addEventListener('DOMContentLoaded', function(){
    selectedGiftSong = null;
    giftStep = 1;
    document.getElementById('giftNextBtn').disabled = true;
    renderGiftCategories();
    renderGiftSongs(GIFT_CATEGORIES[0]);
  });

  function renderGiftCategories(){
    var box = document.getElementById('giftCategories');
    box.innerHTML = '';
    GIFT_CATEGORIES.forEach(function(cat, i){
      var btn = document.createElement('button');
      btn.className = 'gift-cat-btn' + (i === 0 ? ' active' : '');
      btn.textContent = cat;
      btn.onclick = function(){
        box.querySelectorAll('.gift-cat-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        renderGiftSongs(cat);
      };
      box.appendChild(btn);
    });
  }

  function renderGiftSongs(category){
    var list = document.getElementById('giftSongList');
    list.innerHTML = '';
    var songs = GIFT_SONGS.filter(function(s){ return s.category === category; });
    songs.forEach(function(song){
      var item = document.createElement('div');
      item.className = 'gift-song-item' + (selectedGiftSong && selectedGiftSong.id === song.id ? ' selected' : '');
      item.innerHTML = '<span class="gift-song-name">' + song.name + '</span>';
      item.onclick = function(){
        selectedGiftSong = song;
        list.querySelectorAll('.gift-song-item').forEach(function(el){ el.classList.remove('selected'); });
        item.classList.add('selected');
        document.getElementById('giftNextBtn').disabled = false;
      };
      list.appendChild(item);
    });
  }

  function giftGoStep2(){
    if(!selectedGiftSong) return;
    if(!chatRoomId) chatRoomId = generateRoomId();
    document.getElementById('giftStep1').style.display = 'none';
    document.getElementById('giftStep2').classList.add('active');
    document.getElementById('giftSelectedInfo').textContent = selectedGiftSong.category + ' - ' + selectedGiftSong.name;
    updateGiftLink();
    if(navigator.share){
      document.getElementById('giftShareBtn').classList.remove('hidden');
    } else {
      document.getElementById('giftShareBtn').classList.add('hidden');
    }
  }

  function giftGoStep1(){
    document.getElementById('giftStep2').classList.remove('active');
    document.getElementById('giftStep1').style.display = '';
  }

  function updateGiftLink(){
    var msg = document.getElementById('giftMsgInput').value.trim();
    var base = location.pathname.replace(/[^\/]*$/, '') + 'lp-player.html';
    var url = location.origin + base + '?gift=' + selectedGiftSong.id + '&room=' + chatRoomId;
    if(msg) url += '&msg=' + encodeURIComponent(msg);
    document.getElementById('giftLink').value = url;
  }

  function copyGiftLink(){
    updateGiftLink();
    var input = document.getElementById('giftLink');
    input.select();
    navigator.clipboard.writeText(input.value).then(function(){
      document.getElementById('giftCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('giftCopied').classList.add('hidden'); }, 2000);
    }).catch(function(){
      document.execCommand('copy');
      document.getElementById('giftCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('giftCopied').classList.add('hidden'); }, 2000);
    });
  }

  function nativeShareGift(){
    if(!navigator.share || !selectedGiftSong) return;
    updateGiftLink();
    navigator.share({
      title: selectedGiftSong.name + ' - 노래 선물',
      text: selectedGiftSong.name + ' 노래를 선물합니다!',
      url: document.getElementById('giftLink').value
    }).catch(function(){});
  }

  function sendGift(){
    updateGiftLink();
    var url = document.getElementById('giftLink').value;
    navigator.clipboard.writeText(url).then(function(){}).catch(function(){ document.execCommand('copy'); });
    // 보내는 사람도 선물곡 재생
    playGiftSong(selectedGiftSong);
    // 채팅 패널 오픈
    openChatPanel();
  }

  function playGiftSong(song){
    var mp3Url = SUPABASE_URL + '/storage/v1/object/public/photo-albums/' + song.file;
    loadStream(mp3Url);
  }

  function loadStream(url){
    if(hlsInstance){hlsInstance.destroy();hlsInstance=null;}
    if(!audio) audio = new Audio();
    audio.pause(); audio.src='';
    if(Hls.isSupported()&&url.includes('.m3u8')){
      hlsInstance=new Hls(); hlsInstance.loadSource(url); hlsInstance.attachMedia(audio);
      hlsInstance.on(Hls.Events.MANIFEST_PARSED,function(){
        audio.play().catch(function(){});
      });
    } else {
      audio.src=url;
      audio.addEventListener('canplay',function cp(){audio.removeEventListener('canplay',cp);
        audio.play().catch(function(){});
      });
      audio.load();
    }
  }

  // === Supabase Init ===
  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  // === Chat Functions ===
  function openChatPanel(){
    initSupabase();
    var panel = document.getElementById('chatPanel');
    var btn = document.getElementById('chatMinBtn');
    panel.classList.remove('hidden');
    panel.classList.add('minimized');
    btn.innerHTML = '&#9650;';
    if(chatNickname){
      document.getElementById('chatNicknameBox').classList.add('hidden');
      document.getElementById('chatMessages').classList.remove('hidden');
      document.getElementById('chatInputBox').classList.remove('hidden');
      if(!chatActive) connectChat();
    }
  }

  function closeChatPanel(){
    document.getElementById('chatPanel').classList.add('hidden');
    chatAutoHidden = false;
    chatPeerCount = 0;
    disconnectChat();
  }

  function toggleChatMinimize(){
    var panel = document.getElementById('chatPanel');
    var btn = document.getElementById('chatMinBtn');
    panel.classList.toggle('minimized');
    btn.innerHTML = panel.classList.contains('minimized') ? '&#9650;' : '&#9660;';
  }

  function joinChat(){
    var input = document.getElementById('chatNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); return; }
    chatNickname = name;
    document.getElementById('chatNicknameBox').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInputBox').classList.remove('hidden');
    document.getElementById('chatMsgInput').focus();
    connectChat();
  }

  function connectChat(){
    if(!supabaseClient || !chatRoomId || chatActive) return;
    chatActive = true;
    var channelName = 'listen-' + chatRoomId;
    chatChannel = supabaseClient.channel(channelName, {
      config: { broadcast: { self: false } }
    });
    chatChannel.on('broadcast', { event: 'message' }, function(payload){
      addChatMessage(payload.payload.name, payload.payload.text);
    });
    chatChannel.on('broadcast', { event: 'join' }, function(payload){
      chatPeerCount++;
      addSystemMessage(payload.payload.name + '님이 입장했습니다.');
      if(chatAutoHidden){
        chatAutoHidden = false;
        var panel = document.getElementById('chatPanel');
        panel.classList.remove('hidden');
        panel.classList.add('minimized');
        document.getElementById('chatMinBtn').innerHTML = '&#9650;';
      }
    });
    chatChannel.on('broadcast', { event: 'leave' }, function(payload){
      chatPeerCount = Math.max(0, chatPeerCount - 1);
      addSystemMessage(payload.payload.name + '님이 퇴장했습니다.');
      if(chatPeerCount <= 0){
        addSystemMessage('모든 상대방이 퇴장하여 채팅이 닫힙니다.');
        setTimeout(function(){
          chatAutoHidden = true;
          document.getElementById('chatPanel').classList.add('hidden');
        }, 2000);
      }
    });
    chatChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        chatChannel.send({
          type: 'broadcast', event: 'join',
          payload: { name: chatNickname }
        });
        addSystemMessage('채팅에 연결되었습니다.');
      }
    });
  }

  function disconnectChat(){
    if(chatChannel && chatActive){
      chatChannel.send({
        type: 'broadcast', event: 'leave',
        payload: { name: chatNickname }
      });
      supabaseClient.removeChannel(chatChannel);
      chatChannel = null;
      chatActive = false;
    }
  }

  function sendChatMsg(){
    var input = document.getElementById('chatMsgInput');
    var text = input.value.trim();
    if(!text || !chatChannel || !chatActive) return;
    chatChannel.send({
      type: 'broadcast', event: 'message',
      payload: { name: chatNickname, text: text }
    });
    addChatMessage(chatNickname, text, true);
    input.value = '';
    input.focus();
  }

  function addChatMessage(name, text, isMe){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg ' + (isMe ? 'me' : 'other');
    var nameSpan = document.createElement('div');
    nameSpan.className = 'chat-msg-name';
    nameSpan.textContent = name;
    var bubble = document.createElement('div');
    bubble.className = 'chat-msg-bubble';
    bubble.textContent = text;
    div.appendChild(nameSpan);
    div.appendChild(bubble);
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function addSystemMessage(text){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg-system';
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  window.addEventListener('beforeunload', function(){
    disconnectChat();
  });
</script>
</body>
</html>
