<!DOCTYPE html>
<html lang="ko" style="background:#f5e6d3">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÏùºÍ∏∞Ïì∞Í∏∞ | ÌÅ¥ÎùºÎùº ÎùºÎîîÏò§Ïπ¥Ìéò</title>
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ÏùºÍ∏∞Ïì∞Í∏∞ | ÌÅ¥ÎùºÎùº ÎùºÎîîÏò§Ïπ¥Ìéò" />
  <meta property="og:description" content="Ïò§Îäò ÌïòÎ£®Î•º ÏùåÏïÖÍ≥º Ìï®Íªò ÏùºÍ∏∞Î°ú ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!" />
  <meta property="og:image" content="https://jaiwshim-project.github.io/37-RadioCafe/og-image.jpg" />
  <meta property="og:url" content="https://jaiwshim-project.github.io/37-RadioCafe/diary.html" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f5e6d3;
      --body-out1: #e8d5b0; --body-out2: #d4c09a;
      --body-in1: #FFF8E7; --body-in2: #F5ECD8;
      --accent: #C8A96E;
      --accent-glow: rgba(200,169,110,0.5);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5b7 50%, #f0dcc4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    body::before {
      content: '';
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200,169,110,0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(200,169,110,0.04) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
    }
    .hidden { display: none !important; }

    /* ‚îÄ‚îÄ Card Container ‚îÄ‚îÄ */
    .diary-card {
      background: linear-gradient(145deg, #e8d5b0, #d4c09a);
      border: 1px solid rgba(139,105,20,0.15);
      border-radius: 20px; padding: 24px;
      width: 100%; max-width: 380px;
      text-align: center;
      box-shadow: 0 40px 80px rgba(100,70,30,0.15), 0 0 40px rgba(200,169,110,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
      position: relative; z-index: 1;
    }
    .diary-title {
      font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
      color: #8B6914; letter-spacing: 3px; margin-bottom: 16px;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .diary-btn-row {
      display: flex; gap: 8px; margin-top: 10px;
    }
    .diary-btn {
      flex: 1; padding: 12px; border-radius: 12px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .diary-btn:disabled { opacity: 0.3; cursor: default; }
    .diary-btn:not(:disabled):hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .diary-btn-back {
      padding: 12px 16px; border-radius: 12px;
      background: transparent; border: 1px solid rgba(139,105,20,0.2);
      color: #6a5530; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .diary-btn-back:hover { border-color: rgba(139,105,20,0.4); color: #8B6914; }
    .diary-btn-edit {
      flex: 1; padding: 12px; border-radius: 12px;
      background: transparent; border: 1px solid #C8A96E;
      color: #8B6914; font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .diary-btn-edit:hover { background: rgba(200,169,110,0.15); }

    /* ‚îÄ‚îÄ Type Selector ‚îÄ‚îÄ */
    .diary-type-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 16px; border-radius: 14px;
      background: rgba(255,255,255,0.4); border: 2px solid rgba(139,105,20,0.15);
      color: #6a5530; font-family: 'Outfit', sans-serif;
      font-size: 15px; font-weight: 700; cursor: pointer;
      transition: all 0.3s; margin-bottom: 8px;
    }
    .diary-type-btn:hover { border-color: rgba(200,169,110,0.5); background: rgba(255,255,255,0.6); }
    .diary-type-btn .type-icon { font-size: 22px; }

    /* ‚îÄ‚îÄ Text Diary ‚îÄ‚îÄ */
    .diary-textarea {
      width: 100%; min-height: 180px; padding: 14px;
      border-radius: 12px; border: 1px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.5); resize: vertical;
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #4a3d20; line-height: 1.7;
    }
    .diary-textarea:focus { outline: none; border-color: #C8A96E; box-shadow: 0 0 8px rgba(200,169,110,0.3); }
    .diary-char-count {
      text-align: right; font-size: 11px; color: #9a8a6a; margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Voice Recorder ‚îÄ‚îÄ */
    .diary-recorder {
      display: flex; flex-direction: column; align-items: center; gap: 12px;
      padding: 20px; border-radius: 14px;
      background: rgba(255,255,255,0.3); border: 1px solid rgba(139,105,20,0.1);
    }
    .diary-rec-btn {
      width: 72px; height: 72px; border-radius: 50%;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      border: 3px solid rgba(255,255,255,0.4);
      color: #fff; font-size: 28px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(200,169,110,0.4);
    }
    .diary-rec-btn:hover { transform: scale(1.05); }
    .diary-rec-btn.recording {
      background: linear-gradient(135deg, #e05050, #c03030);
      animation: pulse-rec 1.2s infinite;
    }
    @keyframes pulse-rec {
      0%, 100% { box-shadow: 0 0 0 0 rgba(224,80,80,0.4); }
      50% { box-shadow: 0 0 0 12px rgba(224,80,80,0); }
    }
    .diary-rec-time {
      font-family: 'Orbitron', monospace; font-size: 20px;
      color: #8B6914; font-weight: 700;
    }
    .diary-rec-status {
      font-family: 'Inter', sans-serif; font-size: 13px; color: #6a5530;
    }
    .diary-rec-max {
      font-size: 11px; color: #9a8a6a;
    }
    .diary-preview-audio {
      width: 100%; margin-top: 8px; border-radius: 8px;
    }

    /* ‚îÄ‚îÄ Photo Upload ‚îÄ‚îÄ */
    .diary-photo-section {
      margin-top: 12px;
    }
    .diary-photo-label {
      font-size: 12px; color: #6a5530; margin-bottom: 6px;
      text-align: left; font-weight: 600;
    }
    .diary-photo-upload {
      border: 2px dashed rgba(139,105,20,0.25);
      border-radius: 12px; padding: 16px;
      cursor: pointer; transition: all 0.3s;
      background: rgba(255,255,255,0.25);
      text-align: center;
    }
    .diary-photo-upload:hover {
      border-color: #C8A96E; background: rgba(255,255,255,0.4);
    }
    .diary-photo-upload-icon { font-size: 24px; margin-bottom: 4px; }
    .diary-photo-upload-text { font-size: 12px; color: #9a8a6a; }
    .diary-photo-thumbs {
      display: flex; gap: 8px; margin-top: 8px;
    }
    .diary-photo-thumb {
      position: relative; width: 80px; height: 80px;
      border-radius: 10px; overflow: hidden;
      border: 1px solid rgba(139,105,20,0.15);
    }
    .diary-photo-thumb img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .diary-photo-thumb-del {
      position: absolute; top: 3px; right: 3px;
      width: 20px; height: 20px; border-radius: 50%;
      background: rgba(0,0,0,0.6); border: none;
      color: #fff; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }
    .diary-photo-thumb-del:hover { background: #ff4444; }
    .diary-photo-file { display: none; }

    /* ‚îÄ‚îÄ Detail Photos ‚îÄ‚îÄ */
    .diary-detail-photos {
      display: flex; gap: 8px; margin-top: 12px; justify-content: center; flex-wrap: wrap;
    }
    .diary-detail-photo {
      width: 100px; height: 100px; border-radius: 10px;
      overflow: hidden; cursor: pointer;
      border: 1px solid rgba(139,105,20,0.12);
    }
    .diary-detail-photo img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .diary-photo-fullview {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .diary-photo-fullview img {
      max-width: 95%; max-height: 90vh; object-fit: contain;
      border-radius: 8px;
    }

    /* ‚îÄ‚îÄ Diary List ‚îÄ‚îÄ */
    .diary-list-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 20px; margin-bottom: 10px;
      padding-bottom: 8px; border-bottom: 1px solid rgba(139,105,20,0.15);
    }
    .diary-list-title {
      font-family: 'Outfit', sans-serif; font-size: 14px;
      font-weight: 700; color: #8B6914;
    }
    .diary-list-count {
      font-size: 12px; color: #9a8a6a;
    }
    .diary-list {
      max-height: 300px; overflow-y: auto;
    }
    .diary-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px;
      background: rgba(255,255,255,0.35);
      border: 1px solid rgba(139,105,20,0.08);
      margin-bottom: 6px; cursor: pointer;
      transition: all 0.2s;
    }
    .diary-item:hover { background: rgba(255,255,255,0.55); border-color: rgba(200,169,110,0.3); }
    .diary-item-no {
      font-family: 'Orbitron', monospace; font-size: 12px;
      color: #C8A96E; font-weight: 700; min-width: 28px;
    }
    .diary-item-info {
      flex: 1; text-align: left;
    }
    .diary-item-date {
      font-size: 12px; color: #6a5530; font-weight: 600;
    }
    .diary-item-type {
      font-size: 11px; color: #9a8a6a; margin-top: 2px;
    }
    .diary-item-icon {
      font-size: 18px; color: #C8A96E;
    }
    .diary-empty {
      padding: 24px; text-align: center;
      font-size: 13px; color: #9a8a6a;
    }

    /* ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ */
    .diary-detail-date {
      font-size: 12px; color: #9a8a6a; margin-bottom: 12px;
    }
    .diary-detail-type-badge {
      display: inline-block; padding: 3px 10px; border-radius: 8px;
      font-size: 11px; font-weight: 600; margin-bottom: 12px;
    }
    .badge-text { background: rgba(139,105,20,0.1); color: #8B6914; }
    .badge-voice { background: rgba(200,80,80,0.1); color: #c05050; }
    .diary-detail-content {
      text-align: left; padding: 14px;
      background: rgba(255,255,255,0.5); border-radius: 12px;
      border: 1px solid rgba(139,105,20,0.1);
      font-size: 14px; color: #4a3d20; line-height: 1.7;
      white-space: pre-wrap; word-break: break-word;
      max-height: 250px; overflow-y: auto;
    }
    .diary-detail-audio {
      width: 100%; margin-top: 12px; border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="diary-card">

  <!-- ‚îÄ‚îÄ Step 0: Main (ÏÑ†ÌÉù + Î™©Î°ù) ‚îÄ‚îÄ -->
  <div id="diaryMain">
    <div class="diary-title">DIARY</div>

    <button class="diary-type-btn" onclick="showTextWrite()">
      <span class="type-icon">&#9998;</span> Í∏ÄÎ°ú Ïì∞Í∏∞
    </button>
    <button class="diary-type-btn" onclick="showVoiceWrite()">
      <span class="type-icon">&#127908;</span> ÏùåÏÑ± Ïì∞Í∏∞
    </button>

    <div class="diary-list-header">
      <span class="diary-list-title">ÎÇ¥ ÏùºÍ∏∞ Î™©Î°ù</span>
      <span class="diary-list-count" id="diaryListCount"></span>
    </div>
    <div class="diary-list" id="diaryList">
      <div class="diary-empty" id="diaryEmpty">ÏïÑÏßÅ ÏûëÏÑ±Ìïú ÏùºÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
    </div>

    <div class="diary-btn-row" style="margin-top:16px;">
      <button class="diary-btn-back" onclick="history.back()">&#9664; Ïù¥Ï†Ñ</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Step 1: Text Write ‚îÄ‚îÄ -->
  <div id="diaryTextWrite" class="hidden">
    <div class="diary-title" id="textWriteTitle">DIARY - TEXT</div>
    <textarea class="diary-textarea" id="diaryTextarea" placeholder="Ïò§ÎäòÏùò ÏùºÍ∏∞Î•º Ïç®Î≥¥ÏÑ∏Ïöî..." maxlength="2000" oninput="updateCharCount()"></textarea>
    <div class="diary-char-count"><span id="diaryCharCount">0</span> / 2,000</div>

    <div class="diary-photo-section">
      <div class="diary-photo-label">ÏÇ¨ÏßÑ Ï≤®Î∂Ä (ÏµúÎåÄ 3Ïû•)</div>
      <div class="diary-photo-upload" id="textPhotoUpload" onclick="document.getElementById('textPhotoInput').click()">
        <div class="diary-photo-upload-icon">üì∑</div>
        <div class="diary-photo-upload-text">ÌÅ¥Î¶≠ÌïòÏó¨ ÏÇ¨ÏßÑ Ï∂îÍ∞Ä</div>
      </div>
      <input type="file" class="diary-photo-file" id="textPhotoInput" accept="image/jpeg,image/png,image/webp" multiple>
      <div class="diary-photo-thumbs" id="textPhotoThumbs"></div>
    </div>

    <div class="diary-btn-row" style="margin-top:12px;">
      <button class="diary-btn-back" onclick="backToMain()">&#9664; Ï∑®ÏÜå</button>
      <button class="diary-btn" id="textSaveBtn" onclick="saveTextDiary()" disabled>Ï†ÄÏû•</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Step 2: Voice Write ‚îÄ‚îÄ -->
  <div id="diaryVoiceWrite" class="hidden">
    <div class="diary-title" id="voiceWriteTitle">DIARY - VOICE</div>
    <div class="diary-recorder">
      <div class="diary-rec-time" id="diaryRecTime">0:00</div>
      <button class="diary-rec-btn" id="diaryRecBtn" onclick="toggleRecord()">&#127908;</button>
      <div class="diary-rec-status" id="diaryRecStatus">Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÎÖπÏùåÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî</div>
      <div class="diary-rec-max">ÏµúÎåÄ 3Î∂Ñ</div>
      <div id="diaryVoicePreview" class="hidden" style="width:100%;">
        <audio class="diary-preview-audio" id="diaryPreviewAudio" controls></audio>
      </div>
    </div>

    <div class="diary-photo-section">
      <div class="diary-photo-label">ÏÇ¨ÏßÑ Ï≤®Î∂Ä (ÏµúÎåÄ 3Ïû•)</div>
      <div class="diary-photo-upload" id="voicePhotoUpload" onclick="document.getElementById('voicePhotoInput').click()">
        <div class="diary-photo-upload-icon">üì∑</div>
        <div class="diary-photo-upload-text">ÌÅ¥Î¶≠ÌïòÏó¨ ÏÇ¨ÏßÑ Ï∂îÍ∞Ä</div>
      </div>
      <input type="file" class="diary-photo-file" id="voicePhotoInput" accept="image/jpeg,image/png,image/webp" multiple>
      <div class="diary-photo-thumbs" id="voicePhotoThumbs"></div>
    </div>

    <div class="diary-btn-row" style="margin-top:12px;">
      <button class="diary-btn-back" onclick="cancelVoice()">&#9664; Ï∑®ÏÜå</button>
      <button class="diary-btn" id="voiceSaveBtn" onclick="saveVoiceDiary()" disabled>Ï†ÄÏû•</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Step 3: Detail View ‚îÄ‚îÄ -->
  <div id="diaryDetail" class="hidden">
    <div class="diary-title">DIARY</div>
    <div class="diary-detail-date" id="detailDate"></div>
    <div id="detailBadge"></div>
    <div id="detailBody"></div>
    <div id="detailPhotos"></div>
    <div class="diary-btn-row" style="margin-top:14px;">
      <button class="diary-btn-back" onclick="backToMain()">&#9664; Î™©Î°ù</button>
      <button class="diary-btn-edit" onclick="editDiary()">ÏàòÏ†ï</button>
      <button class="diary-btn" style="background:linear-gradient(135deg,#e05050,#c03030);" onclick="deleteDiary()">ÏÇ≠Ï†ú</button>
    </div>
  </div>

</div>

<!-- Photo Full View -->
<div class="diary-photo-fullview hidden" id="diaryPhotoFullView" onclick="this.classList.add('hidden')">
  <img id="diaryFullViewImg" src="" alt="">
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === Supabase Config ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;

  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  // === State ===
  var diaries = [];
  var currentDetailId = null;
  var editingDiaryId = null;

  // Photo state
  var diaryPhotoDataUrls = []; // for preview
  var diaryPhotoBlobs = [];    // for upload
  var diaryExistingPhotoUrls = []; // already uploaded (edit mode)
  var MAX_DIARY_PHOTOS = 3;
  var MAX_PHOTO_SIZE = 10 * 1024 * 1024;

  // Voice recording state
  var recMediaRecorder = null;
  var recChunks = [];
  var recBlob = null;
  var recRecording = false;
  var recTimer = null;
  var recSec = 0;
  var recMimeType = 'audio/webm';
  var recExtension = '.webm';

  // === User ID ===
  function getUserId(){
    var username = localStorage.getItem('radioUsername');
    if(!username){
      alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      history.back();
      return '';
    }
    return username;
  }

  // === Init ===
  document.addEventListener('DOMContentLoaded', function(){
    initSupabase();
    loadDiaries();

    document.getElementById('textPhotoInput').addEventListener('change', function(){
      handleDiaryPhotos(this.files, 'text');
      this.value = '';
    });
    document.getElementById('voicePhotoInput').addEventListener('change', function(){
      handleDiaryPhotos(this.files, 'voice');
      this.value = '';
    });

    var uid = localStorage.getItem('radioUsername');
    if(uid && supabaseClient) supabaseClient.from('feature_usage').insert({user_id:uid, feature:'diary'}).then(function(){});
  });

  // === Navigation ===
  function showStep(stepId){
    ['diaryMain','diaryTextWrite','diaryVoiceWrite','diaryDetail'].forEach(function(id){
      document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(stepId).classList.remove('hidden');
  }

  function backToMain(){
    resetTextForm();
    resetVoiceForm();
    resetPhotos();
    editingDiaryId = null;
    showStep('diaryMain');
    loadDiaries();
  }

  function showTextWrite(){
    resetTextForm();
    resetPhotos();
    editingDiaryId = null;
    document.getElementById('textWriteTitle').textContent = 'DIARY - TEXT';
    document.getElementById('textSaveBtn').textContent = 'Ï†ÄÏû•';
    showStep('diaryTextWrite');
    document.getElementById('diaryTextarea').focus();
  }

  function showVoiceWrite(){
    resetVoiceForm();
    resetPhotos();
    editingDiaryId = null;
    document.getElementById('voiceWriteTitle').textContent = 'DIARY - VOICE';
    document.getElementById('voiceSaveBtn').textContent = 'Ï†ÄÏû•';
    showStep('diaryVoiceWrite');
  }

  // === Photo Handling ===
  function resetPhotos(){
    diaryPhotoDataUrls = [];
    diaryPhotoBlobs = [];
    diaryExistingPhotoUrls = [];
    renderPhotoThumbs('text');
    renderPhotoThumbs('voice');
  }

  function handleDiaryPhotos(fileList, mode){
    if(!fileList || fileList.length === 0) return;
    var total = diaryPhotoDataUrls.length + diaryExistingPhotoUrls.length;
    var remaining = MAX_DIARY_PHOTOS - total;
    if(remaining <= 0){
      alert('ÏÇ¨ÏßÑÏùÄ ÏµúÎåÄ ' + MAX_DIARY_PHOTOS + 'Ïû•ÍπåÏßÄ Ï≤®Î∂ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
      return;
    }

    var files = [];
    for(var i = 0; i < Math.min(fileList.length, remaining); i++){
      var f = fileList[i];
      if(!f.type.match(/^image\/(jpeg|png|webp)$/)){
        alert(f.name + ': ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌòïÏãùÏûÖÎãàÎã§. (JPG, PNGÎßå Í∞ÄÎä•)');
        continue;
      }
      if(f.size > MAX_PHOTO_SIZE){
        alert(f.name + ': ÌååÏùº ÌÅ¨Í∏∞Í∞Ä 10MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§.');
        continue;
      }
      files.push(f);
    }

    files.forEach(function(file){
      compressImage(file, 1200, function(blob){
        var reader = new FileReader();
        reader.onload = function(e){
          diaryPhotoDataUrls.push(e.target.result);
          diaryPhotoBlobs.push(blob);
          renderPhotoThumbs(mode);
          updatePhotoUploadVisibility(mode);
        };
        reader.readAsDataURL(blob);
      });
    });
  }

  function removeDiaryPhoto(idx, isExisting, mode){
    if(isExisting){
      diaryExistingPhotoUrls.splice(idx, 1);
    } else {
      diaryPhotoDataUrls.splice(idx, 1);
      diaryPhotoBlobs.splice(idx, 1);
    }
    renderPhotoThumbs(mode);
    updatePhotoUploadVisibility(mode);
  }

  function renderPhotoThumbs(mode){
    var thumbsEl = document.getElementById(mode + 'PhotoThumbs');
    if(!thumbsEl) return;
    var html = '';

    // Existing photos (edit mode)
    diaryExistingPhotoUrls.forEach(function(url, i){
      html += '<div class="diary-photo-thumb">' +
        '<img src="' + url + '" alt="ÏÇ¨ÏßÑ">' +
        '<button class="diary-photo-thumb-del" onclick="removeDiaryPhoto(' + i + ',true,\'' + mode + '\')">&times;</button>' +
        '</div>';
    });

    // New photos
    diaryPhotoDataUrls.forEach(function(dataUrl, i){
      html += '<div class="diary-photo-thumb">' +
        '<img src="' + dataUrl + '" alt="ÏÇ¨ÏßÑ">' +
        '<button class="diary-photo-thumb-del" onclick="removeDiaryPhoto(' + i + ',false,\'' + mode + '\')">&times;</button>' +
        '</div>';
    });

    thumbsEl.innerHTML = html;
  }

  function updatePhotoUploadVisibility(mode){
    var total = diaryPhotoDataUrls.length + diaryExistingPhotoUrls.length;
    var uploadEl = document.getElementById(mode + 'PhotoUpload');
    if(uploadEl){
      uploadEl.style.display = total >= MAX_DIARY_PHOTOS ? 'none' : '';
    }
  }

  // === Image Compression ===
  var MAX_COMPRESSED_SIZE = 1 * 1024 * 1024;

  function compressImage(file, maxWidth, callback){
    var reader = new FileReader();
    reader.onload = function(e){
      var img = new Image();
      img.onload = function(){
        var w = img.width, h = img.height;
        if(w > maxWidth){
          h = Math.round(h * maxWidth / w);
          w = maxWidth;
        }
        var canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        var qualities = [0.8, 0.6, 0.4, 0.3];
        function tryCompress(qi){
          canvas.toBlob(function(blob){
            if(blob.size <= MAX_COMPRESSED_SIZE || qi >= qualities.length - 1){
              callback(blob);
            } else {
              tryCompress(qi + 1);
            }
          }, 'image/jpeg', qualities[qi]);
        }
        tryCompress(0);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // === Upload Photos to Supabase ===
  function uploadDiaryPhotos(callback){
    var allUrls = diaryExistingPhotoUrls.slice(); // keep existing
    if(diaryPhotoBlobs.length === 0){
      callback(allUrls);
      return;
    }

    var uploaded = 0;
    var total = diaryPhotoBlobs.length;
    diaryPhotoBlobs.forEach(function(blob, i){
      var fileName = 'diary-photos/' + getUserId() + '/' + Date.now() + '-' + i + '.jpg';
      supabaseClient.storage.from('photo-albums').upload(fileName, blob, {
        contentType: 'image/jpeg', upsert: false
      }).then(function(res){
        if(!res.error){
          allUrls.push(SUPABASE_URL + '/storage/v1/object/public/photo-albums/' + fileName);
        }
        uploaded++;
        if(uploaded >= total) callback(allUrls);
      }).catch(function(){
        uploaded++;
        if(uploaded >= total) callback(allUrls);
      });
    });
  }

  // === Content JSON helpers ===
  function buildContentJson(text, photoUrls){
    if(!photoUrls || photoUrls.length === 0) return text || null;
    return JSON.stringify({ text: text || '', photos: photoUrls });
  }

  function parseDiaryContent(content){
    if(!content) return { text: '', photos: [] };
    if(content.charAt(0) === '{'){
      try {
        var obj = JSON.parse(content);
        return { text: obj.text || '', photos: obj.photos || [] };
      } catch(e){ /* fall through */ }
    }
    return { text: content, photos: [] };
  }

  // === Text Diary ===
  function updateCharCount(){
    var len = document.getElementById('diaryTextarea').value.length;
    document.getElementById('diaryCharCount').textContent = len;
    document.getElementById('textSaveBtn').disabled = len === 0;
  }

  function resetTextForm(){
    document.getElementById('diaryTextarea').value = '';
    document.getElementById('diaryCharCount').textContent = '0';
    document.getElementById('textSaveBtn').disabled = true;
  }

  function saveTextDiary(){
    var text = document.getElementById('diaryTextarea').value.trim();
    if(!text) return;
    var saveBtn = document.getElementById('textSaveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Ï†ÄÏû• Ï§ë...';

    initSupabase();
    uploadDiaryPhotos(function(photoUrls){
      var contentVal = buildContentJson(text, photoUrls);

      if(editingDiaryId){
        // Update
        supabaseClient.from('diaries').update({
          content: contentVal
        }).eq('id', editingDiaryId).then(function(res){
          saveBtn.textContent = 'Ï†ÄÏû•';
          if(res.error){
            alert('ÏàòÏ†ï Ïã§Ìå®: ' + res.error.message);
            saveBtn.disabled = false;
            return;
          }
          editingDiaryId = null;
          backToMain();
        });
      } else {
        // Insert
        supabaseClient.from('diaries').insert({
          user_id: getUserId(),
          type: 'text',
          content: contentVal,
          audio_url: null
        }).select().then(function(res){
          saveBtn.textContent = 'Ï†ÄÏû•';
          if(res.error){
            alert('Ï†ÄÏû• Ïã§Ìå®: ' + res.error.message);
            saveBtn.disabled = false;
            return;
          }
          backToMain();
        });
      }
    });
  }

  // === Voice Diary ===
  function toggleRecord(){
    if(recRecording) stopRecord();
    else startRecord();
  }

  function startRecord(){
    recChunks = [];
    recBlob = null;
    document.getElementById('voiceSaveBtn').disabled = true;
    document.getElementById('diaryVoicePreview').classList.add('hidden');

    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream){
      var mimeType = '';
      if(MediaRecorder.isTypeSupported('audio/mp4')){
        mimeType = 'audio/mp4'; recMimeType = 'audio/mp4'; recExtension = '.mp4';
      } else if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')){
        mimeType = 'audio/webm;codecs=opus'; recMimeType = 'audio/webm'; recExtension = '.webm';
      } else if(MediaRecorder.isTypeSupported('audio/webm')){
        mimeType = 'audio/webm'; recMimeType = 'audio/webm'; recExtension = '.webm';
      }
      var recOptions = mimeType ? { mimeType: mimeType } : {};
      recMediaRecorder = new MediaRecorder(stream, recOptions);
      recMediaRecorder.ondataavailable = function(e){
        if(e.data.size > 0) recChunks.push(e.data);
      };
      recMediaRecorder.onstop = function(){
        stream.getTracks().forEach(function(t){ t.stop(); });
        recBlob = new Blob(recChunks, { type: recMimeType });
        var url = URL.createObjectURL(recBlob);
        document.getElementById('diaryPreviewAudio').src = url;
        document.getElementById('diaryVoicePreview').classList.remove('hidden');
        document.getElementById('diaryRecStatus').textContent = 'ÎÖπÏùå ÏôÑÎ£å!';
        document.getElementById('voiceSaveBtn').disabled = false;
      };
      recMediaRecorder.start();
      recRecording = true;
      recSec = 0;
      document.getElementById('diaryRecBtn').classList.add('recording');
      document.getElementById('diaryRecBtn').innerHTML = '&#9209;';
      document.getElementById('diaryRecStatus').textContent = 'ÎÖπÏùå Ï§ë...';
      updateRecTimer();
      recTimer = setInterval(function(){
        recSec++;
        updateRecTimer();
        if(recSec >= 180) stopRecord();
      }, 1000);
    }).catch(function(err){
      document.getElementById('diaryRecStatus').textContent = 'ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑ºÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.';
    });
  }

  function stopRecord(){
    if(recMediaRecorder && recMediaRecorder.state === 'recording'){
      recMediaRecorder.stop();
    }
    recRecording = false;
    if(recTimer){ clearInterval(recTimer); recTimer = null; }
    document.getElementById('diaryRecBtn').classList.remove('recording');
    document.getElementById('diaryRecBtn').innerHTML = '&#127908;';
  }

  function updateRecTimer(){
    var m = Math.floor(recSec / 60);
    var s = recSec % 60;
    document.getElementById('diaryRecTime').textContent = m + ':' + (s < 10 ? '0' : '') + s;
  }

  function resetVoiceForm(){
    if(recRecording) stopRecord();
    recBlob = null;
    recChunks = [];
    recSec = 0;
    document.getElementById('diaryRecTime').textContent = '0:00';
    document.getElementById('diaryRecStatus').textContent = 'Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÎÖπÏùåÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî';
    document.getElementById('diaryVoicePreview').classList.add('hidden');
    document.getElementById('voiceSaveBtn').disabled = true;
    document.getElementById('diaryRecBtn').classList.remove('recording');
    document.getElementById('diaryRecBtn').innerHTML = '&#127908;';
  }

  function cancelVoice(){
    if(recRecording) stopRecord();
    backToMain();
  }

  function saveVoiceDiary(){
    if(!recBlob && !editingDiaryId) return;
    var saveBtn = document.getElementById('voiceSaveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'ÏóÖÎ°úÎìú Ï§ë...';

    initSupabase();

    function afterPhotoUpload(photoUrls){
      var contentVal = buildContentJson('', photoUrls);

      if(editingDiaryId){
        // Update - only update content (photos), keep audio_url if no new recording
        var updateData = { content: contentVal };
        if(recBlob){
          // New recording - upload then update
          var fileName = 'diary-voice/' + getUserId() + '_' + Date.now() + recExtension;
          supabaseClient.storage.from('photo-albums').upload(fileName, recBlob, {
            contentType: recMimeType, upsert: false
          }).then(function(uploadRes){
            if(uploadRes.error){
              alert('ÏóÖÎ°úÎìú Ïã§Ìå®: ' + uploadRes.error.message);
              saveBtn.disabled = false;
              saveBtn.textContent = 'Ï†ÄÏû•';
              return;
            }
            updateData.audio_url = SUPABASE_URL + '/storage/v1/object/public/photo-albums/' + fileName;
            supabaseClient.from('diaries').update(updateData).eq('id', editingDiaryId).then(function(res){
              saveBtn.textContent = 'Ï†ÄÏû•';
              if(res.error){ alert('ÏàòÏ†ï Ïã§Ìå®: ' + res.error.message); saveBtn.disabled = false; return; }
              editingDiaryId = null;
              backToMain();
            });
          });
        } else {
          // No new recording, just update photos
          supabaseClient.from('diaries').update(updateData).eq('id', editingDiaryId).then(function(res){
            saveBtn.textContent = 'Ï†ÄÏû•';
            if(res.error){ alert('ÏàòÏ†ï Ïã§Ìå®: ' + res.error.message); saveBtn.disabled = false; return; }
            editingDiaryId = null;
            backToMain();
          });
        }
      } else {
        // New insert
        var fileName = 'diary-voice/' + getUserId() + '_' + Date.now() + recExtension;
        supabaseClient.storage.from('photo-albums').upload(fileName, recBlob, {
          contentType: recMimeType, upsert: false
        }).then(function(uploadRes){
          if(uploadRes.error){
            alert('ÏóÖÎ°úÎìú Ïã§Ìå®: ' + uploadRes.error.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Ï†ÄÏû•';
            return;
          }
          var audioUrl = SUPABASE_URL + '/storage/v1/object/public/photo-albums/' + fileName;
          return supabaseClient.from('diaries').insert({
            user_id: getUserId(),
            type: 'voice',
            content: contentVal,
            audio_url: audioUrl
          }).select();
        }).then(function(res){
          if(res && res.error){
            alert('Ï†ÄÏû• Ïã§Ìå®: ' + res.error.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Ï†ÄÏû•';
            return;
          }
          saveBtn.textContent = 'Ï†ÄÏû•';
          backToMain();
        });
      }
    }

    uploadDiaryPhotos(afterPhotoUpload);
  }

  // === Load Diary List ===
  function loadDiaries(){
    initSupabase();
    supabaseClient.from('diaries')
      .select('*')
      .eq('user_id', getUserId())
      .order('created_at', { ascending: false })
      .then(function(res){
        if(res.error){
          console.log('ÏùºÍ∏∞ Î°úÎìú Ïò§Î•ò:', res.error);
          return;
        }
        diaries = res.data || [];
        renderDiaryList();
      });
  }

  function renderDiaryList(){
    var listEl = document.getElementById('diaryList');
    var countEl = document.getElementById('diaryListCount');
    var emptyEl = document.getElementById('diaryEmpty');

    countEl.textContent = diaries.length + 'Í±¥';

    if(diaries.length === 0){
      emptyEl.style.display = 'block';
      listEl.innerHTML = '';
      listEl.appendChild(emptyEl);
      return;
    }

    emptyEl.style.display = 'none';
    var html = '';
    diaries.forEach(function(d, idx){
      var no = diaries.length - idx;
      var date = new Date(d.created_at);
      var dateStr = date.getFullYear() + '.' +
        String(date.getMonth()+1).padStart(2,'0') + '.' +
        String(date.getDate()).padStart(2,'0') + ' ' +
        String(date.getHours()).padStart(2,'0') + ':' +
        String(date.getMinutes()).padStart(2,'0');
      var typeLabel = d.type === 'text' ? '&#9998; Í∏Ä' : '&#127908; ÏùåÏÑ±';
      var parsed = parseDiaryContent(d.content);
      var hasPhotos = parsed.photos.length > 0;
      var photoTag = hasPhotos ? ' ¬∑ üì∑' + parsed.photos.length : '';
      var icon = d.type === 'text' ? '&#9658;' : '&#9654;';

      html += '<div class="diary-item" onclick="showDetail(\'' + d.id + '\')">' +
        '<span class="diary-item-no">#' + no + '</span>' +
        '<div class="diary-item-info">' +
          '<div class="diary-item-date">' + dateStr + '</div>' +
          '<div class="diary-item-type">' + typeLabel + photoTag + '</div>' +
        '</div>' +
        '<span class="diary-item-icon">' + icon + '</span>' +
      '</div>';
    });
    listEl.innerHTML = html;
  }

  // === Detail View ===
  function showDetail(id){
    var diary = diaries.find(function(d){ return String(d.id) === String(id); });
    if(!diary) return;
    currentDetailId = id;

    var date = new Date(diary.created_at);
    var dateStr = date.getFullYear() + 'ÎÖÑ ' +
      (date.getMonth()+1) + 'Ïõî ' +
      date.getDate() + 'Ïùº ' +
      String(date.getHours()).padStart(2,'0') + ':' +
      String(date.getMinutes()).padStart(2,'0');

    document.getElementById('detailDate').textContent = dateStr;

    var parsed = parseDiaryContent(diary.content);

    if(diary.type === 'text'){
      document.getElementById('detailBadge').innerHTML = '<span class="diary-detail-type-badge badge-text">&#9998; Í∏Ä ÏùºÍ∏∞</span>';
      document.getElementById('detailBody').innerHTML = '<div class="diary-detail-content">' + escapeHtml(parsed.text) + '</div>';
    } else {
      document.getElementById('detailBadge').innerHTML = '<span class="diary-detail-type-badge badge-voice">&#127908; ÏùåÏÑ± ÏùºÍ∏∞</span>';
      document.getElementById('detailBody').innerHTML = '<audio class="diary-detail-audio" controls src="' + diary.audio_url + '"></audio>';
    }

    // Photos
    var photosEl = document.getElementById('detailPhotos');
    if(parsed.photos.length > 0){
      var photosHtml = '<div class="diary-detail-photos">';
      parsed.photos.forEach(function(url){
        photosHtml += '<div class="diary-detail-photo" onclick="openPhotoFullView(\'' + url + '\')">' +
          '<img src="' + url + '" alt="ÏÇ¨ÏßÑ">' +
          '</div>';
      });
      photosHtml += '</div>';
      photosEl.innerHTML = photosHtml;
    } else {
      photosEl.innerHTML = '';
    }

    showStep('diaryDetail');
  }

  function openPhotoFullView(url){
    document.getElementById('diaryFullViewImg').src = url;
    document.getElementById('diaryPhotoFullView').classList.remove('hidden');
  }

  // === Edit Diary ===
  function editDiary(){
    var diary = diaries.find(function(d){ return String(d.id) === String(currentDetailId); });
    if(!diary) return;

    editingDiaryId = diary.id;
    var parsed = parseDiaryContent(diary.content);

    // Load existing photos
    resetPhotos();
    diaryExistingPhotoUrls = parsed.photos.slice();

    if(diary.type === 'text'){
      resetTextForm();
      document.getElementById('diaryTextarea').value = parsed.text;
      document.getElementById('diaryCharCount').textContent = parsed.text.length;
      document.getElementById('textSaveBtn').disabled = parsed.text.length === 0;
      document.getElementById('textWriteTitle').textContent = 'DIARY - ÏàòÏ†ï';
      document.getElementById('textSaveBtn').textContent = 'ÏàòÏ†ï Ï†ÄÏû•';
      renderPhotoThumbs('text');
      updatePhotoUploadVisibility('text');
      showStep('diaryTextWrite');
      document.getElementById('diaryTextarea').focus();
    } else {
      resetVoiceForm();
      // In edit mode, voice save is enabled even without new recording (to update photos)
      document.getElementById('voiceSaveBtn').disabled = false;
      document.getElementById('voiceWriteTitle').textContent = 'DIARY - ÏàòÏ†ï';
      document.getElementById('voiceSaveBtn').textContent = 'ÏàòÏ†ï Ï†ÄÏû•';
      document.getElementById('diaryRecStatus').textContent = 'ÏÉàÎ°ú ÎÖπÏùåÌïòÍ±∞ÎÇò ÏÇ¨ÏßÑÎßå ÏàòÏ†ïÌïòÏÑ∏Ïöî';
      // Show existing audio
      if(diary.audio_url){
        document.getElementById('diaryPreviewAudio').src = diary.audio_url;
        document.getElementById('diaryVoicePreview').classList.remove('hidden');
      }
      renderPhotoThumbs('voice');
      updatePhotoUploadVisibility('voice');
      showStep('diaryVoiceWrite');
    }
  }

  // === Delete Diary ===
  function deleteDiary(){
    if(!currentDetailId) return;
    if(!confirm('Ïù¥ ÏùºÍ∏∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

    initSupabase();
    var diary = diaries.find(function(d){ return String(d.id) === String(currentDetailId); });

    supabaseClient.from('diaries').delete().eq('id', currentDetailId).then(function(res){
      if(res.error){
        alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + res.error.message);
        return;
      }
      // Delete voice file from storage
      if(diary && diary.type === 'voice' && diary.audio_url){
        var path = diary.audio_url.split('/photo-albums/')[1];
        if(path) supabaseClient.storage.from('photo-albums').remove([path]);
      }
      // Delete photo files from storage
      if(diary && diary.content){
        var parsed = parseDiaryContent(diary.content);
        if(parsed.photos.length > 0){
          var photoPaths = parsed.photos.map(function(url){
            return url.split('/photo-albums/')[1];
          }).filter(function(p){ return !!p; });
          if(photoPaths.length > 0){
            supabaseClient.storage.from('photo-albums').remove(photoPaths);
          }
        }
      }
      backToMain();
    });
  }

  // === Utils ===
  function escapeHtml(text){
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
</body>
</html>
