<!DOCTYPE html>
<html lang="ko" style="background:#f5e6d3">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>같이듣기 초대 | 클라라 라디오카페</title>
  <meta property="og:type" content="website" />
  <meta property="og:title" content="같이듣기 초대 | 클라라 라디오카페" />
  <meta property="og:description" content="친구와 함께 실시간 라디오를 들어요! 초대 링크를 공유하세요." />
  <meta property="og:image" content="https://jaiwshim-project.github.io/37-RadioCafe/digital-screen.jpg" />
  <meta property="og:url" content="https://jaiwshim-project.github.io/37-RadioCafe/listen-together.html" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f5e6d3;
      --body-out1: #e8d5b0; --body-out2: #d4c09a;
      --body-in1: #FFF8E7; --body-in2: #F5ECD8;
      --accent: #C8A96E;
      --accent-glow: rgba(200,169,110,0.5);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5b7 50%, #f0dcc4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* Listen Together Card */
    .ltm-card {
      background: linear-gradient(145deg, #FFF8E7, #F5ECD8);
      border: 1px solid rgba(139,105,20,0.15);
      border-radius: 20px; padding: 24px;
      width: 100%; max-width: 340px;
      text-align: center;
      box-shadow: 0 40px 80px rgba(100,70,30,0.15), 0 0 40px rgba(200,169,110,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .ltm-logo {
      font-family: 'Outfit', sans-serif; font-size: 20px; font-weight: 700;
      color: #8B6914; letter-spacing: 2px; margin-bottom: 6px;
      text-shadow: none;
    }
    .ltm-title {
      font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
      color: #8B6914; letter-spacing: 3px; margin-bottom: 16px;
      text-shadow: none;
    }
    .ltm-station {
      font-family: 'Outfit', sans-serif; font-size: 18px; font-weight: 700;
      color: #3a2a10; margin-bottom: 4px;
    }
    .ltm-freq {
      font-family: 'Orbitron', monospace; font-size: 12px;
      color: #C8A96E; letter-spacing: 2px; margin-bottom: 20px;
    }
    .ltm-link-box {
      display: flex; gap: 8px; margin-bottom: 8px;
    }
    .ltm-link-box input {
      flex: 1; padding: 10px 12px; border-radius: 10px;
      border: 2px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 11px;
      outline: none;
    }
    .ltm-link-box button {
      padding: 10px 16px; border-radius: 10px;
      background: linear-gradient(135deg, #C8A96E, #b89858); border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; white-space: nowrap;
    }
    .ltm-link-box button:hover { box-shadow: 0 8px 24px rgba(200,169,110,0.4); }
    .ltm-greeting {
      width: 100%; padding: 10px 14px; border-radius: 10px;
      border: 2px solid rgba(139,105,20,0.2);
      background: rgba(255,255,255,0.7); color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 13px;
      outline: none; margin-bottom: 10px; box-sizing: border-box;
      text-align: center;
    }
    .ltm-greeting:focus { border-color: #C8A96E; }
    .ltm-greeting::placeholder { color: rgba(100,70,30,0.4); }
    .ltm-copied {
      font-family: 'Inter', sans-serif; font-size: 12px;
      color: #C8A96E; margin-bottom: 12px;
    }
    .ltm-copied.hidden { display: none; }
    .ltm-guide {
      text-align: left; margin-top: 24px; margin-bottom: 24px; padding: 12px 14px;
      background: rgba(139,105,20,0.06); border-radius: 10px;
      border-left: 3px solid #C8A96E;
    }
    .ltm-guide p {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: #3a2a10; line-height: 1.6;
      margin: 0 0 8px 0;
    }
    .ltm-guide p:last-child { margin-bottom: 0; }

    /* No station warning */
    .no-station {
      font-family: 'Inter', sans-serif; font-size: 14px;
      color: #A08050; margin-bottom: 16px;
      line-height: 1.6;
    }

    /* Back link */
    .back-link {
      display: inline-block; margin-top: 12px;
      font-family: 'Outfit', sans-serif; font-size: 14px;
      color: #fff; text-decoration: none;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      border: none; border-radius: 12px;
      padding: 10px 24px; transition: all 0.2s;
    }
    .back-link:hover {
      box-shadow: 0 8px 24px rgba(200,169,110,0.4);
    }
  </style>
</head>
<body>

<div class="ltm-card">
  <div class="ltm-logo">클라라 라디오 카페</div>
  <div class="ltm-title">같이듣기 초대</div>
  <div id="noStationMsg" class="no-station" style="display:none">
    먼저 라디오에서 채널을 선택해주세요.<br>다이얼을 돌려 방송국을 튜닝하세요.
  </div>
  <div class="ltm-station" id="ltmStation">-</div>
  <div class="ltm-freq" id="ltmFreq">-</div>
  <input type="text" class="ltm-greeting" id="ltmGreeting" placeholder="초대 상대에게 전할 인사말을 입력하세요" maxlength="100" oninput="updateGreetingInLink()">
  <div class="ltm-link-box">
    <input type="text" readonly id="ltmLink">
    <button onclick="copyListenLink()">복사</button>
  </div>
  <div class="ltm-copied hidden" id="ltmCopied">링크가 복사되었습니다!</div>
  <div class="ltm-guide">
    <p>1. 초대 상대에게 전할 인사말을 입력하세요.</p>
    <p>2. 복사 버튼을 선택하고 초대하고 싶은 사람의 카톡 창이나 문자 메시지 창으로 가서 붙여넣기를 합니다. (초대받은 상대는 카톡 창이나 문자 메시지 창의 링크를 클릭하여 음악듣기 채팅창으로 접속하여, 닉네임을 입력하고 채팅을 시작합니다)</p>
    <p>3. 아래에 보이는 '라디오로 돌아가기' 버튼을 선택하면 초대받은 사람과 채팅할 수 있는 화면으로 이동합니다. (여러분의 닉네임을 입력하고 채팅을 시작합니다)</p>
  </div>
  <a href="#" class="back-link" onclick="event.preventDefault();history.back()">이전</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  var chatRoomId = null;

  // === Station Data ===
  var STATIONS = [
    {id:'kbs-1fm',name:'KBS 클래식FM',freq:'93.1 MHz',freqNum:93.1},
    {id:'ebs-fm',name:'EBS FM',freq:'104.5 MHz',freqNum:104.5},
    {id:'gwangju-mbc-fm',name:'광주MBC FM',freq:'93.9 MHz',freqNum:93.9},
    {id:'ytn-radio',name:'YTN 라디오',freq:'94.5 MHz',freqNum:94.5},
    {id:'tbs-fm',name:'TBS FM',freq:'95.1 MHz',freqNum:95.1},
    {id:'febc',name:'극동방송',freq:'106.9 MHz',freqNum:106.9},
    {id:'tbn',name:'TBN 교통방송',freq:'95.1 MHz',freqNum:95.1},
    {id:'obs',name:'OBS 라디오',freq:'99.9 MHz',freqNum:99.9},
    {id:'wqxr',name:'WQXR',freq:'미국',freqNum:0},
    {id:'ottava',name:'OTTAVA',freq:'일본',freqNum:0},
    {id:'france-musique',name:'France Musique',freq:'프랑스',freqNum:0},
    {id:'br-klassik',name:'BR Klassik',freq:'독일',freqNum:0},
    {id:'classic-fm',name:'Classic FM',freq:'영국',freqNum:0}
  ];

  var currentStation = null;

  function generateRoomId(){
    var chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    var id = '';
    for(var i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
    return id;
  }

  function goBack(){
    var url = 'analog.html';
    var params = [];
    if(currentStation) params.push('station=' + currentStation.id);
    if(chatRoomId) params.push('room=' + chatRoomId);
    params.push('openchat=1');
    if(params.length) url += '?' + params.join('&');
    location.href = url;
  }

  // === Init ===
  document.addEventListener('DOMContentLoaded', function(){
    // URL 파라미터에서 station 정보 가져오기
    var urlParams = new URLSearchParams(location.search);
    var stationId = urlParams.get('station');
    var roomParam = urlParams.get('room');

    if(stationId){
      currentStation = STATIONS.find(function(s){ return s.id === stationId; });
    }

    if(currentStation){
      document.getElementById('ltmStation').textContent = currentStation.name;
      document.getElementById('ltmFreq').textContent = currentStation.freq || '';
    } else {
      document.getElementById('noStationMsg').style.display = '';
      document.getElementById('ltmStation').textContent = '채널 미선택';
      document.getElementById('ltmFreq').textContent = '';
    }

    if(!chatRoomId) chatRoomId = roomParam || generateRoomId();

    updateGreetingInLink();

    // Feature usage logging
    var uid = localStorage.getItem('radioUsername');
    if(uid){ initSupabase(); if(supabaseClient) supabaseClient.from('feature_usage').insert({user_id:uid, feature:'listen_together'}).then(function(){}); }
  });

  function buildInviteUrl(){
    var base = location.origin + location.pathname.replace(/[^\/]*$/, '') + 'song-chat.html?station=' + (currentStation ? currentStation.id : '') + '&room=' + chatRoomId;
    var greeting = document.getElementById('ltmGreeting').value.trim();
    if(greeting) base += '&greeting=' + encodeURIComponent(greeting);
    return base;
  }

  function updateGreetingInLink(){
    document.getElementById('ltmLink').value = buildInviteUrl();
  }

  // === Supabase ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;
  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  function saveListenSession(){
    try {
      initSupabase();
      if(!supabaseClient) return;
      var greeting = document.getElementById('ltmGreeting').value.trim();
      supabaseClient.from('listen_sessions').insert({
        room_id: chatRoomId,
        station_id: currentStation ? currentStation.id : null,
        station_name: currentStation ? currentStation.name : null,
        host_greeting: greeting || null
      }).then(function(){});
    } catch(e){}
  }

  function copyListenLink(){
    var input = document.getElementById('ltmLink');
    input.select();
    navigator.clipboard.writeText(input.value).then(function(){
      document.getElementById('ltmCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('ltmCopied').classList.add('hidden'); }, 2000);
      saveListenSession();
    }).catch(function(){
      document.execCommand('copy');
      document.getElementById('ltmCopied').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('ltmCopied').classList.add('hidden'); }, 2000);
      saveListenSession();
    });
  }


</script>
</body>
</html>
