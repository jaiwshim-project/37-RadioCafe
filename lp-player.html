<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Radio Cafe - LP Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(160deg, #0a0a12, #1a0a1e, #0a0a12);
      min-height: 100vh; overflow-x: hidden;
      font-family: 'Inter', sans-serif; color: #fff;
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding: 10px 16px 80px;
    }
    .hidden { display: none !important; }

    /* ===== Title (ÌÑ¥ÌÖåÏù¥Î∏î ÎÇ¥Î∂Ä ÏÉÅÎã®) ===== */
    .lp-title {
      position: absolute; top: 8px; left: 0; width: 100%;
      font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 800;
      letter-spacing: 2px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      text-align: center; z-index: 5;
    }
    .lp-title-clara { color: #ff44cc; }
    .lp-title-cafe { color: #b388ff; }

    /* ===== Gift Box ===== */
    .giftbox-wrap {
      position: relative; width: 80px; height: 75px;
      margin: 6px auto 4px; z-index: 20;
      transition: opacity 1s ease 3.5s;
    }
    .giftbox-wrap.done { opacity: 0; pointer-events: none; }
    .giftbox-base {
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 64px; height: 46px;
      background: linear-gradient(145deg, #ff6b9d, #e8557a);
      border-radius: 6px;
      box-shadow: 0 3px 16px rgba(255,107,157,0.5);
      overflow: hidden;
    }
    .gb-ribbon-v {
      position: absolute; left: 50%; top: 0; transform: translateX(-50%);
      width: 10px; height: 100%;
      background: linear-gradient(90deg, #ffd700, #ffe44d, #ffd700);
    }
    .gb-ribbon-h {
      position: absolute; top: 50%; left: 0; transform: translateY(-50%);
      width: 100%; height: 10px;
      background: linear-gradient(180deg, #ffd700, #ffe44d, #ffd700);
    }
    .giftbox-lid {
      position: absolute; bottom: 42px; left: 50%;
      transform: translateX(-50%);
      width: 72px; height: 16px;
      background: linear-gradient(145deg, #ff7fae, #ff6b9d);
      border-radius: 6px 6px 2px 2px;
      border-bottom: 2px solid #d44a6e;
      z-index: 3; overflow: visible;
      transform-origin: center bottom;
    }
    .giftbox-bow {
      position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
      font-size: 20px; line-height: 1;
    }
    .giftbox-lid.open {
      animation: lid-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.6) forwards;
    }
    @keyframes lid-pop {
      0% { transform: translateX(-50%) rotate(0deg) translateY(0); }
      50% { transform: translateX(-50%) rotate(-30deg) translateY(-60px); }
      100% { transform: translateX(-50%) rotate(-20deg) translateY(-45px); opacity: 0.5; }
    }

    /* ===== Fireworks Animation ===== */
    .confetti-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 9999; overflow: hidden;
    }
    @keyframes confetti-fly {
      0% { opacity: 1; transform: translate(0, 0) rotate(0deg) scale(1); }
      80% { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.2); }
    }
    @keyframes confetti-sparkle {
      0%, 100% { box-shadow: 0 0 3px currentColor; }
      50% { box-shadow: 0 0 8px currentColor, 0 0 16px currentColor; }
    }
    /* Î∞òÏßùÏù¥ Î≥Ñ */
    @keyframes star-twinkle {
      0% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
      15% { opacity: 1; transform: translate(var(--tx), var(--ty)) scale(1.2); }
      30% { opacity: 0.3; transform: translate(var(--tx), var(--ty)) scale(0.6); }
      45% { opacity: 1; transform: translate(var(--tx), var(--ty)) scale(1); }
      60% { opacity: 0.2; transform: translate(var(--tx), var(--ty)) scale(0.5); }
      75% { opacity: 1; transform: translate(var(--tx), var(--ty)) scale(1.1); }
      90% { opacity: 0.8; transform: translate(var(--tx), var(--ty)) scale(0.8); }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
    }
    .sparkle-star {
      position: absolute; pointer-events: none;
    }
    .sparkle-star::before, .sparkle-star::after {
      content: ''; position: absolute;
      background: var(--star-color);
    }
    .sparkle-star::before {
      width: var(--star-w); height: var(--star-size);
      top: 50%; left: 50%; transform: translate(-50%,-50%);
      border-radius: 50%;
    }
    .sparkle-star::after {
      width: var(--star-size); height: var(--star-w);
      top: 50%; left: 50%; transform: translate(-50%,-50%);
      border-radius: 50%;
    }

    /* ÌïòÌä∏/Ïù¥Î™®ÏßÄ ÌååÌã∞ÌÅ¥ */
    .emoji-particle {
      position: absolute; pointer-events: none;
      font-size: var(--em-size); line-height: 1;
      animation: emoji-float var(--em-dur) ease-out var(--em-delay) forwards;
    }
    @keyframes emoji-float {
      0% { opacity: 1; transform: translate(0, 0) scale(0.3) rotate(0deg); }
      20% { opacity: 1; transform: translate(calc(var(--tx)*0.2), calc(var(--ty)*0.2)) scale(1.3) rotate(var(--rot)); }
      50% { opacity: 1; transform: translate(calc(var(--tx)*0.5), calc(var(--ty)*0.5)) scale(1) rotate(calc(var(--rot)*0.5)); }
      80% { opacity: 0.8; }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.4) rotate(var(--rot)); }
    }

    /* ===== LP Turntable ===== */
    .turntable {
      position: relative; width: 320px; height: 320px;
      margin: 10px auto 0;
    }
    .turntable-base {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(ellipse at 40% 40%, #2a2028, #1a1018);
      border-radius: 16px;
      border: 2px solid rgba(255,107,157,0.2);
      box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 30px rgba(255,107,157,0.08);
    }
    .platter {
      position: absolute; top: 50%; left: 46%; transform: translate(-50%, -50%);
      width: 240px; height: 240px; border-radius: 50%;
      background: radial-gradient(circle, #111 18%, #1a1a1a 19%, #0d0d0d 20%,
        #1a1a1a 22%, #111 24%, #1a1a1a 26%, #0d0d0d 28%,
        #1a1a1a 30%, #111 35%, #1a1a1a 37%, #0d0d0d 40%,
        #1a1a1a 44%, #111 48%, #1a1a1a 50%, #0d0d0d 54%,
        #1a1a1a 58%, #111 62%, #1a1a1a 66%, #0d0d0d 70%,
        #1a1a1a 74%, #111 78%, #1a1a1a 82%, #0d0d0d 86%,
        #1a1a1a 90%, #111 94%, #1a1a1a 97%, #0d0d0d 100%);
      border: 3px solid #222;
      box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 30px rgba(0,0,0,0.5);
    }
    .platter.spinning {
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .record-label {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 70px; height: 70px; border-radius: 50%;
      background: radial-gradient(circle, #444 8%, #ff6b9d 10%, #e8557a 45%, #d44a6e 70%, #c43f62 100%);
      border: 2px solid #b03858;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(255,107,157,0.3);
    }
    .record-label-text {
      font-family: 'Outfit', sans-serif; font-size: 8px; font-weight: 700;
      color: rgba(255,255,255,0.9); text-align: center;
      letter-spacing: 1px; line-height: 1.2;
      max-width: 50px; overflow: hidden;
    }
    .record-hole {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 8px; height: 8px; border-radius: 50%;
      background: #0a0a12; border: 1px solid #333;
    }
    /* Tonearm - ÌîºÎ≤ó Ïò§Î•∏Ï™Ω ÌïòÎã®, 6Ïãú(Ïò§Î•∏Ï™Ω)ÏóêÏÑú ÏãúÍ≥ÑÎ∞©Ìñ•ÏúºÎ°ú LP ÏúÑÎ°ú */
    .tonearm-pivot {
      position: absolute; bottom: 28px; right: 28px;
      width: 10px; height: 10px; border-radius: 50%;
      background: #888; border: 2px solid #aaa;
      z-index: 5;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    .tonearm {
      position: absolute; bottom: 26px; right: 32px;
      width: 4px; height: 140px;
      background: linear-gradient(to top, #aaa, #888, #777);
      transform-origin: bottom center;
      transform: rotate(-90deg);
      z-index: 4;
      border-radius: 2px;
      transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 2px -2px 6px rgba(0,0,0,0.5);
    }
    .tonearm.playing { transform: rotate(-10deg); }
    .tonearm-head {
      position: absolute; top: -4px; left: -3px;
      width: 10px; height: 16px;
      background: linear-gradient(to top, #999, #666);
      border-radius: 2px 2px 1px 1px;
    }
    .tonearm-counter {
      position: absolute; bottom: 10px; left: -6px;
      width: 16px; height: 16px; border-radius: 50%;
      background: radial-gradient(circle, #999, #666);
      border: 1px solid #aaa;
    }

    /* ===== Gift Info ===== */
    .gift-info {
      text-align: center; margin-top: 12px; width: 100%; max-width: 360px;
    }
    .gift-song-title {
      font-family: 'Outfit', sans-serif; font-size: 22px; font-weight: 700;
      color: #ff6b9d; margin-bottom: 4px;
    }
    .gift-song-category {
      font-family: 'Inter', sans-serif; font-size: 13px;
      color: rgba(255,255,255,0.4); margin-bottom: 16px;
    }
    .gift-message {
      font-family: 'Inter', sans-serif; font-size: 15px; line-height: 1.7;
      color: rgba(255,255,255,0.85); padding: 16px 20px;
      background: rgba(255,107,157,0.06);
      border: 1px solid rgba(255,107,157,0.15);
      border-radius: 16px; margin-bottom: 20px;
      word-break: break-word;
    }
    .gift-message.hidden { display: none; }

    /* Play Button */
    .play-btn {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 14px 36px; border-radius: 30px;
      background: #ff6b9d; border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 16px; font-weight: 700; cursor: pointer;
      box-shadow: 0 0 24px rgba(255,107,157,0.4);
      transition: all 0.3s;
      letter-spacing: 1px;
    }
    .play-btn:hover { box-shadow: 0 0 36px rgba(255,107,157,0.6); transform: scale(1.03); }
    .play-btn .play-icon {
      display: inline-block; width: 0; height: 0;
      border-style: solid; border-width: 7px 0 7px 12px;
      border-color: transparent transparent transparent #fff;
    }
    .play-btn.playing .play-icon {
      width: 12px; height: 14px; border: none;
      border-left: 3px solid #fff; border-right: 3px solid #fff;
    }

    /* ===== Chat Panel ===== */
    .chat-panel {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 420px; max-height: 50vh;
      background: linear-gradient(145deg, #1a1020, #2a1030);
      border: 2px solid #ff6b9d;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      z-index: 10001;
      display: flex; flex-direction: column;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.5), 0 0 15px rgba(255,107,157,0.3);
      transition: transform 0.3s ease;
    }
    .chat-panel.hidden { display: none; }
    .chat-panel.minimized { transform: translateX(-50%) translateY(calc(100% - 44px)); }
    .chat-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      cursor: pointer; user-select: none;
    }
    .chat-header-title {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #ff6b9d; letter-spacing: 2px;
    }
    .chat-header-info {
      font-family: 'Inter', sans-serif; font-size: 11px; color: rgba(255,255,255,0.5);
    }
    .chat-header-btn {
      background: none; border: none; color: #ff6b9d;
      font-size: 16px; cursor: pointer; padding: 0 4px;
    }
    .chat-nickname-box {
      padding: 16px; text-align: center;
    }
    .chat-nickname-box input {
      padding: 10px 16px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 14px;
      text-align: center; outline: none; width: 70%;
    }
    .chat-nickname-box input:focus { border-color: #ff6b9d; }
    .chat-nickname-box button {
      margin-left: 8px; padding: 10px 16px; border-radius: 10px;
      background: #ff6b9d; border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 12px 16px;
      min-height: 80px;
      display: flex; flex-direction: column;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
    .chat-msg {
      margin-bottom: 10px; font-family: 'Inter', sans-serif; font-size: 15px;
      line-height: 1.5; word-break: break-word;
      display: flex; flex-direction: column;
      max-width: 78%;
    }
    .chat-msg.me { align-self: flex-end; align-items: flex-end; }
    .chat-msg.other { align-self: flex-start; align-items: flex-start; }
    .chat-msg-name {
      font-weight: 700; color: #ff6b9d; font-size: 13px;
      margin-bottom: 3px;
    }
    .chat-msg.me .chat-msg-name { color: rgba(255,255,255,0.5); }
    .chat-msg-bubble {
      padding: 8px 14px; border-radius: 14px;
      line-height: 1.5; color: rgba(255,255,255,0.9);
    }
    .chat-msg.other .chat-msg-bubble {
      background: rgba(255,255,255,0.08);
      border-top-left-radius: 4px;
    }
    .chat-msg.me .chat-msg-bubble {
      background: #ff6b9d; color: #fff;
      border-top-right-radius: 4px;
    }
    .chat-msg-system {
      text-align: center; color: rgba(255,255,255,0.35);
      font-size: 13px; font-style: italic; margin: 6px 0;
      align-self: center;
    }
    .chat-input-box {
      display: flex; gap: 8px; padding: 10px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .chat-input-box input {
      flex: 1; padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: 'Inter', sans-serif; font-size: 13px; outline: none;
    }
    .chat-input-box input:focus { border-color: #ff6b9d; }
    .chat-input-box button {
      padding: 10px 16px; border-radius: 10px;
      background: #ff6b9d; border: none;
      color: #fff; font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 700; cursor: pointer;
      white-space: nowrap;
    }

    /* Footer */
    .lp-footer {
      margin-top: 12px; text-align: center;
      font-size: 10px; color: rgba(255,255,255,0.2);
      letter-spacing: 1px;
    }
    .lp-footer a { color: rgba(255,255,255,0.3); text-decoration: none; }
    .lp-footer a:hover { color: #ff6b9d; }

    /* Ambient glow */
    .ambient-glow {
      position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(ellipse at center, rgba(255,107,157,0.03) 0%, transparent 60%);
      pointer-events: none; z-index: -1;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="ambient-glow"></div>

<!-- LP Turntable -->
<div class="turntable">
  <div class="turntable-base"></div>
  <!-- Title (ÌÑ¥ÌÖåÏù¥Î∏î ÎÇ¥Î∂Ä ÏÉÅÎã®) -->
  <div class="lp-title"><span class="lp-title-clara">ÌÅ¥ÎùºÎùº</span> <span class="lp-title-cafe">ÎùºÎîîÏò§Ïπ¥Ìéò</span></div>
  <div class="platter" id="platter">
    <div class="record-label">
      <div class="record-label-text" id="labelText">AI RADIO</div>
    </div>
    <div class="record-hole"></div>
  </div>
  <div class="tonearm" id="tonearm">
    <div class="tonearm-head"></div>
    <div class="tonearm-counter"></div>
  </div>
  <div class="tonearm-pivot"></div>
</div>

<!-- Gift Box -->
<div class="giftbox-wrap" id="giftboxWrap">
  <div class="giftbox-lid" id="giftboxLid">
    <div class="gb-ribbon-v"></div>
    <div class="giftbox-bow">üéÄ</div>
  </div>
  <div class="giftbox-base">
    <div class="gb-ribbon-v"></div>
    <div class="gb-ribbon-h"></div>
  </div>
</div>

<!-- Gift Info -->
<div class="gift-info">
  <div class="gift-song-title" id="songTitle">-</div>
  <div class="gift-song-category" id="songCategory">-</div>
  <div class="gift-message hidden" id="giftMessage"></div>
  <button class="play-btn" id="playBtn" onclick="togglePlay()">
    <span class="play-icon"></span>
    <span id="playBtnText">Ïû¨ÏÉù</span>
  </button>
</div>

<!-- Footer -->
<div class="lp-footer">
  &copy; 2026 <a href="about.html"><strong>Hyein Cho</strong></a> &middot; AI Radio Cafe
</div>

<!-- Chat Panel -->
<div class="chat-panel minimized" id="chatPanel">
  <div class="chat-header" onclick="toggleChatMinimize()">
    <span class="chat-header-title">CHAT</span>
    <span class="chat-header-info" id="chatHeaderInfo"></span>
    <div>
      <button class="chat-header-btn" id="chatMinBtn" title="Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞">&#9650;</button>
    </div>
  </div>
  <div id="chatBody">
    <div class="chat-nickname-box" id="chatNicknameBox">
      <input type="text" id="chatNicknameInput" placeholder="ÎãâÎÑ§ÏûÑ ÏûÖÎ†•" maxlength="12"
        onkeydown="if(event.key==='Enter')joinChat()">
      <button onclick="joinChat()">ÏûÖÏû•</button>
    </div>
    <div class="chat-messages hidden" id="chatMessages"></div>
    <div class="chat-input-box hidden" id="chatInputBox">
      <input type="text" id="chatMsgInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." maxlength="200"
        onkeydown="if(event.key==='Enter')sendChatMsg()">
      <button onclick="sendChatMsg()">Ï†ÑÏÜ°</button>
    </div>
  </div>
</div>

<script>
  // === Supabase Config ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var supabaseClient = null;

  // === Gift Song Data ===
  var GIFT_SONGS = [
    { id:'birthday-1', category:'ÏÉùÏùºÏ∂ïÌïò', name:'ÏÉùÏùº Ï∂ïÌïòÌï©ÎãàÎã§', file:'gift-songs/birthday-1.mp3' },
    { id:'birthday-2', category:'ÏÉùÏùºÏ∂ïÌïò', name:'Happy Birthday To You', file:'gift-songs/birthday-2.mp3' },
    { id:'wedding-1', category:'Í≤∞ÌòºÏ∂ïÌïò', name:'Í≤∞Ìòº Ï∂ïÌïòÌï©ÎãàÎã§', file:'gift-songs/wedding-1.mp3' },
    { id:'wedding-2', category:'Í≤∞ÌòºÏ∂ïÌïò', name:'Wedding March', file:'gift-songs/wedding-2.mp3' },
    { id:'cheer-1', category:'ÏùëÏõê', name:'ÌûòÎÇ¥ÏÑ∏Ïöî', file:'gift-songs/cheer-1.mp3' },
    { id:'cheer-2', category:'ÏùëÏõê', name:'You Can Do It', file:'gift-songs/cheer-2.mp3' },
    { id:'thanks-1', category:'Í∞êÏÇ¨', name:'Í∞êÏÇ¨Ìï©ÎãàÎã§', file:'gift-songs/thanks-1.mp3' },
    { id:'thanks-2', category:'Í∞êÏÇ¨', name:'Thank You', file:'gift-songs/thanks-2.mp3' },
    { id:'love-1', category:'ÏÇ¨Îûë', name:'ÏÇ¨ÎûëÌï©ÎãàÎã§', file:'gift-songs/love-1.mp3' },
    { id:'love-2', category:'ÏÇ¨Îûë', name:'Love Song', file:'gift-songs/love-2.mp3' }
  ];

  // === State ===
  var audio = null;
  var isPlaying = false;
  var currentSong = null;
  var chatChannel = null;
  var chatRoomId = null;
  var chatNickname = '';
  var chatActive = false;
  var chatPeerCount = 0;
  var chatAutoHidden = false;

  // === Init ===
  function init(){
    var urlParams = new URLSearchParams(location.search);
    var giftId = urlParams.get('gift');
    chatRoomId = urlParams.get('room');
    var msg = urlParams.get('msg') ? decodeURIComponent(urlParams.get('msg')) : '';

    if(giftId){
      currentSong = GIFT_SONGS.find(function(s){ return s.id === giftId; });
    }
    if(currentSong){
      document.getElementById('songTitle').textContent = currentSong.name;
      document.getElementById('songCategory').textContent = currentSong.category;
      document.getElementById('labelText').textContent = currentSong.name.length > 8
        ? currentSong.name.substring(0, 8) : currentSong.name;
    }
    if(msg){
      var msgEl = document.getElementById('giftMessage');
      msgEl.textContent = msg;
      msgEl.classList.remove('hidden');
    }
    // Supabase Î°úÎìú ÎåÄÍ∏∞ ÌõÑ Ï±ÑÌåÖ ÌôúÏÑ±Ìôî
    if(chatRoomId){
      var waitSupabase = setInterval(function(){
        if(window.supabase){
          clearInterval(waitSupabase);
          initSupabase();
          // Ï±ÑÌåÖ Ìå®ÎÑê ÌëúÏãú (Ï†ëÌûå ÏÉÅÌÉú)
          document.getElementById('chatPanel').classList.remove('hidden');
        }
      }, 200);
    }
  }

  // === Gift Box + Fireworks Animation ===
  var giftboxTimer = null;

  function openGiftBox(){
    var lid = document.getElementById('giftboxLid');
    var wrap = document.getElementById('giftboxWrap');
    // Reset for replay
    if(giftboxTimer) clearTimeout(giftboxTimer);
    wrap.style.transition = 'none';
    wrap.style.opacity = '1';
    wrap.classList.remove('done');
    lid.classList.remove('open');
    void lid.offsetWidth;
    wrap.style.transition = '';
    // Lid pops open
    lid.classList.add('open');
    // Play fireworks sound
    playFireworkSound();
    // Fireworks burst - Ïó¨Îü¨ Ïõ®Ïù¥Î∏åÎ°ú ÌíçÏÑ±ÌïòÍ≤å
    setTimeout(createFireworks, 300);
    setTimeout(createFireworks, 1500);
    setTimeout(createFireworks, 3500);
    setTimeout(createFireworks, 5500);
    setTimeout(createFireworks, 7500);
    // Fade out gift box
    setTimeout(function(){
      wrap.classList.add('done');
    }, 9000);
    // Reset for next replay
    giftboxTimer = setTimeout(function(){
      wrap.style.transition = 'none';
      wrap.style.opacity = '1';
      wrap.classList.remove('done');
      lid.classList.remove('open');
      void wrap.offsetWidth;
      wrap.style.transition = '';
    }, 12000);
  }

  function playFireworkSound(){
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    var t = ctx.currentTime;

    // 1. Launch whoosh (Ïò¨ÎùºÍ∞ÄÎäî ÏÜåÎ¶¨)
    var whooshDur = 0.3;
    var whooshBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * whooshDur), ctx.sampleRate);
    var whooshData = whooshBuf.getChannelData(0);
    for(var i = 0; i < whooshData.length; i++){
      whooshData[i] = (Math.random() * 2 - 1) * Math.sin(Math.PI * i / whooshData.length) * 0.2;
    }
    var whoosh = ctx.createBufferSource();
    whoosh.buffer = whooshBuf;
    var whooshFilter = ctx.createBiquadFilter();
    whooshFilter.type = 'bandpass';
    whooshFilter.frequency.setValueAtTime(1000, t);
    whooshFilter.frequency.exponentialRampToValueAtTime(4000, t + whooshDur);
    whoosh.connect(whooshFilter);
    whooshFilter.connect(ctx.destination);
    whoosh.start(t);

    // 2. Main explosion (Ìéë! ÌÑ∞ÏßÄÎäî ÏÜåÎ¶¨)
    var popDur = 0.5;
    var popBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * popDur), ctx.sampleRate);
    var popData = popBuf.getChannelData(0);
    for(var i = 0; i < popData.length; i++){
      popData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.06)) * 0.7;
    }
    var pop = ctx.createBufferSource();
    pop.buffer = popBuf;
    var popFilter = ctx.createBiquadFilter();
    popFilter.type = 'lowpass';
    popFilter.frequency.value = 3000;
    pop.connect(popFilter);
    popFilter.connect(ctx.destination);
    pop.start(t + 0.25);

    // 3. Crackle/sparkle (ÌÉÄÌÉÄÌÉÅ ÏûîÌñ• - 10Ï¥à ÎèôÏïà ÏßÄÏÜç)
    for(var c = 0; c < 50; c++){
      var delay = 0.3 + Math.random() * 8;
      var dur = 0.03 + Math.random() * 0.08;
      var cBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
      var cData = cBuf.getChannelData(0);
      for(var j = 0; j < cData.length; j++){
        cData[j] = (Math.random() * 2 - 1) * Math.exp(-j / (cData.length * 0.3)) * 0.3;
      }
      var cSrc = ctx.createBufferSource();
      cSrc.buffer = cBuf;
      var cGain = ctx.createGain();
      cGain.gain.value = 0.1 + Math.random() * 0.2;
      cSrc.connect(cGain);
      cGain.connect(ctx.destination);
      cSrc.start(t + delay);
    }

    // 4. Ï∂îÍ∞Ä ÌéëÌéë 7Î≤à (Ï§ëÍ∞ÑÏ§ëÍ∞Ñ ÌÑ∞ÏßÄÎäî ÏÜåÎ¶¨)
    for(var p = 0; p < 7; p++){
      var pDelay = 1.0 + p * 1.2 + Math.random() * 0.4;
      var pDur = 0.3 + Math.random() * 0.2;
      var pBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * pDur), ctx.sampleRate);
      var pData = pBuf.getChannelData(0);
      for(var k = 0; k < pData.length; k++){
        pData[k] = (Math.random() * 2 - 1) * Math.exp(-k / (ctx.sampleRate * 0.05)) * 0.4;
      }
      var pSrc = ctx.createBufferSource();
      pSrc.buffer = pBuf;
      var pFilter = ctx.createBiquadFilter();
      pFilter.type = 'lowpass';
      pFilter.frequency.value = 2000 + Math.random() * 2000;
      pSrc.connect(pFilter);
      pFilter.connect(ctx.destination);
      pSrc.start(t + pDelay);
    }

    // Close context
    setTimeout(function(){ ctx.close(); }, 12000);
  }

  function createFireworks(){
    var box = document.getElementById('giftboxWrap');
    var rect = box.getBoundingClientRect();
    var cx = rect.left + rect.width / 2;
    var cy = rect.top;
    var screenW = window.innerWidth;
    var screenH = window.innerHeight;

    var container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    var colors = [
      '#ff6b9d','#ffd700','#00e5ff','#76ff03','#ff4081','#7c4dff',
      '#ff9100','#e040fb','#64ffda','#ffd740','#ff5252','#448aff',
      '#69f0ae','#ffab40','#ea80fc','#b2ff59','#ff1744','#00e676',
      '#fff','#ffeb3b','#f50057','#00bcd4','#8bc34a','#ff5722'
    ];

    // === Ìè≠Ï£Ω ÌååÌã∞ÌÅ¥ (ÎåÄÎüâ) ===
    for(var i = 0; i < 120; i++){
      var piece = document.createElement('div');
      var color = colors[Math.floor(Math.random() * colors.length)];
      var w = 3 + Math.random() * 10;
      var h = w * (0.3 + Math.random() * 1.0);
      var shapes = ['50%','3px','0'];
      var br = shapes[Math.floor(Math.random() * shapes.length)];

      // ÌôîÎ©¥ Ï†ÑÏ≤¥Î•º Ï±ÑÏö∞ÎèÑÎ°ù ÎÑìÍ≤å ÌçºÏßê
      var angle = Math.random() * Math.PI * 2;
      var dist = 150 + Math.random() * Math.max(screenW, screenH) * 0.7;
      var tx = Math.cos(angle) * dist;
      var ty = Math.sin(angle) * dist - screenH * 0.4;
      var rot = (Math.random() - 0.5) * 2000;
      var dur = 2 + Math.random() * 2.5;
      var delay = Math.random() * 0.8;

      piece.style.cssText =
        'position:absolute;left:' + cx + 'px;top:' + cy + 'px;' +
        'width:' + w + 'px;height:' + h + 'px;' +
        'background:' + color + ';color:' + color + ';border-radius:' + br + ';' +
        '--tx:' + tx + 'px;--ty:' + ty + 'px;--rot:' + rot + 'deg;' +
        'animation:confetti-fly ' + dur + 's ease-out ' + delay + 's forwards,' +
        'confetti-sparkle 0.2s ease-in-out ' + delay + 's 5;';

      container.appendChild(piece);
    }

    // === Î∞òÏßùÏù¥ Î≥Ñ (ÌôîÎ©¥ Ï†ÑÏ≤¥Ïóê ÌçºÏßê) ===
    for(var s = 0; s < 60; s++){
      var star = document.createElement('div');
      star.className = 'sparkle-star';
      var sColor = colors[Math.floor(Math.random() * colors.length)];
      var starSize = 6 + Math.random() * 14;

      // ÌôîÎ©¥ ÎûúÎç§ ÏúÑÏπòÎ°ú ÎÇ†ÏïÑÍ∞ê
      var stx = (Math.random() - 0.5) * screenW * 1.2;
      var sty = (Math.random() - 0.8) * screenH * 1.2;
      var sDur = 1.5 + Math.random() * 2;
      var sDelay = Math.random() * 1.0;

      star.style.cssText =
        'left:' + cx + 'px;top:' + cy + 'px;' +
        'width:' + starSize + 'px;height:' + starSize + 'px;' +
        '--star-color:' + sColor + ';--star-size:' + starSize + 'px;--star-w:' + (starSize * 0.3) + 'px;' +
        '--tx:' + stx + 'px;--ty:' + sty + 'px;' +
        'animation:star-twinkle ' + sDur + 's ease-in-out ' + sDelay + 's forwards;';

      container.appendChild(star);
    }

    // === ÌïòÌä∏ / ÌíçÏÑ† / Ïù¥Î™®ÏßÄ ÌååÌã∞ÌÅ¥ ===
    var emojis = ['‚ù§Ô∏è','üíñ','üíï','üíó','üíù','üéà','üéÄ','ü©∑','üíú','üíõ','üß°','üíö','ü©µ','ü§ç','üéâ','üéä','‚ú®','‚≠ê','üåü','üí´','ü´ß'];
    for(var e = 0; e < 40; e++){
      var em = document.createElement('div');
      em.className = 'emoji-particle';
      em.textContent = emojis[Math.floor(Math.random() * emojis.length)];

      var emAngle = Math.random() * Math.PI * 2;
      var emDist = 100 + Math.random() * Math.max(screenW, screenH) * 0.6;
      var emTx = Math.cos(emAngle) * emDist;
      var emTy = Math.sin(emAngle) * emDist - screenH * 0.3;
      var emRot = (Math.random() - 0.5) * 720;
      var emSize = (16 + Math.random() * 24) + 'px';
      var emDur = (2 + Math.random() * 2.5) + 's';
      var emDelay = (Math.random() * 1.0) + 's';

      em.style.cssText =
        'left:' + cx + 'px;top:' + cy + 'px;' +
        '--em-size:' + emSize + ';--em-dur:' + emDur + ';--em-delay:' + emDelay + ';' +
        '--tx:' + emTx + 'px;--ty:' + emTy + 'px;--rot:' + emRot + 'deg;';

      container.appendChild(em);
    }

    // Clean up
    setTimeout(function(){ container.remove(); }, 6000);
  }

  // === Audio ===
  function togglePlay(){
    if(isPlaying){
      stopPlay();
    } else {
      startPlay();
    }
  }

  var lpStartTimer = null;

  function startPlay(){
    isPlaying = true;
    document.getElementById('playBtnText').textContent = 'Ï†ïÏßÄ';
    document.getElementById('playBtn').classList.add('playing');

    // 1Îã®Í≥Ñ: Ìè≠Ï£Ω Î®ºÏ†Ä ÌÑ∞Îú®Î¶¨Í∏∞
    openGiftBox();

    // 2Îã®Í≥Ñ: Ìè≠Ï£Ω Ï¢ÖÎ£å(~10Ï¥à) ÌõÑ LP ÌöåÏ†Ñ + ÏùåÏïÖ ÏãúÏûë
    lpStartTimer = setTimeout(function(){
      document.getElementById('platter').classList.add('spinning');
      document.getElementById('tonearm').classList.add('playing');

      // MP3 Ïû¨ÏÉù ÏãúÎèÑ
      if(currentSong){
        var mp3Url = SUPABASE_URL + '/storage/v1/object/public/photo-albums/' + currentSong.file;
        if(!audio) audio = new Audio();
        audio.src = mp3Url;
        audio.volume = 1;
        audio.play().catch(function(e){
          console.log('ÏùåÏïÖ ÌååÏùº Î°úÎìú ÎåÄÍ∏∞ Ï§ë...', e);
        });
        audio.onended = function(){
          stopPlay();
        };
        audio.onerror = function(){
          console.log('ÏùåÏïÖ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        };
      }
    }, 10000);
  }

  function stopPlay(){
    if(lpStartTimer){ clearTimeout(lpStartTimer); lpStartTimer = null; }
    if(audio){ audio.pause(); audio.currentTime = 0; }
    isPlaying = false;
    document.getElementById('platter').classList.remove('spinning');
    document.getElementById('tonearm').classList.remove('playing');
    document.getElementById('playBtnText').textContent = 'Ïû¨ÏÉù';
    document.getElementById('playBtn').classList.remove('playing');
  }

  // === Supabase ===
  function initSupabase(){
    if(supabaseClient) return;
    if(!window.supabase) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  // === Chat ===
  function toggleChatMinimize(){
    var panel = document.getElementById('chatPanel');
    var btn = document.getElementById('chatMinBtn');
    panel.classList.toggle('minimized');
    btn.innerHTML = panel.classList.contains('minimized') ? '&#9650;' : '&#9660;';
  }

  function joinChat(){
    var input = document.getElementById('chatNicknameInput');
    var name = input.value.trim();
    if(!name){ input.focus(); return; }
    chatNickname = name;
    document.getElementById('chatNicknameBox').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInputBox').classList.remove('hidden');
    document.getElementById('chatMsgInput').focus();
    connectChat();
  }

  function connectChat(){
    if(!supabaseClient || !chatRoomId || chatActive) return;
    chatActive = true;
    var channelName = 'listen-' + chatRoomId;
    chatChannel = supabaseClient.channel(channelName, {
      config: { broadcast: { self: false } }
    });

    chatChannel.on('broadcast', { event: 'message' }, function(payload){
      addChatMessage(payload.payload.name, payload.payload.text);
    });

    chatChannel.on('broadcast', { event: 'join' }, function(payload){
      chatPeerCount++;
      addSystemMessage(payload.payload.name + 'ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§.');
      if(chatAutoHidden){
        chatAutoHidden = false;
        var panel = document.getElementById('chatPanel');
        var minBtn = document.getElementById('chatMinBtn');
        panel.classList.remove('hidden');
        panel.classList.add('minimized');
        minBtn.innerHTML = '&#9650;';
        addSystemMessage('ÏÉÅÎåÄÎ∞©Ïù¥ Îã§Ïãú Ï†ëÏÜçÌñàÏäµÎãàÎã§.');
      }
    });

    chatChannel.on('broadcast', { event: 'leave' }, function(payload){
      chatPeerCount = Math.max(0, chatPeerCount - 1);
      addSystemMessage(payload.payload.name + 'ÎãòÏù¥ Ìá¥Ïû•ÌñàÏäµÎãàÎã§.');
      if(chatPeerCount <= 0){
        addSystemMessage('Î™®Îì† ÏÉÅÎåÄÎ∞©Ïù¥ Ìá¥Ïû•ÌïòÏó¨ Ï±ÑÌåÖÏù¥ Îã´ÌûôÎãàÎã§.');
        setTimeout(function(){
          chatAutoHidden = true;
          document.getElementById('chatPanel').classList.add('hidden');
        }, 2000);
      }
    });

    chatChannel.subscribe(function(status){
      if(status === 'SUBSCRIBED'){
        chatChannel.send({
          type: 'broadcast',
          event: 'join',
          payload: { name: chatNickname }
        });
        addSystemMessage('Ï±ÑÌåÖÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
      }
    });
  }

  function disconnectChat(){
    if(chatChannel && chatActive){
      chatChannel.send({
        type: 'broadcast',
        event: 'leave',
        payload: { name: chatNickname }
      });
      supabaseClient.removeChannel(chatChannel);
      chatChannel = null;
      chatActive = false;
    }
  }

  function sendChatMsg(){
    var input = document.getElementById('chatMsgInput');
    var text = input.value.trim();
    if(!text || !chatChannel || !chatActive) return;
    chatChannel.send({
      type: 'broadcast',
      event: 'message',
      payload: { name: chatNickname, text: text }
    });
    addChatMessage(chatNickname, text, true);
    input.value = '';
    input.focus();
  }

  function addChatMessage(name, text, isMe){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg ' + (isMe ? 'me' : 'other');
    var nameSpan = document.createElement('div');
    nameSpan.className = 'chat-msg-name';
    nameSpan.textContent = name;
    var bubble = document.createElement('div');
    bubble.className = 'chat-msg-bubble';
    bubble.textContent = text;
    div.appendChild(nameSpan);
    div.appendChild(bubble);
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function addSystemMessage(text){
    var container = document.getElementById('chatMessages');
    var div = document.createElement('div');
    div.className = 'chat-msg-system';
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  window.addEventListener('beforeunload', function(){ disconnectChat(); });

  // === Start ===
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
