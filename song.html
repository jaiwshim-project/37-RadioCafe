<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>축하 노래 MP3 다운로드</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Outfit:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #040a18 0%, #081830 30%, #0a2040 60%, #061428 100%);
      display: flex; align-items: flex-start; justify-content: center;
      padding: 16px;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      font-family: 'Inter', sans-serif;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(100,200,255,0.14) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(60,160,255,0.10) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(80,180,255,0.06) 0%, transparent 55%);
      pointer-events: none;
      animation: neonBgPulse 6s ease-in-out infinite;
    }
    @keyframes neonBgPulse { 0%,100%{opacity:0.8;} 50%{opacity:1;} }
    @keyframes landingShimmer { 0%{background-position:-200% center;} 100%{background-position:200% center;} }
    @keyframes dlSpin { to{transform:rotate(360deg);} }

    .song-dl-body {
      width: 100%; max-width: 420px;
      background: linear-gradient(145deg, #0c1e3a, #081428);
      border-radius: 28px; padding: 3px;
      margin: auto 0; flex-shrink: 0;
      box-shadow:
        0 40px 80px rgba(0,0,0,0.6),
        0 0 50px rgba(100,200,255,0.12),
        0 0 100px rgba(60,160,255,0.06),
        inset 0 1px 0 rgba(255,255,255,0.08);
      border: 2px solid rgba(100,200,255,0.45);
      position: relative;
    }
    .song-dl-body::before {
      content: ''; position: absolute; top: -2px; left: 12%; right: 12%; height: 2px;
      background: linear-gradient(90deg, transparent, rgba(100,200,255,0.9), transparent);
      z-index: 3; box-shadow: 0 0 14px rgba(100,200,255,0.6);
    }
    .song-dl-inner {
      background: linear-gradient(160deg, #0e1e38 0%, #0a1828 50%, #081420 100%);
      border-radius: 25px; padding: 24px 18px;
      position: relative; overflow: hidden;
    }
    .song-dl-inner::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background:
        repeating-linear-gradient(90deg, rgba(100,200,255,0.012) 0px, transparent 1px, transparent 3px),
        repeating-linear-gradient(0deg, rgba(100,200,255,0.008) 0px, transparent 1px, transparent 3px);
      pointer-events: none; border-radius: inherit;
    }
    .song-dl-inner::after {
      content: ''; position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
      border: 1px solid rgba(100,200,255,0.12);
      border-radius: 16px; pointer-events: none;
    }
    .song-dl-speaker {
      background: linear-gradient(180deg, #06101e, #0c1828);
      border-radius: 14px; padding: 10px 12px; margin-bottom: 16px;
      border: 2px solid rgba(102,187,255,0.45);
      position: relative; overflow: hidden;
      box-shadow: 0 0 10px rgba(102,187,255,0.08);
    }
    .song-dl-speaker::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        radial-gradient(circle, rgba(102,187,255,0.08) 0.8px, transparent 0.8px),
        radial-gradient(circle, rgba(102,187,255,0.04) 0.8px, transparent 0.8px);
      background-size: 5px 5px, 5px 5px;
      background-position: 0 0, 2.5px 2.5px;
    }
    .song-dl-speaker-label {
      text-align: center; font-family: 'Orbitron', monospace;
      font-size: 9px; letter-spacing: 5px; font-weight: 900;
      color: #66BBFF;
      text-shadow: 0 0 10px rgba(102,187,255,0.5), 0 0 4px rgba(102,187,255,0.3);
      position: relative; z-index: 1;
    }
    .song-dl-header {
      text-align: center; margin-bottom: 20px; position: relative; z-index: 1;
    }
    .song-dl-title {
      font-family: 'Outfit', sans-serif;
      font-size: 20px; font-weight: 800;
      background: linear-gradient(135deg, #66BBFF, #99DDFF, #66BBFF, #4499DD);
      background-size: 200% auto;
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: landingShimmer 4s linear infinite;
      letter-spacing: 1px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    .song-dl-sub {
      font-family: 'Inter', sans-serif; font-size: 12px;
      color: rgba(100,200,255,0.7); margin-top: 6px; letter-spacing: 1px;
    }
    .song-dl-header::after {
      content: ''; display: block;
      width: 80px; height: 1px; margin: 14px auto 0;
      background: linear-gradient(90deg, transparent, rgba(100,200,255,0.6), transparent);
    }
    .song-dl-list {
      display: flex; flex-direction: column; gap: 12px;
      position: relative; z-index: 1;
    }
    .song-category {
      background: linear-gradient(145deg, rgba(100,200,255,0.06), rgba(60,160,255,0.02));
      border: 1px solid rgba(100,200,255,0.2);
      border-radius: 16px; padding: 14px 16px;
      transition: all 0.3s ease;
    }
    .song-category:hover {
      border-color: rgba(100,200,255,0.35);
      box-shadow: 0 0 20px rgba(100,200,255,0.08);
    }
    .song-cat-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .song-cat-icon {
      font-size: 22px; width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(100,200,255,0.08); border-radius: 10px;
      border: 1px solid rgba(100,200,255,0.15);
    }
    .song-cat-title {
      font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700;
      color: #AADDFF; letter-spacing: 0.5px;
    }
    .song-cat-btns { display: flex; gap: 8px; }
    .song-dl-btn {
      flex: 1; padding: 10px 8px; border-radius: 14px;
      font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      letter-spacing: 0.5px; border: none; position: relative; overflow: hidden;
    }
    .song-dl-btn::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .song-dl-btn:hover::before { left: 100%; }
    .song-dl-btn.kr {
      background: linear-gradient(135deg, #1a5a9e, #144a88);
      color: #BBDDFF;
      box-shadow: 0 3px 12px rgba(20,74,136,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .song-dl-btn.kr:hover {
      background: linear-gradient(135deg, #2068b0, #1a5a9e);
      box-shadow: 0 5px 20px rgba(32,104,176,0.5), 0 0 16px rgba(100,200,255,0.15);
      transform: translateY(-1px);
    }
    .song-dl-btn.en {
      background: linear-gradient(135deg, #0e4a3a, #0a3a2e);
      color: #AAEEDD;
      box-shadow: 0 3px 12px rgba(10,58,46,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .song-dl-btn.en:hover {
      background: linear-gradient(135deg, #125a48, #0e4a3a);
      box-shadow: 0 5px 20px rgba(18,90,72,0.5), 0 0 16px rgba(80,220,160,0.15);
      transform: translateY(-1px);
    }
    .song-dl-btn:active { transform: scale(0.96) !important; }
    .song-dl-btn .dl-icon { font-size: 14px; }
    .song-dl-btn.generating { opacity: 0.6; pointer-events: none; }
    .song-dl-btn.generating::after {
      content: ''; position: absolute;
      width: 16px; height: 16px; border: 2px solid transparent;
      border-top-color: currentColor; border-radius: 50%;
      animation: dlSpin 0.8s linear infinite;
    }
    .song-dl-back {
      margin-top: 18px; text-align: center; position: relative; z-index: 1;
      display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
    }
    .song-dl-back-btn {
      background: linear-gradient(135deg, rgba(100,200,255,0.1), rgba(60,160,255,0.05));
      color: rgba(100,200,255,0.8); border: 2px solid rgba(100,200,255,0.3);
      padding: 12px 36px; border-radius: 24px;
      font-size: 13px; font-weight: 700; font-family: 'Outfit', sans-serif;
      cursor: pointer; letter-spacing: 1px; transition: all 0.3s;
      text-decoration: none; display: inline-block;
    }
    .song-dl-back-btn:hover {
      background: linear-gradient(135deg, rgba(100,200,255,0.18), rgba(60,160,255,0.1));
      border-color: rgba(100,200,255,0.6); color: #88DDFF;
      box-shadow: 0 4px 20px rgba(100,200,255,0.2);
    }
    .song-dl-back-btn:active { transform: scale(0.97); }
    .song-upload-btn {
      background: linear-gradient(135deg, rgba(255,180,60,0.15), rgba(255,150,30,0.08));
      color: rgba(255,200,100,0.9); border: 2px solid rgba(255,180,60,0.4);
      padding: 12px 24px; border-radius: 24px;
      font-size: 12px; font-weight: 700; font-family: 'Outfit', sans-serif;
      cursor: pointer; letter-spacing: 0.5px; transition: all 0.3s;
    }
    .song-upload-btn:hover {
      background: linear-gradient(135deg, rgba(255,180,60,0.25), rgba(255,150,30,0.15));
      border-color: rgba(255,180,60,0.7); color: #FFD080;
      box-shadow: 0 4px 20px rgba(255,180,60,0.2);
    }
    .song-upload-btn:active { transform: scale(0.97); }
    .song-upload-btn.uploading { opacity: 0.6; pointer-events: none; }
    .song-status {
      margin-top: 12px; text-align: center;
      font-size: 11px; color: rgba(100,200,255,0.5);
      font-family: 'Inter', sans-serif;
      position: relative; z-index: 1;
      min-height: 16px;
    }
  </style>
</head>
<body>
  <div class="song-dl-body">
    <div class="song-dl-inner">

      <div class="song-dl-speaker">
        <div class="song-dl-speaker-label">MUSIC DOWNLOAD</div>
      </div>

      <div class="song-dl-header">
        <div class="song-dl-title">축하 노래 다운로드</div>
        <div class="song-dl-sub">Celebration Songs MP3</div>
      </div>

      <div class="song-dl-list">
        <div class="song-category">
          <div class="song-cat-header">
            <div class="song-cat-icon">&#x1F382;</div>
            <div class="song-cat-title">생일 축하 &middot; Happy Birthday</div>
          </div>
          <div class="song-cat-btns">
            <button class="song-dl-btn kr" onclick="downloadSong('birthday','kr',this)"><span class="dl-icon">&#x25B6;</span> 한글판</button>
            <button class="song-dl-btn en" onclick="downloadSong('birthday','en',this)"><span class="dl-icon">&#x25B6;</span> English</button>
          </div>
        </div>

        <div class="song-category">
          <div class="song-cat-header">
            <div class="song-cat-icon">&#x1F492;</div>
            <div class="song-cat-title">결혼 축하 &middot; Wedding</div>
          </div>
          <div class="song-cat-btns">
            <button class="song-dl-btn kr" onclick="downloadSong('wedding','kr',this)"><span class="dl-icon">&#x25B6;</span> 한글판</button>
            <button class="song-dl-btn en" onclick="downloadSong('wedding','en',this)"><span class="dl-icon">&#x25B6;</span> English</button>
          </div>
        </div>

        <div class="song-category">
          <div class="song-cat-header">
            <div class="song-cat-icon">&#x1F4E3;</div>
            <div class="song-cat-title">응원 &middot; Cheering</div>
          </div>
          <div class="song-cat-btns">
            <button class="song-dl-btn kr" onclick="downloadSong('cheer','kr',this)"><span class="dl-icon">&#x25B6;</span> 한글판</button>
            <button class="song-dl-btn en" onclick="downloadSong('cheer','en',this)"><span class="dl-icon">&#x25B6;</span> English</button>
          </div>
        </div>

        <div class="song-category">
          <div class="song-cat-header">
            <div class="song-cat-icon">&#x1F64F;</div>
            <div class="song-cat-title">감사 &middot; Gratitude</div>
          </div>
          <div class="song-cat-btns">
            <button class="song-dl-btn kr" onclick="downloadSong('thanks','kr',this)"><span class="dl-icon">&#x25B6;</span> 한글판</button>
            <button class="song-dl-btn en" onclick="downloadSong('thanks','en',this)"><span class="dl-icon">&#x25B6;</span> English</button>
          </div>
        </div>

        <div class="song-category">
          <div class="song-cat-header">
            <div class="song-cat-icon">&#x2764;&#xFE0F;</div>
            <div class="song-cat-title">사랑 &middot; Love</div>
          </div>
          <div class="song-cat-btns">
            <button class="song-dl-btn kr" onclick="downloadSong('love','kr',this)"><span class="dl-icon">&#x25B6;</span> 한글판</button>
            <button class="song-dl-btn en" onclick="downloadSong('love','en',this)"><span class="dl-icon">&#x25B6;</span> English</button>
          </div>
        </div>
      </div>

      <div class="song-dl-back">
        <a class="song-dl-back-btn" href="index.html">라디오로 돌아가기</a>
        <button class="song-upload-btn" id="uploadAllBtn" onclick="uploadAllSongs()">Supabase 전체 업로드</button>
      </div>
      <div class="song-status" id="songStatus"></div>
    </div>
  </div>

<script>
  // === Supabase ===
  var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
  var BUCKET_NAME = 'photo-albums';
  var SONG_FOLDER = '_system/songs';
  var supabase;

  function initSupabase() {
    if (window.supabase && window.supabase.createClient) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
  }
  // Wait for Supabase library
  (function waitSB() {
    if (window.supabase && window.supabase.createClient) { initSupabase(); return; }
    setTimeout(waitSB, 100);
  })();

  // === Note Frequencies ===
  var NF = {
    'C2':65.41,'D2':73.42,'E2':82.41,'F2':87.31,'G2':98.00,'A2':110.00,'B2':123.47,
    'C3':130.81,'D3':146.83,'Eb3':155.56,'E3':164.81,'F3':174.61,'Fs3':185.00,'G3':196.00,'Ab3':207.65,'A3':220.00,'Bb3':233.08,'B3':246.94,
    'C4':261.63,'Cs4':277.18,'D4':293.66,'Eb4':311.13,'E4':329.63,'F4':349.23,'Fs4':369.99,
    'G4':392.00,'Ab4':415.30,'A4':440.00,'Bb4':466.16,'B4':493.88,
    'C5':523.25,'Cs5':554.37,'D5':587.33,'Eb5':622.25,'E5':659.25,'F5':698.46,'Fs5':739.99,
    'G5':783.99,'Ab5':830.61,'A5':880.00,'Bb5':932.33,'B5':987.77,'C6':1046.50
  };

  // === Song Data ===
  var SONGS = {
    birthday: {
      kr: { bpm:105, name:'생일축하_한글판', style:'warm',
        melody:[['G4',.75],['G4',.25],['A4',1],['G4',1],['C5',1],['B4',2],['G4',.75],['G4',.25],['A4',1],['G4',1],['D5',1],['C5',2],['G4',.75],['G4',.25],['G5',1],['E5',1],['C5',1],['B4',1],['A4',2],['F5',.75],['F5',.25],['E5',1],['C5',1],['D5',1],['C5',2],[0,1],['G4',.75],['G4',.25],['A4',1],['G4',1],['C5',1],['B4',2],['G4',.75],['G4',.25],['A4',1],['G4',1],['D5',1],['C5',2],['G4',.75],['G4',.25],['G5',1],['E5',1],['C5',1],['B4',1],['A4',2],['F5',.75],['F5',.25],['E5',1],['C5',1],['D5',1],['C5',3]],
        chords:[[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['G3','B3','D4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],2],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['G3','B3','D4'],4],[['C3','E3','G3'],6]],
        bass:[['C2',4],['C2',4],['F2',4],['C2',4],['C2',4],['G2',4],['C2',4],['C2',3],['C2',4],['C2',4],['F2',4],['C2',4],['C2',4],['G2',4],['C2',6]]
      },
      en: { bpm:124, name:'HappyBirthday_English', style:'bright',
        melody:[['G4',.75],['G4',.25],['A4',1],['G4',1],['C5',1],['B4',2],['G4',.75],['G4',.25],['A4',1],['G4',1],['D5',1],['C5',2],['G4',.75],['G4',.25],['G5',1],['E5',1],['C5',1],['B4',1],['A4',2],['F5',.75],['F5',.25],['E5',1],['C5',1],['D5',1],['C5',2],[0,1],['G4',.75],['G4',.25],['A4',1],['G4',1],['C5',1],['B4',2],['G4',.75],['G4',.25],['A4',1],['G4',1],['D5',1],['C5',2],['G4',.75],['G4',.25],['G5',1],['E5',1],['C5',1],['B4',1],['A4',2],['F5',.75],['F5',.25],['E5',1],['C5',1],['D5',1],['C5',3]],
        chords:[[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['G3','B3','D4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],2],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['G3','B3','D4'],4],[['C3','E3','G3'],6]],
        bass:[['C2',4],['C2',4],['F2',4],['C2',4],['C2',4],['G2',4],['C2',4],['C2',3],['C2',4],['C2',4],['F2',4],['C2',4],['C2',4],['G2',4],['C2',6]]
      }
    },
    wedding: {
      kr: { bpm:88, name:'결혼축하_한글판', style:'elegant',
        melody:[['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['A4',.5],['G4',.5],['F4',2],['G4',.5],['F4',.5],['G4',.5],['A4',1.5],['F4',1],['D4',.5],['D4',.5],['F4',2],[0,1],['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['A4',.5],['C5',.5],['A4',2],['Bb4',.5],['A4',.5],['G4',.5],['A4',1.5],['F4',1],['G4',1],['F4',3],[0,1],['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['A4',.5],['G4',.5],['F4',2],['G4',.5],['F4',.5],['G4',.5],['A4',1.5],['F4',1],['D4',.5],['D4',.5],['F4',3]],
        chords:[[['F3','A3','C4'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],3],[['F3','A3','C4'],4],[['Bb3','D4','F4'],3],[['F3','A3','C4'],3],[0,1],[['F3','A3','C4'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],3],[['F3','A3','C4'],4],[['C3','E3','G3'],3],[['F3','A3','C4'],4],[0,1],[['F3','A3','C4'],4],[['F3','A3','C4'],4],[['C3','E3','G3'],3],[['F3','A3','C4'],4],[['Bb3','D4','F4'],3],[['F3','A3','C4'],4]],
        bass:[['F2',4],['F2',4],['C2',3],['F2',4],['Bb2',3],['F2',4],['F2',4],['F2',4],['C2',3],['F2',4],['C2',3],['F2',5],['F2',4],['F2',4],['C2',3],['F2',4],['Bb2',3],['F2',4]]
      },
      en: { bpm:96, name:'Wedding_English', style:'elegant',
        melody:[['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['Ab4',.5],['G4',.5],['F4',2],['G4',.5],['F4',.5],['G4',.5],['Ab4',1.5],['F4',1],['D4',.5],['D4',.5],['F4',2],[0,1],['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['Ab4',.5],['C5',.5],['Ab4',2],['Bb4',.5],['Ab4',.5],['G4',.5],['Ab4',1.5],['F4',1],['G4',1],['F4',3],[0,1],['C5',2],['F4',1.5],['F4',.5],['F4',2],[0,.5],['F4',.5],['Ab4',.5],['G4',.5],['F4',2],['G4',.5],['F4',.5],['G4',.5],['Ab4',1.5],['F4',1],['D4',.5],['D4',.5],['F4',3]],
        chords:[[['F3','Ab3','C4'],4],[['F3','Ab3','C4'],4],[['C3','Eb3','G3'],3],[['F3','Ab3','C4'],4],[['Bb3','D4','F4'],3],[['F3','Ab3','C4'],3],[0,1],[['F3','Ab3','C4'],4],[['F3','Ab3','C4'],4],[['C3','Eb3','G3'],3],[['F3','Ab3','C4'],4],[['C3','Eb3','G3'],3],[['F3','Ab3','C4'],4],[0,1],[['F3','Ab3','C4'],4],[['F3','Ab3','C4'],4],[['C3','Eb3','G3'],3],[['F3','Ab3','C4'],4],[['Bb3','D4','F4'],3],[['F3','Ab3','C4'],4]],
        bass:[['F2',4],['F2',4],['C2',3],['F2',4],['Bb2',3],['F2',4],['F2',4],['F2',4],['C2',3],['F2',4],['C2',3],['F2',5],['F2',4],['F2',4],['C2',3],['F2',4],['Bb2',3],['F2',4]]
      }
    },
    cheer: {
      kr: { bpm:132, name:'응원_한글판', style:'bright',
        melody:[['E4',.5],['E4',.5],['G4',.5],['A4',.5],['B4',1],['B4',1],['A4',.5],['G4',.5],['A4',1],['E4',2],['E4',.5],['E4',.5],['G4',.5],['A4',.5],['B4',1],['D5',1],['B4',.5],['A4',.5],['G4',1],['E4',2],[0,1],['D5',1],['D5',.5],['B4',.5],['D5',1],['E5',1],['D5',.5],['B4',.5],['A4',1],['G4',2],['E4',.5],['G4',.5],['A4',1],['B4',.5],['A4',.5],['G4',.5],['A4',.5],['E4',2],[0,1],['E4',.5],['E4',.5],['G4',.5],['A4',.5],['B4',1],['B4',1],['A4',.5],['G4',.5],['A4',1],['E4',2],['D5',1],['D5',.5],['B4',.5],['D5',1],['E5',1],['D5',.5],['B4',.5],['A4',1],['B4',1],['E4',3]],
        chords:[[['E3','G3','B3'],4],[['E3','G3','B3'],4],[['A3','C4','E4'],4],[['E3','G3','B3'],4],[0,1],[['A3','C4','E4'],4],[['E3','G3','B3'],4],[['A3','C4','E4'],4],[['E3','G3','B3'],3],[0,1],[['E3','G3','B3'],4],[['E3','G3','B3'],4],[['A3','C4','E4'],4],[['B3','D4','Fs4'],4],['E3',4]],
        bass:[['E2',4],['E2',4],['A2',4],['E2',5],['A2',4],['E2',4],['A2',4],['E2',4],['E2',4],['E2',4],['A2',4],['B2',4],['E2',4]]
      },
      en: { bpm:144, name:'Cheering_English', style:'bright',
        melody:[['C4',.5],['E4',.5],['G4',1],['G4',.5],['A4',.5],['G4',1],['E4',.5],['G4',.5],['C5',1],['B4',2],['A4',.5],['G4',.5],['A4',1],['G4',.5],['E4',.5],['D4',2],[0,1],['C4',.5],['E4',.5],['G4',1],['A4',.5],['B4',.5],['C5',1],['D5',1],['C5',.5],['B4',.5],['A4',2],['G4',.5],['A4',.5],['G4',.5],['E4',.5],['D4',.5],['E4',.5],['C4',2],[0,1],['C4',.5],['E4',.5],['G4',1],['G4',.5],['A4',.5],['G4',1],['E4',.5],['G4',.5],['C5',1],['B4',2],['D5',1],['C5',.5],['B4',.5],['A4',1],['G4',1],['E4',.5],['G4',.5],['C4',3]],
        chords:[[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['G3','B3','D4'],3],[0,1],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['G3','B3','D4'],4],[['C3','E3','G3'],3],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[['G3','B3','D4'],4],['C3',4]],
        bass:[['C2',4],['C2',4],['F2',4],['G2',4],['C2',4],['F2',4],['G2',4],['C2',4],['C2',4],['C2',4],['F2',4],['G2',4],['C2',4]]
      }
    },
    thanks: {
      kr: { bpm:84, name:'감사_한글판', style:'warm',
        melody:[['E4',1],['G4',1],['A4',1.5],['G4',.5],['E4',2],[0,1],['A4',1],['B4',1],['C5',1.5],['B4',.5],['A4',2],[0,1],['E5',1],['D5',1],['C5',1],['B4',1],['A4',1],['G4',1],['A4',2],['E4',2],[0,1],['E4',1],['G4',1],['A4',1.5],['B4',.5],['C5',2],[0,1],['D5',1],['C5',1],['B4',1],['A4',1],['G4',1],['A4',.5],['G4',.5],['E4',2],[0,1],['E4',1],['G4',1],['A4',1.5],['G4',.5],['E4',2],[0,1],['A4',1],['B4',1],['C5',1.5],['B4',.5],['A4',2],[0,1],['D5',1],['C5',1],['B4',1],['A4',1],['G4',1],['A4',.5],['G4',.5],['E4',3]],
        chords:[[['A3','C4','E4'],4],[['A3','C4','E4'],4],[0,1],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[0,1],[['A3','C4','E4'],4],[['E3','G3','B3'],4],[['A3','C4','E4'],3],[0,1],[['A3','C4','E4'],4],[['F3','A3','C4'],4],[0,1],[['G3','B3','D4'],4],[['A3','C4','E4'],3],[0,1],[['A3','C4','E4'],4],[['A3','C4','E4'],4],[0,1],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[0,1],[['G3','B3','D4'],4],[['A3','C4','E4'],4]],
        bass:[['A2',4],['A2',5],['F2',4],['C2',5],['A2',4],['E2',4],['A2',4],['A2',4],['F2',5],['G2',4],['A2',4],['A2',4],['A2',5],['F2',4],['C2',5],['G2',4],['A2',4]]
      },
      en: { bpm:92, name:'Gratitude_English', style:'warm',
        melody:[['C4',1],['E4',1],['G4',1.5],['E4',.5],['C4',2],[0,1],['F4',1],['A4',1],['G4',1.5],['F4',.5],['E4',2],[0,1],['G4',1],['A4',1],['B4',1],['C5',2],['B4',1],['A4',1],['G4',1],['E4',2],[0,1],['C4',1],['E4',1],['G4',1],['A4',1],['G4',2],[0,1],['F4',1],['E4',1],['D4',.5],['E4',.5],['C4',2],[0,1],['C4',1],['E4',1],['G4',1.5],['E4',.5],['C4',2],[0,1],['F4',1],['A4',1],['G4',1.5],['F4',.5],['E4',2],[0,1],['F4',1],['E4',1],['D4',.5],['E4',.5],['C4',3]],
        chords:[[['C3','E3','G3'],4],[['C3','E3','G3'],4],[0,1],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],4],[['C3','E3','G3'],3],[0,1],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],3],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[0,1],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],4]],
        bass:[['C2',4],['C2',5],['F2',4],['C2',5],['G2',4],['C2',4],['C2',4],['C2',4],['F2',5],['G2',4],['C2',4],['C2',4],['C2',5],['F2',4],['C2',5],['G2',4],['C2',4]]
      }
    },
    love: {
      kr: { bpm:74, name:'사랑_한글판', style:'romantic',
        melody:[['E4',1.5],['Fs4',.5],['G4',1],['A4',1],['B4',2],[0,1],['A4',1],['G4',1],['Fs4',.5],['G4',.5],['E4',2],[0,1],['B4',1.5],['A4',.5],['G4',1],['Fs4',1],['E4',2],[0,1],['D4',1],['E4',1],['Fs4',.5],['G4',.5],['A4',2],[0,1],['E4',1.5],['Fs4',.5],['G4',1],['A4',1],['B4',2],[0,1],['D5',1],['C5',1],['B4',1],['A4',1],['G4',.5],['A4',.5],['B4',.5],['A4',.5],['G4',2],[0,1],['E4',1.5],['Fs4',.5],['G4',1],['A4',1],['B4',2],[0,1],['A4',1],['G4',1],['Fs4',.5],['G4',.5],['E4',2],[0,1],['D5',1],['C5',1],['B4',1],['A4',1],['G4',.5],['A4',.5],['B4',.5],['A4',.5],['E4',3]],
        chords:[[['E3','G3','B3'],4],[['A3','C4','E4'],4],[0,1],[['E3','G3','B3'],4],[['E3','G3','B3'],4],[0,1],[['A3','C4','E4'],4],[['E3','G3','B3'],4],[0,1],[['D3','Fs3','A3'],4],[['A3','C4','E4'],4],[0,1],[['E3','G3','B3'],4],[['A3','C4','E4'],4],[0,1],[['D3','Fs3','A3'],4],[['E3','G3','B3'],3],[0,1],[['E3','G3','B3'],4],[['A3','C4','E4'],4],[0,1],[['E3','G3','B3'],4],[['E3','G3','B3'],4],[0,1],[['D3','Fs3','A3'],4],[['E3','G3','B3'],4]],
        bass:[['E2',4],['A2',5],['E2',4],['E2',5],['A2',4],['E2',5],['D2',4],['A2',5],['E2',4],['A2',5],['D2',4],['E2',4],['E2',4],['A2',5],['E2',4],['E2',5],['D2',4],['E2',4]]
      },
      en: { bpm:80, name:'Love_English', style:'romantic',
        melody:[['C4',1.5],['D4',.5],['E4',1],['G4',1],['A4',2],[0,1],['G4',1],['E4',1],['D4',.5],['E4',.5],['C4',2],[0,1],['A4',1.5],['G4',.5],['F4',1],['E4',1],['D4',2],[0,1],['E4',1],['F4',1],['G4',.5],['A4',.5],['G4',2],[0,1],['C4',1.5],['D4',.5],['E4',1],['G4',1],['A4',2],[0,1],['C5',1],['B4',1],['A4',1],['G4',1],['F4',.5],['G4',.5],['E4',.5],['D4',.5],['C4',2],[0,1],['C4',1.5],['D4',.5],['E4',1],['G4',1],['A4',2],[0,1],['G4',1],['E4',1],['D4',.5],['E4',.5],['C4',2],[0,1],['C5',1],['B4',1],['A4',1],['G4',1],['F4',.5],['G4',.5],['E4',.5],['D4',.5],['C4',3]],
        chords:[[['C3','E3','G3'],4],[['F3','A3','C4'],4],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[0,1],[['F3','A3','C4'],4],[['C3','E3','G3'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],4],[0,1],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],3],[0,1],[['C3','E3','G3'],4],[['F3','A3','C4'],4],[0,1],[['C3','E3','G3'],4],[['C3','E3','G3'],4],[0,1],[['G3','B3','D4'],4],[['C3','E3','G3'],4]],
        bass:[['C2',4],['F2',5],['C2',4],['C2',5],['F2',4],['C2',5],['G2',4],['C2',5],['C2',4],['F2',5],['G2',4],['C2',4],['C2',4],['F2',5],['C2',4],['C2',5],['G2',4],['C2',4]]
      }
    }
  };

  // === Audio Engine ===
  function renderSongToContext(ctx, song, duration) {
    var bpm = song.bpm, beatSec = 60 / bpm;
    var comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -18; comp.knee.value = 12; comp.ratio.value = 4;
    comp.connect(ctx.destination);
    var rev = ctx.createGain(); rev.gain.value = 0.25;
    var d1 = ctx.createDelay(); d1.delayTime.value = 0.03;
    var d2 = ctx.createDelay(); d2.delayTime.value = 0.07;
    var d3 = ctx.createDelay(); d3.delayTime.value = 0.13;
    var g1 = ctx.createGain(); g1.gain.value = 0.3;
    var g2 = ctx.createGain(); g2.gain.value = 0.2;
    var g3 = ctx.createGain(); g3.gain.value = 0.12;
    rev.connect(d1); d1.connect(g1); g1.connect(comp);
    rev.connect(d2); d2.connect(g2); g2.connect(comp);
    rev.connect(d3); d3.connect(g3); g3.connect(comp);
    var isR = song.style==='romantic', isE = song.style==='elegant', isB = song.style==='bright';
    var t = 0.5;
    song.melody.forEach(function(n) {
      var note=n[0], beats=n[1], dur=beats*beatSec;
      if (note && NF[note]) {
        var f = NF[note];
        sn(ctx,comp,rev,f,t,dur*.92,.22,'triangle',isR?.06:.03);
        sn(ctx,comp,rev,f*2,t,dur*.85,.08,'sine',.02);
        sn(ctx,comp,rev,f*3,t,dur*.7,.025,'sine',.01);
        sn(ctx,comp,rev,f*.5,t,dur*.6,.04,'sine',.01);
        sn(ctx,comp,rev,f*1.003,t+.008,dur*.88,.06,'triangle',.03);
        sn(ctx,comp,rev,f*.997,t+.005,dur*.88,.06,'triangle',.03);
      }
      t += dur;
    });
    var ct = 0.5;
    if (song.chords) song.chords.forEach(function(c) {
      var ns=c[0], beats=c[1], dur=beats*beatSec;
      if (ns && Array.isArray(ns)) ns.forEach(function(cn) {
        if (NF[cn]) { var v=isE?.05:.06; sn(ctx,comp,rev,NF[cn],ct,dur*.95,v,'sine',.08); sn(ctx,comp,rev,NF[cn]*1.002,ct+.01,dur*.9,v*.5,'sine',.08); }
      });
      ct += dur;
    });
    var bt = 0.5;
    if (song.bass) song.bass.forEach(function(b) {
      var note=b[0], beats=b[1], dur=beats*beatSec;
      if (note && NF[note]) { sn(ctx,comp,rev,NF[note],bt,dur*.9,.12,'sine',.05); sn(ctx,comp,rev,NF[note]*2,bt,dur*.7,.03,'triangle',.03); }
      bt += dur;
    });
    if (isB) {
      var rt=0.5, re=duration-1, bl=beatSec;
      while(rt<re) { perc(ctx,comp,rt,.04,.05); if(rt+bl*2<re) perc(ctx,comp,rt+bl*2,.02,.04); rt+=bl*4; }
    }
  }
  function sn(ctx,dest,rev,freq,start,dur,vol,wave,att) {
    var o=ctx.createOscillator(), g=ctx.createGain();
    o.type=wave||'triangle'; o.frequency.value=freq;
    var a=att||.03, r=Math.min(.3,dur*.25), sv=vol*.75;
    g.gain.setValueAtTime(0,start);
    g.gain.linearRampToValueAtTime(vol,start+a);
    g.gain.exponentialRampToValueAtTime(Math.max(sv,.001),start+a+.1);
    g.gain.setValueAtTime(Math.max(sv,.001),start+dur-r);
    g.gain.exponentialRampToValueAtTime(.001,start+dur);
    o.connect(g); g.connect(dest); if(rev) g.connect(rev);
    o.start(start); o.stop(start+dur+.05);
  }
  function perc(ctx,dest,time,vol,dur) {
    var bs=Math.ceil(ctx.sampleRate*dur), nb=ctx.createBuffer(1,bs,ctx.sampleRate), d=nb.getChannelData(0);
    for(var i=0;i<bs;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(bs*.15));
    var s=ctx.createBufferSource(); s.buffer=nb;
    var f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=6000;
    var g=ctx.createGain(); g.gain.setValueAtTime(vol,time); g.gain.exponentialRampToValueAtTime(.001,time+dur);
    s.connect(f); f.connect(g); g.connect(dest); s.start(time); s.stop(time+dur);
  }

  function generateSongBlob(type, lang) {
    return new Promise(function(resolve, reject) {
      var song = SONGS[type] && SONGS[type][lang];
      if (!song) return reject('Song not found');
      var bpm=song.bpm, beatSec=60/bpm, totalBeats=0;
      song.melody.forEach(function(n){ totalBeats+=n[1]; });
      var duration=totalBeats*beatSec+2.5, sr=44100;
      var ctx=new OfflineAudioContext(2,Math.ceil(sr*duration),sr);
      renderSongToContext(ctx,song,duration);
      ctx.startRendering().then(function(buf) {
        try { resolve(encodeMP3(buf)); } catch(e) { resolve(encodeWAV(buf)); }
      }).catch(reject);
    });
  }

  // === Download ===
  async function downloadSong(type, lang, btnEl) {
    var song = SONGS[type] && SONGS[type][lang];
    if (!song) return;
    if (btnEl) { if(btnEl.classList.contains('generating')) return; btnEl.classList.add('generating'); btnEl.innerHTML='<span class="dl-icon">&#x23F3;</span> 다운로드중...'; }
    var isKr = lang==='kr';
    var reset = function(){ if(btnEl){ btnEl.classList.remove('generating'); btnEl.innerHTML='<span class="dl-icon">&#x25B6;</span> '+(isKr?'한글판':'English'); } };
    try {
      if (supabase) {
        var fp = SONG_FOLDER+'/'+song.name+'.mp3';
        var { data:pu } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fp);
        if (pu && pu.publicUrl) {
          var resp = await fetch(pu.publicUrl);
          if (resp.ok) { var blob = await resp.blob(); if(blob.size>1000){ dl(blob,song.name+'.mp3'); setStatus(song.name+'.mp3 다운로드 완료!'); reset(); return; } }
        }
      }
      if(btnEl) btnEl.innerHTML='<span class="dl-icon">&#x23F3;</span> 생성중...';
      var mp3 = await generateSongBlob(type, lang);
      if (supabase) {
        supabase.storage.from(BUCKET_NAME).upload(SONG_FOLDER+'/'+song.name+'.mp3', mp3, { contentType:'audio/mpeg', upsert:true })
        .then(function(r){ if(!r.error) console.log('Uploaded: '+song.name); });
      }
      var ext = mp3.type==='audio/mp3' ? '.mp3' : '.wav';
      dl(mp3, song.name+ext);
      setStatus(song.name+ext+' 다운로드 완료!');
      reset();
    } catch(e) { console.error(e); alert('다운로드 오류: '+e.message); reset(); }
  }

  function dl(blob, name) {
    var u=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=u; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(u); },5000);
  }

  function setStatus(msg) { document.getElementById('songStatus').textContent = msg; }

  // === Upload All to Supabase ===
  async function uploadAllSongs() {
    if (!supabase) { alert('Supabase 연결 대기중... 잠시 후 다시 시도해주세요.'); return; }
    var btn = document.getElementById('uploadAllBtn');
    btn.classList.add('uploading'); btn.textContent = '업로드 중...';
    var types=['birthday','wedding','cheer','thanks','love'], langs=['kr','en'];
    var total=types.length*langs.length, done=0;
    for (var ti=0; ti<types.length; ti++) {
      for (var li=0; li<langs.length; li++) {
        var type=types[ti], lang=langs[li], song=SONGS[type][lang];
        setStatus('[' + (done+1) + '/' + total + '] ' + song.name + ' 생성중...');
        try {
          var blob = await generateSongBlob(type, lang);
          setStatus('[' + (done+1) + '/' + total + '] ' + song.name + ' 업로드중...');
          var { error } = await supabase.storage.from(BUCKET_NAME).upload(
            SONG_FOLDER+'/'+song.name+'.mp3', blob, { contentType:'audio/mpeg', upsert:true }
          );
          done++;
          if (error) setStatus('[' + done + '/' + total + '] 실패: ' + song.name);
          else setStatus('[' + done + '/' + total + '] 완료: ' + song.name);
        } catch(e) { done++; setStatus('[' + done + '/' + total + '] 오류: ' + song.name); }
      }
    }
    setStatus('전체 ' + total + '곡 업로드 완료!');
    btn.classList.remove('uploading'); btn.textContent = 'Supabase 전체 업로드';
  }

  // === Encoders ===
  function encodeMP3(buf) {
    if (typeof lamejs==='undefined') throw new Error('lamejs not loaded');
    var sr=buf.sampleRate, ch=buf.numberOfChannels, len=buf.length;
    var left=buf.getChannelData(0), right=ch>1?buf.getChannelData(1):left;
    var l16=new Int16Array(len), r16=new Int16Array(len);
    for(var i=0;i<len;i++){ l16[i]=Math.max(-32768,Math.min(32767,Math.round(left[i]*32767))); r16[i]=Math.max(-32768,Math.min(32767,Math.round(right[i]*32767))); }
    var enc=new lamejs.Mp3Encoder(2,sr,192), mp3=[], bs=1152;
    for(var i=0;i<len;i+=bs){ var lc=l16.subarray(i,Math.min(i+bs,len)), rc=r16.subarray(i,Math.min(i+bs,len)); var b=enc.encodeBuffer(lc,rc); if(b.length>0) mp3.push(b); }
    var end=enc.flush(); if(end.length>0) mp3.push(end);
    return new Blob(mp3,{type:'audio/mp3'});
  }
  function encodeWAV(buf) {
    var nc=buf.numberOfChannels, sr=buf.sampleRate, bits=16, len=buf.length;
    var ab=new ArrayBuffer(44+len*nc*2), v=new DataView(ab);
    function ws(o,s){ for(var i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i)); }
    ws(0,'RIFF'); v.setUint32(4,36+len*nc*2,true); ws(8,'WAVE'); ws(12,'fmt ');
    v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,nc,true);
    v.setUint32(24,sr,true); v.setUint32(28,sr*nc*bits/8,true);
    v.setUint16(32,nc*bits/8,true); v.setUint16(34,bits,true);
    ws(36,'data'); v.setUint32(40,len*nc*2,true);
    var off=44;
    for(var i=0;i<len;i++) for(var c=0;c<nc;c++){ var s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i])); v.setInt16(off,s<0?s*0x8000:s*0x7FFF,true); off+=2; }
    return new Blob([ab],{type:'audio/wav'});
  }
</script>
</body>
</html>
