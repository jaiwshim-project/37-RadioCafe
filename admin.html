<!DOCTYPE html>
<html lang="ko" style="background:#f5e6d3">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>라디오카페 | 관리자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 페이지 렌더링 전 세션 복원 (깜빡임 방지)
    (function(){
      var urlTab = new URLSearchParams(location.search).get('tab');
      if(sessionStorage.getItem('adminLoggedIn') || urlTab){
        sessionStorage.setItem('adminLoggedIn', '1');
        document.write('<style>#loginSection{display:none!important}.admin-panel{display:block!important}</style>');
      }
    })();
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d5b7 50%, #f0dcc4 100%);
      display: flex; align-items: flex-start; justify-content: center;
      padding: 20px;
      font-family: 'Inter', sans-serif;
    }

    body::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(200,169,110,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(200,169,110,0.04) 0%, transparent 50%);
      pointer-events: none;
    }

    .admin-card {
      width: 100%; max-width: 900px;
      background: linear-gradient(145deg, #e8d5b0, #d4c09a);
      border-radius: 28px; padding: 3px;
      box-shadow:
        0 40px 80px rgba(100,70,30,0.15),
        0 0 40px rgba(200,169,110,0.15),
        inset 0 1px 0 rgba(255,255,255,0.3);
      position: relative; z-index: 1;
    }

    .admin-inner {
      background: linear-gradient(145deg, #FFF8E7, #F5ECD8);
      border-radius: 25px; padding: 40px 30px;
      position: relative;
    }

    /* 나사 장식 */
    .screw {
      position: absolute; width: 10px; height: 10px;
      background: linear-gradient(145deg, #d4c09a, #b89858);
      border-radius: 50%;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }
    .screw::after {
      content: ''; position: absolute;
      top: 50%; left: 50%; width: 60%; height: 1px;
      background: #8B6914; transform: translate(-50%, -50%) rotate(45deg);
    }
    .screw-tl { top: 12px; left: 12px; }
    .screw-tr { top: 12px; right: 12px; }
    .screw-bl { bottom: 12px; left: 12px; }
    .screw-br { bottom: 12px; right: 12px; }

    /* 스피커 */
    .speaker {
      background: linear-gradient(145deg, #e8d5b0, #d4c09a);
      border-radius: 8px; padding: 8px;
      margin-bottom: 24px;
      border: 1px solid rgba(139,105,20,0.15);
    }
    .speaker-label {
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 10px; letter-spacing: 4px;
      color: #8B6914;
    }

    /* 헤더 */
    .admin-header {
      text-align: center; margin-bottom: 30px;
    }

    .admin-icon {
      width: 80px; height: 80px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      border-radius: 50%; display: flex;
      align-items: center; justify-content: center;
      font-size: 36px;
      box-shadow: 0 10px 30px rgba(200,169,110,0.3);
    }

    .admin-title {
      font-family: 'Outfit', sans-serif; font-size: 24px;
      font-weight: 800; color: #8B6914;
      letter-spacing: 2px; margin-bottom: 8px;
    }

    .admin-subtitle {
      font-size: 13px; color: #6a5530;
    }

    /* 로그인 폼 */
    .login-form { margin-bottom: 24px; }

    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block; font-size: 12px;
      color: #6a5530;
      margin-bottom: 8px; letter-spacing: 1px;
    }

    .form-input {
      width: 100%; padding: 14px 16px;
      background: rgba(255,255,255,0.7);
      border: 2px solid rgba(139,105,20,0.2);
      border-radius: 12px; color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none; border-color: #C8A96E;
      background: rgba(255,255,255,0.85);
    }

    .form-input::placeholder { color: rgba(100,70,30,0.4); }

    .form-textarea {
      width: 100%; padding: 14px 16px;
      background: rgba(255,255,255,0.7);
      border: 2px solid rgba(139,105,20,0.2);
      border-radius: 12px; color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 14px;
      transition: all 0.2s; resize: vertical; min-height: 80px;
    }

    .form-textarea:focus {
      outline: none; border-color: #C8A96E;
      background: rgba(255,255,255,0.85);
    }

    .login-btn {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      border: none; border-radius: 12px;
      color: #fff;
      font-family: 'Outfit', sans-serif;
      font-size: 14px; font-weight: 700;
      letter-spacing: 1px; cursor: pointer;
      transition: all 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(200,169,110,0.4);
    }

    /* 탭 네비게이션 */
    .tab-nav {
      display: flex; gap: 4px;
      margin-bottom: 24px;
      background: rgba(139,105,20,0.06);
      border-radius: 12px; padding: 4px;
      border: 1px solid rgba(139,105,20,0.15);
    }

    .tab-btn {
      flex: 1; padding: 12px 8px;
      background: transparent; border: none;
      color: rgba(139,105,20,0.5);
      font-family: 'Outfit', sans-serif;
      font-size: 13px; font-weight: 600;
      border-radius: 8px; cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab-btn:hover { color: rgba(139,105,20,0.8); }

    .tab-btn.active {
      background: linear-gradient(135deg, #C8A96E, #b89858);
      color: #fff;
    }

    /* 관리 패널 */
    .admin-panel { display: none; }
    .admin-panel.active { display: block; }

    /* 탭 콘텐츠 */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* 섹션 타이틀 */
    .section-title {
      font-family: 'Outfit', sans-serif;
      font-size: 14px; color: #C8A96E;
      letter-spacing: 1px; margin-bottom: 12px;
      font-weight: 600;
      display: flex; align-items: center; gap: 8px;
    }

    .section-title::before {
      content: ''; width: 4px; height: 16px;
      background: #C8A96E; border-radius: 2px;
    }

    /* 통계 그리드 (4열) */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 24px;
    }

    .stat-box {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 12px; padding: 16px;
      text-align: center;
    }

    .stat-number {
      font-family: 'Orbitron', monospace;
      font-size: 28px; color: #C8A96E;
      text-shadow: 0 0 10px rgba(200,169,110,0.4);
    }

    .stat-label {
      font-size: 11px;
      color: #A08050;
      margin-top: 4px;
    }

    /* 시스템 상태 */
    .status-panel {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 12px; padding: 16px;
      margin-bottom: 24px;
    }

    .status-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0;
    }

    .status-row + .status-row {
      border-top: 1px solid rgba(139,105,20,0.1);
    }

    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.online {
      background: #55aa55;
      box-shadow: 0 0 6px rgba(85,170,85,0.5);
    }

    .status-dot.offline {
      background: #dd6666;
      box-shadow: 0 0 6px rgba(220,100,100,0.5);
    }

    .status-dot.checking {
      background: #ddaa33;
      box-shadow: 0 0 6px rgba(220,170,50,0.5);
      animation: pulse 1s infinite;
    }

    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    .status-text {
      font-size: 13px; color: #3a2a10;
    }

    .status-value {
      margin-left: auto; font-size: 12px;
      color: #A08050;
      font-family: 'Orbitron', monospace;
    }

    /* 바 차트 */
    .chart-container {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 12px; padding: 20px;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 12px; color: #A08050;
      margin-bottom: 16px; letter-spacing: 1px;
    }

    .bar-chart {
      display: flex; align-items: flex-end; gap: 8px;
      height: 120px; padding-bottom: 24px;
      border-bottom: 1px solid rgba(139,105,20,0.15);
      position: relative;
    }

    .bar-col {
      flex: 1; min-width: 20px; position: relative;
      background: linear-gradient(to top, #C8A96E, rgba(200,169,110,0.4));
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
    }

    .bar-value {
      position: absolute; top: -18px; left: 50%;
      transform: translateX(-50%);
      font-size: 10px; color: #8B6914;
      font-family: 'Orbitron', monospace;
    }

    .bar-label {
      position: absolute; bottom: -20px; left: 50%;
      transform: translateX(-50%);
      font-size: 9px; color: #A08050;
      white-space: nowrap; max-width: 60px;
      overflow: hidden; text-overflow: ellipsis;
      text-align: center;
    }

    .chart-empty {
      text-align: center; padding: 40px;
      color: #A08050; font-size: 13px;
    }

    /* 검색바 */
    .search-bar {
      display: flex; gap: 8px; margin-bottom: 16px;
    }

    .search-input {
      flex: 1; padding: 12px 16px;
      background: rgba(255,255,255,0.7);
      border: 2px solid rgba(139,105,20,0.2);
      border-radius: 10px; color: #3a2a10;
      font-family: 'Inter', sans-serif; font-size: 13px;
    }

    .search-input:focus {
      outline: none; border-color: #C8A96E;
    }

    .search-input::placeholder { color: rgba(100,70,30,0.4); }

    /* 사용자 목록 */
    .user-list {
      max-height: 500px; overflow-y: auto;
      margin-bottom: 24px;
    }

    .user-list::-webkit-scrollbar { width: 6px; }
    .user-list::-webkit-scrollbar-track { background: rgba(139,105,20,0.05); border-radius: 3px; }
    .user-list::-webkit-scrollbar-thumb { background: rgba(200,169,110,0.3); border-radius: 3px; }

    .user-item {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 10px; margin-bottom: 8px;
      overflow: hidden;
    }

    .user-row {
      display: flex; justify-content: space-between;
      align-items: center; padding: 14px 16px;
      cursor: pointer; transition: background 0.2s;
    }

    .user-row:hover { background: rgba(200,169,110,0.08); }

    .user-info { display: flex; align-items: center; gap: 10px; }

    .user-serial {
      font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
      color: #C8A96E; min-width: 36px; text-align: center;
      letter-spacing: 1px;
    }

    .user-avatar {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, rgba(200,169,110,0.2), rgba(200,169,110,0.1));
      border-radius: 50%; display: flex;
      align-items: center; justify-content: center;
      font-size: 14px; color: #C8A96E;
    }

    .user-name {
      font-size: 14px; color: #3a2a10;
    }

    .user-meta {
      font-size: 11px; color: #A08050;
      margin-top: 2px;
    }

    .user-dash-btn {
      flex-shrink: 0; margin: 0 4px;
    }
    .user-actions {
      display: flex; gap: 6px; align-items: center;
    }

    .expand-arrow {
      font-size: 12px; color: rgba(139,105,20,0.4);
      transition: transform 0.3s;
    }

    .user-item.expanded .expand-arrow { transform: rotate(180deg); }

    /* 사용자 상세 (확장) */
    .user-detail {
      display: none; padding: 0 16px 16px;
      border-top: 1px solid rgba(139,105,20,0.1);
    }

    .user-item.expanded .user-detail { display: block; }

    .album-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px; margin-top: 12px;
    }

    .album-card {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.1);
      border-radius: 8px; padding: 10px;
      text-align: center; cursor: pointer;
      transition: all 0.2s;
    }

    .album-card:hover {
      border-color: rgba(200,169,110,0.3);
      transform: translateY(-2px);
    }

    .album-thumb {
      width: 100%; aspect-ratio: 1;
      background: rgba(139,105,20,0.06);
      border-radius: 6px; margin-bottom: 6px;
      overflow: hidden;
    }

    .album-thumb img {
      width: 100%; height: 100%; object-fit: cover;
    }

    .album-name {
      font-size: 11px; color: #3a2a10;
      white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis;
    }

    .album-count {
      font-size: 10px; color: #A08050;
    }

    /* 버튼 */
    .btn {
      padding: 8px 16px; border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      border: none;
    }

    .btn-gold {
      background: linear-gradient(135deg, #C8A96E, #b89858);
      color: #fff;
    }

    .btn-gold:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(200,169,110,0.4);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(139,105,20,0.3);
      color: #8B6914;
    }

    .btn-outline:hover {
      border-color: #C8A96E; color: #C8A96E;
    }

    .btn-danger {
      background: rgba(220,80,80,0.1);
      border: 1px solid rgba(220,80,80,0.3);
      color: #dc5050;
    }

    .btn-danger:hover {
      background: rgba(220,80,80,0.15);
    }

    .btn-sm { padding: 6px 12px; font-size: 11px; }

    /* 방송국 목록 */
    .station-list {
      max-height: 500px; overflow-y: auto;
      margin-bottom: 16px;
    }

    .station-list::-webkit-scrollbar { width: 6px; }
    .station-list::-webkit-scrollbar-track { background: rgba(139,105,20,0.05); border-radius: 3px; }
    .station-list::-webkit-scrollbar-thumb { background: rgba(200,169,110,0.3); border-radius: 3px; }

    .station-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px;
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 10px; margin-bottom: 8px;
      transition: all 0.2s;
    }

    .station-item:hover { border-color: rgba(200,169,110,0.3); }

    .station-logo {
      width: 40px; height: 40px; flex-shrink: 0;
      background: rgba(200,169,110,0.12);
      border-radius: 8px; display: flex;
      align-items: center; justify-content: center;
      font-family: 'Orbitron', monospace;
      font-size: 11px; color: #C8A96E;
      font-weight: 700;
    }

    .station-info { flex: 1; min-width: 0; }

    .station-name {
      font-size: 13px; color: #3a2a10;
      white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis;
    }

    .station-freq {
      font-size: 11px; color: #A08050;
      font-family: 'Orbitron', monospace;
    }

    .station-actions {
      display: flex; gap: 4px; flex-shrink: 0;
    }

    .station-actions .btn-sm { padding: 5px 8px; font-size: 10px; }

    .test-result {
      display: inline-block; font-size: 12px;
      margin-left: 4px;
    }

    .test-ok { color: #55aa55; }
    .test-fail { color: #dd6666; }
    .test-loading { color: #ddaa33; animation: pulse 1s infinite; }

    /* 방송국 순서 버튼 */
    .order-btns {
      display: flex; flex-direction: column; gap: 2px;
      margin-left: 4px;
    }

    .order-btn {
      background: rgba(200,169,110,0.1);
      border: 1px solid rgba(200,169,110,0.2);
      color: #A08050;
      width: 24px; height: 18px;
      border-radius: 4px; cursor: pointer;
      font-size: 10px; display: flex;
      align-items: center; justify-content: center;
      transition: all 0.2s;
    }

    .order-btn:hover {
      background: rgba(200,169,110,0.2);
      color: #C8A96E;
    }

    /* 모달 */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.hidden { display: none; }

    .modal-content {
      background: linear-gradient(145deg, #FFF8E7, #F5ECD8);
      border: 1px solid rgba(200,169,110,0.3);
      border-radius: 16px; padding: 30px;
      max-width: 500px; width: 100%;
      max-height: 90vh; overflow-y: auto;
    }

    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-size: 18px; color: #C8A96E;
      font-weight: 700; margin-bottom: 20px;
    }

    .modal-actions {
      display: flex; gap: 8px; justify-content: flex-end;
      margin-top: 20px;
    }

    /* 사진 라이트박스 */
    .lightbox {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 1100; padding: 20px; cursor: pointer;
    }

    .lightbox.hidden { display: none; }

    .lightbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px; max-width: 800px; width: 100%;
      max-height: 80vh; overflow-y: auto;
    }

    .lightbox-grid img {
      width: 100%; border-radius: 8px;
      cursor: pointer;
    }

    .lightbox-single img {
      max-width: 90vw; max-height: 85vh;
      border-radius: 8px;
    }

    .lightbox-close {
      position: fixed; top: 16px; right: 16px;
      background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
      color: white; width: 40px; height: 40px;
      border-radius: 50%; cursor: pointer;
      font-size: 18px; display: flex;
      align-items: center; justify-content: center;
      z-index: 1101;
    }

    /* 설정 */
    .setting-group {
      background: rgba(139,105,20,0.06);
      border: 1px solid rgba(139,105,20,0.12);
      border-radius: 12px; padding: 20px;
      margin-bottom: 16px;
    }

    .setting-label {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #C8A96E;
      font-weight: 600; margin-bottom: 10px;
    }

    .setting-desc {
      font-size: 11px; color: #A08050;
      margin-bottom: 12px;
    }

    /* 테마 선택 */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .theme-option {
      padding: 12px 8px;
      background: rgba(139,105,20,0.06);
      border: 2px solid rgba(139,105,20,0.1);
      border-radius: 10px; text-align: center;
      cursor: pointer; transition: all 0.2s;
    }

    .theme-option:hover { border-color: rgba(139,105,20,0.3); }

    .theme-option.selected {
      border-color: #C8A96E;
      background: rgba(200,169,110,0.1);
    }

    .theme-dot-preview {
      width: 24px; height: 24px;
      border-radius: 50%; margin: 0 auto 6px;
      border: 2px solid rgba(139,105,20,0.15);
    }

    .theme-name-label {
      font-size: 10px; color: #3a2a10;
    }

    /* 로그아웃 버튼 */
    .logout-btn {
      width: 100%; padding: 12px;
      background: transparent;
      border: 2px solid rgba(139,105,20,0.3);
      border-radius: 12px;
      color: #8B6914;
      font-family: 'Outfit', sans-serif;
      font-size: 13px; cursor: pointer;
      transition: all 0.2s; margin-top: 16px;
    }

    .logout-btn:hover {
      border-color: #C8A96E; color: #C8A96E;
    }

    /* 링크 */
    .link-section {
      display: flex; justify-content: center; gap: 12px;
      flex-wrap: wrap; margin-bottom: 24px; margin-top: 24px;
    }

    .link-btn {
      padding: 12px 28px; border-radius: 24px;
      background: linear-gradient(135deg, #C8A96E, #b89858);
      color: #fff; text-decoration: none;
      font-family: 'Outfit', sans-serif; font-size: 14px;
      font-weight: 700; letter-spacing: 1px;
      transition: all 0.2s;
    }

    .link-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(200,169,110,0.4);
    }

    /* 푸터 */
    .admin-footer {
      padding-top: 20px;
      border-top: 1px solid rgba(139,105,20,0.15);
      text-align: center;
    }

    .copyright {
      font-size: 11px; color: rgba(139,105,20,0.4);
    }

    /* 메시지 */
    .message {
      padding: 12px; border-radius: 8px;
      margin-bottom: 16px; font-size: 13px;
      text-align: center; display: none;
    }

    .message.error {
      display: block;
      background: rgba(220,80,80,0.08);
      border: 1px solid rgba(220,80,80,0.2);
      color: #dc5050;
    }

    .message.success {
      display: block;
      background: rgba(85,170,85,0.08);
      border: 1px solid rgba(85,170,85,0.2);
      color: #55aa55;
    }

    /* 토스트 */
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,248,231,0.95);
      border: 1px solid rgba(200,169,110,0.3);
      color: #3a2a10; padding: 12px 24px;
      border-radius: 10px; font-size: 13px;
      z-index: 2000; animation: toastIn 0.3s ease;
    }

    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    /* 로딩 스피너 */
    .loading {
      text-align: center; padding: 30px;
      color: #A08050; font-size: 13px;
    }

    .spinner {
      width: 24px; height: 24px;
      border: 2px solid rgba(200,169,110,0.2);
      border-top-color: #C8A96E;
      border-radius: 50%; margin: 0 auto 10px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* 반응형 */
    @media (max-width: 600px) {
      body { padding: 0; align-items: flex-start; }
      .admin-card { border-radius: 0; max-width: 100%; }
      .admin-inner { border-radius: 0; padding: 24px 16px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .stat-number { font-size: 22px; }
      .tab-nav { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .tab-btn { padding: 10px 6px; font-size: 11px; }
      .station-item { flex-wrap: wrap; }
      .station-actions { width: 100%; justify-content: flex-end; margin-top: 8px; }
      .theme-grid { grid-template-columns: repeat(2, 1fr); }
      .album-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
      .bar-chart { height: 80px; }
      .user-actions { gap: 4px; }
      .screw { display: none; }
    }
  </style>
</head>
<body>
  <div class="admin-card">
    <div class="admin-inner">
      <div class="screw screw-tl"></div>
      <div class="screw screw-tr"></div>
      <div class="screw screw-bl"></div>
      <div class="screw screw-br"></div>

      <div class="speaker">
        <div class="speaker-label">ADMIN PANEL</div>
      </div>

      <div class="admin-header">
        <div class="admin-icon">&#9881;</div>
        <div class="admin-title">관리자</div>
        <div class="admin-subtitle">라디오카페 관리 페이지</div>
      </div>

      <!-- 로그인 폼 -->
      <div id="loginSection">
        <div id="loginMessage" class="message"></div>
        <div class="login-form">
          <div class="form-group">
            <label class="form-label">관리자 비밀번호</label>
            <input type="text" id="adminPassword" class="form-input" placeholder="비밀번호 입력..." maxlength="20" autocomplete="off" style="-webkit-text-security:disc;">
          </div>
          <button class="login-btn" onclick="adminLogin()">로그인</button>
        </div>
      </div>

      <!-- 관리 패널 -->
      <div id="adminPanel" class="admin-panel">
        <!-- 탭 네비게이션 -->
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">대시보드</button>
          <button class="tab-btn" data-tab="users" onclick="switchTab('users')">사용자/앨범</button>
          <button class="tab-btn" data-tab="stations" onclick="switchTab('stations')">라디오 방송</button>
          <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">설정</button>
        </div>

        <!-- 탭: 대시보드 -->
        <div class="tab-content active" id="tab-dashboard">
          <div class="section-title">통계 요약</div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-number" id="statUsers">-</div>
              <div class="stat-label">등록된 사용자</div>
            </div>
            <div class="stat-box">
              <div class="stat-number" id="statAlbums">-</div>
              <div class="stat-label">총 앨범</div>
            </div>
            <div class="stat-box">
              <div class="stat-number" id="statPhotos">-</div>
              <div class="stat-label">총 사진</div>
            </div>
            <div class="stat-box">
              <div class="stat-number" id="statStations">-</div>
              <div class="stat-label">방송국</div>
            </div>
          </div>

          <div class="section-title">시스템 상태</div>
          <div class="status-panel">
            <div class="status-row">
              <div class="status-dot checking" id="statusSupabase"></div>
              <div class="status-text">Supabase 연결</div>
              <div class="status-value" id="statusSupabaseText">확인 중...</div>
            </div>
            <div class="status-row">
              <div class="status-dot checking" id="statusStations"></div>
              <div class="status-text">방송국 데이터</div>
              <div class="status-value" id="statusStationsText">확인 중...</div>
            </div>
          </div>

          <div class="section-title">사용자별 앨범 현황</div>
          <div class="chart-container">
            <div id="albumChart"></div>
          </div>
        </div>

        <!-- 탭: 사용자/앨범 -->
        <div class="tab-content" id="tab-users">
          <div class="section-title">사용자 관리</div>
          <div class="search-bar">
            <input type="text" class="search-input" id="userSearch" placeholder="사용자 검색..." oninput="filterUsers()">
          </div>
          <div class="user-list" id="userList">
            <div class="loading"><div class="spinner"></div>사용자 목록 불러오는 중...</div>
          </div>
        </div>

        <!-- 탭: 라디오 방송 -->
        <div class="tab-content" id="tab-stations">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div class="section-title" style="margin-bottom:0;">방송국 관리</div>
            <button class="btn btn-gold" onclick="openStationModal()">+ 새 방송 추가</button>
          </div>
          <div class="station-list" id="stationList">
            <div class="loading"><div class="spinner"></div>방송국 목록 불러오는 중...</div>
          </div>
          <div style="text-align:center; margin-top:12px;">
            <button class="btn btn-outline btn-sm" onclick="seedDefaultStations()">기본 방송국 초기화</button>
          </div>
        </div>

        <!-- 탭: 설정 -->
        <div class="tab-content" id="tab-settings">
          <div class="section-title">사이트 설정</div>

          <div class="setting-group">
            <div class="setting-label">환영 메시지</div>
            <div class="setting-desc">로그인 화면에 표시되는 메시지</div>
            <textarea class="form-textarea" id="welcomeMessage" placeholder="환영 메시지를 입력하세요..."></textarea>
            <div style="margin-top:10px;">
              <button class="btn btn-gold btn-sm" onclick="saveWelcomeMessage()">저장</button>
            </div>
          </div>

          <div class="setting-group">
            <div class="setting-label">기본 테마</div>
            <div class="setting-desc">새 사용자의 기본 라디오 테마</div>
            <div class="theme-grid" id="themeGrid"></div>
            <div style="margin-top:10px;">
              <button class="btn btn-gold btn-sm" onclick="saveDefaultTheme()">저장</button>
            </div>
          </div>

          <div class="setting-group">
            <div class="setting-label">관리자 비밀번호 변경</div>
            <div class="form-group" style="margin-top:12px;">
              <label class="form-label">현재 비밀번호</label>
              <input type="password" class="form-input" id="currentPw" maxlength="20">
            </div>
            <div class="form-group">
              <label class="form-label">새 비밀번호</label>
              <input type="password" class="form-input" id="newPw" maxlength="20">
            </div>
            <div class="form-group">
              <label class="form-label">새 비밀번호 확인</label>
              <input type="password" class="form-input" id="confirmPw" maxlength="20">
            </div>
            <button class="btn btn-gold btn-sm" onclick="changeAdminPassword()">비밀번호 변경</button>
          </div>
        </div>

        <button class="logout-btn" onclick="adminLogout()">로그아웃</button>
      </div>

      <div class="link-section">
        <a href="#" class="link-btn" onclick="event.preventDefault();history.back()">&larr; 이전</a>
      </div>

      <div class="admin-footer">
        <div class="copyright">&copy; 2026 Hyein Cho. All rights reserved.</div>
      </div>
    </div>
  </div>

  <!-- 방송국 추가/수정 모달 -->
  <div class="modal-overlay hidden" id="stationModal">
    <div class="modal-content">
      <div class="modal-title" id="stationModalTitle">새 방송 추가</div>
      <input type="hidden" id="editStationId">
      <div class="form-group">
        <label class="form-label">방송국 이름</label>
        <input type="text" class="form-input" id="stationFormName" placeholder="예: KBS 클래식FM">
      </div>
      <div class="form-group">
        <label class="form-label">스트림 URL</label>
        <input type="text" class="form-input" id="stationFormUrl" placeholder="https://...m3u8">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">주파수 (표시용)</label>
          <input type="text" class="form-input" id="stationFormFreq" placeholder="93.1 MHz">
        </div>
        <div class="form-group">
          <label class="form-label">주파수 (숫자)</label>
          <input type="number" class="form-input" id="stationFormFreqNum" placeholder="93.1" step="0.1">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">로고 텍스트</label>
          <input type="text" class="form-input" id="stationFormLogo" placeholder="1FM" maxlength="4">
        </div>
        <div class="form-group">
          <label class="form-label">제공사</label>
          <input type="text" class="form-input" id="stationFormProvider" placeholder="KBS">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeStationModal()">취소</button>
        <button class="btn btn-gold" onclick="saveStation()">저장</button>
      </div>
    </div>
  </div>

  <!-- 앨범 사진 라이트박스 -->
  <div class="lightbox hidden" id="photoLightbox" onclick="closeLightbox(event)">
    <button class="lightbox-close" onclick="closeLightbox(event)">&times;</button>
    <div id="lightboxContent"></div>
  </div>

  <div id="toastContainer"></div>

  <script>
    // === Supabase 설정 (index.html과 동일) ===
    var SUPABASE_URL = 'https://haxcktfnuudlqciyljtp.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhheGNrdGZudXVkbHFjaXlsanRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDUwNDAsImV4cCI6MjA4NDg4MTA0MH0.suN7BeaHx3MjaNlMDQa0940P-rMl2XPyk4ksoQEU3YM';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      global: { fetch: function(url, opts) { opts = opts || {}; opts.cache = 'no-store'; return fetch(url, opts); } }
    });
    var BUCKET = 'photo-albums';

    var ADMIN_PASSWORD = '9633';
    var allUsers = {};
    var allStations = [];
    var appSettings = {};
    var selectedTheme = 'wood';

    var THEMES = [
      { id: 'wood', name: '우드 클래식', color: '#8B6914' },
      { id: 'cream', name: '레트로 크림', color: '#d4c5a9' },
      { id: 'black', name: '미드나잇 블랙', color: '#333333' },
      { id: 'military', name: '밀리터리', color: '#4a5e3a' },
      { id: 'silver', name: '크롬 실버', color: '#a0a0b0' },
      { id: 'cyber', name: '네온 사이버', color: '#00e5ff' },
      { id: 'rose', name: '로즈 골드', color: '#e8a0b0' },
      { id: 'maltese', name: '말티즈', color: '#f0ebe5' }
    ];

    var DEFAULT_STATIONS = [
      {id:'kbs-1fm',name:'KBS 클래식FM',url:'',apiUrl:'https://cfpwwwapi.kbs.co.kr/api/v1/landing/live/channel_code/24',freq:'93.1 MHz',freqNum:93.1,logoText:'1FM',provider:'KBS'},
      {id:'ebs-fm',name:'EBS FM',url:'https://ebsonair.ebs.co.kr/fmradiofamilypc/familypc1m/playlist.m3u8',freq:'104.5 MHz',freqNum:104.5,logoText:'EBS',provider:'EBS'},
      {id:'gwangju-mbc-fm',name:'광주MBC FM',url:'https://media.kjmbc.co.kr/hls/fmlive/GWANGJU-MBC-FM/playlist.m3u8',freq:'93.9 MHz',freqNum:93.9,logoText:'MBC',provider:'MBC'},
      {id:'ytn-radio',name:'YTN 라디오',url:'https://radiolive.ytn.co.kr/radio/_definst_/20211118_fmlive/playlist.m3u8',freq:'94.5 MHz',freqNum:94.5,logoText:'YTN',provider:'YTN'},
      {id:'tbs-fm',name:'TBS FM',url:'https://cdnfm.tbs.seoul.kr/tbs/_definst_/tbs_fm_web_360.smil/playlist.m3u8',freq:'95.1 MHz',freqNum:95.1,logoText:'TBS',provider:'TBS'},
      {id:'febc',name:'극동방송',url:'http://mlive2.febc.net:1935/live/seoulfm/playlist.m3u8',freq:'106.9 MHz',freqNum:106.9,logoText:'극동',provider:'FEBC'},
      {id:'tbn',name:'TBN 교통방송',url:'http://radio2.tbn.or.kr:1935/gyeongin/myStream/playlist.m3u8',freq:'95.1 MHz',freqNum:95.1,logoText:'TBN',provider:'TBN'},
      {id:'obs',name:'OBS 라디오',url:'https://vod3.obs.co.kr:444/live/obsstream1/radio.stream/playlist.m3u8',freq:'99.9 MHz',freqNum:99.9,logoText:'OBS',provider:'OBS'},
      {id:'tarot',name:'타로 점보기',url:'',freq:'타로',freqNum:0,logoText:'타로 점보기',provider:'CLARA',isTarot:true},
      {id:'fortune',name:'오늘의 운세',url:'',freq:'운세',freqNum:0,logoText:'오늘의 운세',provider:'CLARA',isFortune:true},
      {id:'wqxr',name:'WQXR',url:'https://stream.wqxr.org/wqxr',freq:'미국',freqNum:0,logoText:'WQXR',provider:'WQXR',flag:'us'},
      {id:'ottava',name:'OTTAVA',url:'https://sslv.smartstream.ne.jp/ottava/_definst_/live01/chunklist.m3u8',freq:'일본',freqNum:0,logoText:'OTTAVA',provider:'OTTAVA',flag:'jp'},
      {id:'france-musique',name:'France Musique',url:'https://stream.radiofrance.fr/francemusique/francemusique.m3u8',freq:'프랑스',freqNum:0,logoText:'France M',provider:'Radio France',flag:'fr'},
      {id:'br-klassik',name:'BR Klassik',url:'https://dispatcher.rndfnk.com/br/brklassik/live/mp3/high',freq:'독일',freqNum:0,logoText:'BR Klassik',provider:'BR',flag:'de'},
      {id:'classic-fm',name:'Classic FM',url:'http://media-the.musicradio.com/ClassicFMMP3',freq:'영국',freqNum:0,logoText:'Classic FM',provider:'Global',flag:'gb'}
    ];

    // === 유틸리티 ===
    function toSafePath(str) {
      return str.split('').map(function(c) {
        var code = c.charCodeAt(0);
        if ((code >= 48 && code <= 57) || (code >= 65 && code <= 90) || (code >= 97 && code <= 122) || c === '-' || c === '_') return c;
        return '_' + code.toString(16) + '_';
      }).join('');
    }

    function showToast(msg) {
      var el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(function() { el.remove(); }, 3000);
    }

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // === 로그인/로그아웃 ===
    function adminLogin() {
      var password = document.getElementById('adminPassword').value;
      var messageEl = document.getElementById('loginMessage');

      if (password === ADMIN_PASSWORD) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminPanel').classList.add('active');
        sessionStorage.setItem('adminLoggedIn', '1');
        var urlTab = new URLSearchParams(location.search).get('tab');
        var savedTab = sessionStorage.getItem('adminCurrentTab');
        var targetTab = urlTab || savedTab || 'dashboard';
        switchTab(targetTab);
      } else {
        messageEl.className = 'message error';
        messageEl.textContent = '비밀번호가 올바르지 않습니다.';
      }
    }

    function adminLogout() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminPanel').classList.remove('active');
      document.getElementById('adminPassword').value = '';
      document.getElementById('loginMessage').className = 'message';
      sessionStorage.removeItem('adminLoggedIn');
      sessionStorage.removeItem('adminCurrentTab');
    }

    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') adminLogin();
    });

    // === 탭 전환 ===
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(tab) {
        tab.classList.remove('active');
      });
      var target = document.getElementById('tab-' + tabName);
      if (target) target.classList.add('active');

      sessionStorage.setItem('adminCurrentTab', tabName);

      if (tabName === 'dashboard') loadDashboard();
      if (tabName === 'users') loadUsersTab();
      if (tabName === 'stations') loadStationsTab();
      if (tabName === 'settings') loadSettingsTab();
    }

    // === Supabase 데이터 함수 ===
    async function loadUsersFromCloud() {
      try {
        var r = await supabase.storage.from(BUCKET).download('_system/users.json');
        if (r.data) {
          var text = await r.data.text();
          return JSON.parse(text);
        }
      } catch(e) { console.log('사용자 로드 실패:', e); }
      return {};
    }

    async function saveUsersToCloud(users) {
      try {
        var blob = new Blob([JSON.stringify(users)], {type: 'application/json'});
        await supabase.storage.from(BUCKET).upload('_system/users.json', blob, { upsert: true });
      } catch(e) { console.log('사용자 저장 실패:', e); }
    }

    async function loadStationsFromCloud() {
      try {
        var r = await supabase.storage.from(BUCKET).download('_system/stations.json');
        if (r.data) {
          var text = await r.data.text();
          var parsed = JSON.parse(text);
          if (parsed && parsed.length > 0) return parsed;
        }
      } catch(e) { console.log('방송국 로드 실패:', e); }
      return null;
    }

    async function saveStationsToCloud(stations) {
      var blob = new Blob([JSON.stringify(stations)], {type: 'application/json'});
      await supabase.storage.from(BUCKET).upload('_system/stations.json', blob, { upsert: true });
    }

    async function loadSettingsFromCloud() {
      try {
        var r = await supabase.storage.from(BUCKET).download('_system/settings.json');
        if (r.data) {
          var text = await r.data.text();
          return JSON.parse(text);
        }
      } catch(e) {}
      return { welcomeMessage: '', defaultTheme: 'wood', adminPassword: '9633' };
    }

    async function saveSettingsToCloud(settings) {
      var blob = new Blob([JSON.stringify(settings)], {type: 'application/json'});
      await supabase.storage.from(BUCKET).upload('_system/settings.json', blob, { upsert: true });
    }

    // ========================================
    //  대시보드 탭
    // ========================================
    async function loadDashboard() {

      // 사용자 로드
      allUsers = await loadUsersFromCloud();
      var userNames = Object.keys(allUsers);
      document.getElementById('statUsers').textContent = userNames.length;

      // Supabase 상태
      document.getElementById('statusSupabase').className = 'status-dot online';
      document.getElementById('statusSupabaseText').textContent = '연결됨';

      // 방송국 로드
      var cloudStations = await loadStationsFromCloud();
      allStations = cloudStations || DEFAULT_STATIONS;
      document.getElementById('statStations').textContent = allStations.length;

      if (cloudStations) {
        document.getElementById('statusStations').className = 'status-dot online';
        document.getElementById('statusStationsText').textContent = '클라우드';
      } else {
        document.getElementById('statusStations').className = 'status-dot offline';
        document.getElementById('statusStationsText').textContent = '기본값 사용';
      }

      // 앨범/사진 수 집계
      var totalAlbums = 0;
      var totalPhotos = 0;
      var userAlbumData = [];

      for (var i = 0; i < userNames.length; i++) {
        var name = userNames[i];
        var safeName = toSafePath(name);
        var albumCount = 0;
        var photoCount = 0;

        try {
          var res = await supabase.storage.from(BUCKET).list(safeName);
          if (res.data) {
            for (var j = 0; j < res.data.length; j++) {
              var item = res.data[j];
              if (!item.id) {
                albumCount++;
                try {
                  var filesRes = await supabase.storage.from(BUCKET).list(safeName + '/' + item.name);
                  if (filesRes.data) photoCount += filesRes.data.filter(function(f) { return f.id; }).length;
                } catch(e) {}
              }
            }
          }
        } catch(e) {}

        totalAlbums += albumCount;
        totalPhotos += photoCount;
        userAlbumData.push({ name: name, albums: albumCount });
      }

      document.getElementById('statAlbums').textContent = totalAlbums;
      document.getElementById('statPhotos').textContent = totalPhotos;

      // 바 차트 렌더링
      renderAlbumChart(userAlbumData);

      // 설정 로드
      appSettings = await loadSettingsFromCloud();
      if (appSettings.adminPassword) ADMIN_PASSWORD = appSettings.adminPassword;

      // dashboard loaded
    }

    function renderAlbumChart(data) {
      var container = document.getElementById('albumChart');
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="chart-empty">사용자 데이터가 없습니다</div>';
        return;
      }

      var maxAlbums = Math.max.apply(null, data.map(function(d) { return d.albums; }));
      if (maxAlbums === 0) maxAlbums = 1;

      var html = '<div class="chart-title">사용자별 앨범 수</div><div class="bar-chart">';
      for (var i = 0; i < data.length; i++) {
        var pct = (data[i].albums / maxAlbums) * 100;
        html += '<div class="bar-col" style="height:' + Math.max(pct, 4) + '%">'
          + '<div class="bar-value">' + data[i].albums + '</div>'
          + '<div class="bar-label">' + escapeHtml(data[i].name) + '</div>'
          + '</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }

    // ========================================
    //  사용자/앨범 탭
    // ========================================
    var usersTabLoaded = false;

    async function loadUsersTab() {
      if (!allUsers || Object.keys(allUsers).length === 0) {
        allUsers = await loadUsersFromCloud();
      }
      renderUserList(Object.keys(allUsers));
      usersTabLoaded = true;
    }

    function filterUsers() {
      var query = document.getElementById('userSearch').value.trim().toLowerCase();
      var allKeys = Object.keys(allUsers);
      var filtered = allKeys.filter(function(name) {
        var serial = getUserSerial(name);
        return name.toLowerCase().indexOf(query) !== -1 || serial.indexOf(query) !== -1;
      });
      renderUserList(filtered);
    }

    function getUserEmail(userData) {
      if (userData && typeof userData === 'object' && userData.email) return userData.email;
      return '';
    }

    function getUserSerial(name) {
      var allKeys = Object.keys(allUsers);
      var idx = allKeys.indexOf(name);
      if (idx < 0) return '----';
      var num = idx + 1;
      return ('0000' + num).slice(-4);
    }

    function renderUserList(userNames) {
      var container = document.getElementById('userList');
      if (userNames.length === 0) {
        container.innerHTML = '<div class="chart-empty">사용자가 없습니다</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < userNames.length; i++) {
        var name = userNames[i];
        var serial = getUserSerial(name);
        var email = getUserEmail(allUsers[name]);
        var emailHtml = email ? '<div style="font-size:11px;color:#A08050;margin-top:1px;">' + escapeHtml(email) + '</div>' : '';
        html += '<div class="user-item" id="user-' + i + '">'
          + '<div class="user-row" onclick="toggleUserDetail(' + i + ',\'' + escapeHtml(name).replace(/'/g, "\\'") + '\')">'
          + '<div class="user-info">'
          + '<span class="user-serial">' + serial + '</span>'
          + '<div class="user-avatar">' + escapeHtml(name.charAt(0)) + '</div>'
          + '<div><div class="user-name">' + escapeHtml(name) + '</div>'
          + emailHtml
          + '<div class="user-meta" id="userMeta-' + i + '">불러오는 중...</div></div>'
          + '</div>'
          + '<button class="btn btn-gold btn-sm user-dash-btn" onclick="event.stopPropagation();viewUserDashboard(\'' + escapeHtml(name).replace(/'/g, "\\'") + '\')">대시보드</button>'
          + '<div class="user-actions">'
          + '<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteUser(\'' + escapeHtml(name).replace(/'/g, "\\'") + '\')">삭제</button>'
          + '<span class="expand-arrow">&#9660;</span>'
          + '</div></div>'
          + '<div class="user-detail" id="userDetail-' + i + '">'
          + '<div class="loading"><div class="spinner"></div></div>'
          + '</div></div>';
      }
      container.innerHTML = html;

      // 앨범 수 비동기 로드
      for (var j = 0; j < userNames.length; j++) {
        loadUserMeta(j, userNames[j]);
      }
    }

    async function loadUserMeta(index, userName) {
      var safeName = toSafePath(userName);
      var albumCount = 0;
      try {
        var res = await supabase.storage.from(BUCKET).list(safeName);
        if (res.data) albumCount = res.data.filter(function(item) { return !item.id; }).length;
      } catch(e) {}
      var metaEl = document.getElementById('userMeta-' + index);
      if (metaEl) metaEl.textContent = '앨범 ' + albumCount + '개';
    }

    async function toggleUserDetail(index, userName) {
      var item = document.getElementById('user-' + index);
      if (!item) return;

      if (item.classList.contains('expanded')) {
        item.classList.remove('expanded');
        return;
      }

      item.classList.add('expanded');
      var detail = document.getElementById('userDetail-' + index);

      var safeName = toSafePath(userName);
      try {
        var res = await supabase.storage.from(BUCKET).list(safeName);
        if (!res.data || res.data.length === 0) {
          detail.innerHTML = '<div style="padding:12px;color:#A08050;font-size:12px;">앨범이 없습니다</div>';
          return;
        }

        var albums = res.data.filter(function(item) { return !item.id; });
        if (albums.length === 0) {
          detail.innerHTML = '<div style="padding:12px;color:#A08050;font-size:12px;">앨범이 없습니다</div>';
          return;
        }

        var html = '<div class="album-grid">';
        for (var i = 0; i < albums.length; i++) {
          var albumName = albums[i].name;
          var albumPath = safeName + '/' + albumName;
          html += '<div class="album-card" onclick="viewAlbumPhotos(\'' + albumPath + '\')">'
            + '<div class="album-thumb" id="thumb-' + index + '-' + i + '"></div>'
            + '<div class="album-name">' + escapeHtml(albumName) + '</div>'
            + '</div>';
        }
        html += '</div>';
        detail.innerHTML = html;

        // 썸네일 로드
        for (var j = 0; j < albums.length; j++) {
          loadAlbumThumb(index, j, safeName + '/' + albums[j].name);
        }
      } catch(e) {
        detail.innerHTML = '<div style="padding:12px;color:#dc5050;font-size:12px;">로드 실패</div>';
      }
    }

    async function loadAlbumThumb(userIdx, albumIdx, albumPath) {
      try {
        var res = await supabase.storage.from(BUCKET).list(albumPath);
        if (res.data && res.data.length > 0) {
          var firstFile = res.data.find(function(f) { return f.id; });
          if (firstFile) {
            var pubUrl = supabase.storage.from(BUCKET).getPublicUrl(albumPath + '/' + firstFile.name);
            var thumbEl = document.getElementById('thumb-' + userIdx + '-' + albumIdx);
            if (thumbEl) thumbEl.innerHTML = '<img src="' + pubUrl.data.publicUrl + '" alt="">';
          }
        }
      } catch(e) {}

      var thumbEl = document.getElementById('thumb-' + userIdx + '-' + albumIdx);
      if (thumbEl && !thumbEl.innerHTML) {
        thumbEl.style.display = 'flex';
        thumbEl.style.alignItems = 'center';
        thumbEl.style.justifyContent = 'center';
        thumbEl.style.color = 'rgba(200,169,110,0.3)';
        thumbEl.style.fontSize = '20px';
        thumbEl.textContent = '📷';
      }
    }

    async function viewAlbumPhotos(albumPath) {
      var lightbox = document.getElementById('photoLightbox');
      var content = document.getElementById('lightboxContent');
      content.innerHTML = '<div class="loading"><div class="spinner"></div>사진 불러오는 중...</div>';
      lightbox.classList.remove('hidden');

      try {
        var res = await supabase.storage.from(BUCKET).list(albumPath);
        if (!res.data || res.data.length === 0) {
          content.innerHTML = '<div style="color:white;text-align:center;">사진이 없습니다</div>';
          return;
        }

        var files = res.data.filter(function(f) { return f.id; });
        var html = '<div class="lightbox-grid">';
        for (var i = 0; i < files.length; i++) {
          var pubUrl = supabase.storage.from(BUCKET).getPublicUrl(albumPath + '/' + files[i].name);
          html += '<img src="' + pubUrl.data.publicUrl + '" alt="" onclick="event.stopPropagation()">';
        }
        html += '</div>';
        content.innerHTML = html;
      } catch(e) {
        content.innerHTML = '<div style="color:#dc5050;text-align:center;">로드 실패</div>';
      }
    }

    function closeLightbox(e) {
      if (e.target.tagName === 'IMG') return;
      document.getElementById('photoLightbox').classList.add('hidden');
    }

    function viewUserDashboard(userName) {
      location.href = 'index.html?mode=digital&dashboard=' + encodeURIComponent(userName);
    }

    async function deleteUser(userName) {
      if (!confirm('"' + userName + '" 사용자를 삭제하시겠습니까?\n관련 앨범과 사진도 함께 삭제됩니다.')) return;

      showToast('삭제 중...');

      // 사용자 파일 삭제
      var safeName = toSafePath(userName);
      try {
        var res = await supabase.storage.from(BUCKET).list(safeName);
        if (res.data) {
          for (var i = 0; i < res.data.length; i++) {
            var item = res.data[i];
            var itemPath = safeName + '/' + item.name;
            if (!item.id) {
              // 폴더 - 하위 파일 삭제
              var filesRes = await supabase.storage.from(BUCKET).list(itemPath);
              if (filesRes.data && filesRes.data.length > 0) {
                var filePaths = filesRes.data.map(function(f) { return itemPath + '/' + f.name; });
                await supabase.storage.from(BUCKET).remove(filePaths);
              }
            } else {
              await supabase.storage.from(BUCKET).remove([itemPath]);
            }
          }
        }
      } catch(e) { console.log('파일 삭제 오류:', e); }

      // 사용자 목록에서 제거
      delete allUsers[userName];
      await saveUsersToCloud(allUsers);

      showToast('"' + userName + '" 삭제 완료');
      // refresh dashboard next time
      loadUsersTab();
    }

    // ========================================
    //  라디오 방송 탭
    // ========================================
    async function loadStationsTab() {
      if (allStations.length === 0) {
        var cloud = await loadStationsFromCloud();
        allStations = cloud || DEFAULT_STATIONS;
      }
      renderStationList();
    }

    function renderStationList() {
      var container = document.getElementById('stationList');
      if (allStations.length === 0) {
        container.innerHTML = '<div class="chart-empty">등록된 방송국이 없습니다</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < allStations.length; i++) {
        var s = allStations[i];
        html += '<div class="station-item" id="station-' + i + '">'
          + '<div class="station-logo">' + escapeHtml(s.logoText) + '</div>'
          + '<div class="station-info">'
          + '<div class="station-name">' + escapeHtml(s.name) + '</div>'
          + '<div class="station-freq">' + escapeHtml(s.freq) + ' · ' + escapeHtml(s.provider) + '</div>'
          + '</div>'
          + '<div class="station-actions">'
          + '<button class="btn btn-outline btn-sm" onclick="testStation(' + i + ')">테스트<span class="test-result" id="testResult-' + i + '"></span></button>'
          + '<button class="btn btn-outline btn-sm" onclick="editStation(' + i + ')">수정</button>'
          + '<button class="btn btn-danger btn-sm" onclick="deleteStation(' + i + ')">삭제</button>'
          + '</div>'
          + '<div class="order-btns">'
          + '<button class="order-btn" onclick="moveStation(' + i + ',-1)">&#9650;</button>'
          + '<button class="order-btn" onclick="moveStation(' + i + ',1)">&#9660;</button>'
          + '</div>'
          + '</div>';
      }
      container.innerHTML = html;
    }

    function openStationModal(editIndex) {
      document.getElementById('stationModal').classList.remove('hidden');
      document.getElementById('stationFormName').value = '';
      document.getElementById('stationFormUrl').value = '';
      document.getElementById('stationFormFreq').value = '';
      document.getElementById('stationFormFreqNum').value = '';
      document.getElementById('stationFormLogo').value = '';
      document.getElementById('stationFormProvider').value = '';
      document.getElementById('editStationId').value = '';
      document.getElementById('stationModalTitle').textContent = '새 방송 추가';

      if (editIndex !== undefined && allStations[editIndex]) {
        var s = allStations[editIndex];
        document.getElementById('stationModalTitle').textContent = '방송 수정';
        document.getElementById('editStationId').value = editIndex;
        document.getElementById('stationFormName').value = s.name;
        document.getElementById('stationFormUrl').value = s.url;
        document.getElementById('stationFormFreq').value = s.freq;
        document.getElementById('stationFormFreqNum').value = s.freqNum;
        document.getElementById('stationFormLogo').value = s.logoText;
        document.getElementById('stationFormProvider').value = s.provider;
      }
    }

    function closeStationModal() {
      document.getElementById('stationModal').classList.add('hidden');
    }

    function editStation(index) {
      openStationModal(index);
    }

    async function saveStation() {
      var name = document.getElementById('stationFormName').value.trim();
      var url = document.getElementById('stationFormUrl').value.trim();
      var freq = document.getElementById('stationFormFreq').value.trim();
      var freqNum = parseFloat(document.getElementById('stationFormFreqNum').value) || 0;
      var logo = document.getElementById('stationFormLogo').value.trim();
      var provider = document.getElementById('stationFormProvider').value.trim();

      if (!name || !url) {
        showToast('이름과 URL은 필수입니다');
        return;
      }

      var editIndex = document.getElementById('editStationId').value;

      var station = {
        id: name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-'),
        name: name,
        url: url,
        freq: freq || (freqNum + ' MHz'),
        freqNum: freqNum,
        logoText: logo || name.substring(0, 3),
        provider: provider || ''
      };

      if (editIndex !== '') {
        allStations[parseInt(editIndex)] = station;
        showToast('방송 수정 완료');
      } else {
        allStations.push(station);
        showToast('새 방송 추가 완료');
      }

      await saveStationsToCloud(allStations);
      closeStationModal();
      renderStationList();
      // refresh dashboard next time
    }

    async function deleteStation(index) {
      if (!confirm('"' + allStations[index].name + '" 방송을 삭제하시겠습니까?')) return;
      allStations.splice(index, 1);
      await saveStationsToCloud(allStations);
      renderStationList();
      showToast('방송 삭제 완료');
      // refresh dashboard next time
    }

    async function moveStation(index, dir) {
      var newIndex = index + dir;
      if (newIndex < 0 || newIndex >= allStations.length) return;
      var temp = allStations[index];
      allStations[index] = allStations[newIndex];
      allStations[newIndex] = temp;
      await saveStationsToCloud(allStations);
      renderStationList();
    }

    function testStation(index) {
      var resultEl = document.getElementById('testResult-' + index);
      resultEl.className = 'test-result test-loading';
      resultEl.textContent = ' ...';

      var url = allStations[index].url;
      var audio = document.createElement('audio');
      var hls = null;
      var timeout = null;

      function cleanup() {
        clearTimeout(timeout);
        if (hls) { hls.destroy(); hls = null; }
        audio.pause();
        audio.src = '';
        audio.remove();
      }

      function onSuccess() {
        cleanup();
        resultEl.className = 'test-result test-ok';
        resultEl.textContent = ' OK';
        setTimeout(function() { resultEl.textContent = ''; resultEl.className = 'test-result'; }, 5000);
      }

      function onFail() {
        cleanup();
        resultEl.className = 'test-result test-fail';
        resultEl.textContent = ' FAIL';
        setTimeout(function() { resultEl.textContent = ''; resultEl.className = 'test-result'; }, 5000);
      }

      timeout = setTimeout(onFail, 10000);

      if (url.includes('.m3u8') && Hls.isSupported()) {
        hls = new Hls({ enableWorker: false });
        hls.loadSource(url);
        hls.attachMedia(audio);
        hls.on(Hls.Events.MANIFEST_PARSED, onSuccess);
        hls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal) onFail();
        });
      } else {
        audio.src = url;
        audio.addEventListener('canplay', onSuccess);
        audio.addEventListener('error', onFail);
        audio.load();
      }
    }

    async function seedDefaultStations() {
      if (!confirm('현재 방송 목록을 기본값으로 초기화하시겠습니까?\n기존 수정 사항이 모두 사라집니다.')) return;
      allStations = JSON.parse(JSON.stringify(DEFAULT_STATIONS));
      await saveStationsToCloud(allStations);
      renderStationList();
      showToast('기본 방송국으로 초기화 완료');
      // refresh dashboard next time
    }

    // ========================================
    //  설정 탭
    // ========================================
    var settingsTabLoaded = false;

    async function loadSettingsTab() {
      if (!settingsTabLoaded) {
        appSettings = await loadSettingsFromCloud();
        if (appSettings.adminPassword) ADMIN_PASSWORD = appSettings.adminPassword;
      }

      document.getElementById('welcomeMessage').value = appSettings.welcomeMessage || '';
      selectedTheme = appSettings.defaultTheme || 'wood';
      renderThemeGrid();
      settingsTabLoaded = true;
    }

    function renderThemeGrid() {
      var container = document.getElementById('themeGrid');
      var html = '';
      for (var i = 0; i < THEMES.length; i++) {
        var t = THEMES[i];
        var sel = t.id === selectedTheme ? ' selected' : '';
        html += '<div class="theme-option' + sel + '" onclick="selectTheme(\'' + t.id + '\')">'
          + '<div class="theme-dot-preview" style="background:' + t.color + '"></div>'
          + '<div class="theme-name-label">' + escapeHtml(t.name) + '</div>'
          + '</div>';
      }
      container.innerHTML = html;
    }

    function selectTheme(themeId) {
      selectedTheme = themeId;
      renderThemeGrid();
    }

    async function saveWelcomeMessage() {
      appSettings.welcomeMessage = document.getElementById('welcomeMessage').value;
      await saveSettingsToCloud(appSettings);
      showToast('환영 메시지 저장 완료');
    }

    async function saveDefaultTheme() {
      appSettings.defaultTheme = selectedTheme;
      await saveSettingsToCloud(appSettings);
      showToast('기본 테마 저장 완료');
    }

    async function changeAdminPassword() {
      var current = document.getElementById('currentPw').value;
      var newPw = document.getElementById('newPw').value;
      var confirm2 = document.getElementById('confirmPw').value;

      if (current !== ADMIN_PASSWORD) {
        showToast('현재 비밀번호가 올바르지 않습니다');
        return;
      }
      if (!newPw || newPw.length < 4) {
        showToast('새 비밀번호는 4자 이상이어야 합니다');
        return;
      }
      if (newPw !== confirm2) {
        showToast('새 비밀번호가 일치하지 않습니다');
        return;
      }

      ADMIN_PASSWORD = newPw;
      appSettings.adminPassword = newPw;
      await saveSettingsToCloud(appSettings);

      document.getElementById('currentPw').value = '';
      document.getElementById('newPw').value = '';
      document.getElementById('confirmPw').value = '';
      showToast('비밀번호 변경 완료');
    }

    // 세션 복원 시 탭 전환
    (function(){
      var urlTab = new URLSearchParams(location.search).get('tab');
      if(sessionStorage.getItem('adminLoggedIn') || urlTab){
        var targetTab = urlTab || sessionStorage.getItem('adminCurrentTab') || 'dashboard';
        switchTab(targetTab);
      }
    })();

    // === 초기화 (Supabase 설정 로드) ===
    (async function() {
      try {
        var settings = await loadSettingsFromCloud();
        if (settings && settings.adminPassword) {
          ADMIN_PASSWORD = settings.adminPassword;
        }
        appSettings = settings;
      } catch(e) { console.log('설정 로드 실패:', e); }
    })();
  </script>
</body>
</html>
